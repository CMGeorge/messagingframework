diff --git a/benchmarks/tst_messageserver/tst_messageserver.pro b/benchmarks/tst_messageserver/tst_messageserver.pro
index db23ea9..febeff0 100644
--- a/benchmarks/tst_messageserver/tst_messageserver.pro
+++ b/benchmarks/tst_messageserver/tst_messageserver.pro
@@ -21,11 +21,13 @@ MESSAGE_SERVER=$$BASE/src/tools/messageserver
 INCLUDEPATH += . 3rdparty $$BASE/src/libraries/qtopiamail \
                  $$BASE/src/libraries/qtopiamail/support \
                  $$BASE/src/libraries/messageserver \
+                 $$BASE/src/libraries/sparql \
                  $$IMAP_PLUGIN \
                  $$MESSAGE_SERVER 
 
 LIBS += -L$$BASE/src/libraries/messageserver -lmessageserver \
-        -L$$BASE/src/libraries/qtopiamail -lqtopiamail
+        -L$$BASE/src/libraries/qtopiamail -lqtopiamail \
+        -L$$BASE/src/libraries/sparql -lsparql
 
 QMAKE_LFLAGS += -Wl,-rpath,$$BASE/src/libraries/qtopiamail \
     -Wl,-rpath,$$BASE/src/libraries/messageserver
@@ -37,7 +39,8 @@ HEADERS += benchmarkcontext.h \
            $$MESSAGE_SERVER/mailmessageclient.h \
            $$MESSAGE_SERVER/messageserver.h \
            $$MESSAGE_SERVER/servicehandler.h \
-           $$MESSAGE_SERVER/newcountnotifier.h
+           $$MESSAGE_SERVER/newcountnotifier.h \
+           $$MESSAGE_SERVER/sparqlindexer.h
 
 SOURCES += benchmarkcontext.cpp \
            qscopedconnection.cpp \
@@ -48,7 +51,8 @@ SOURCES += benchmarkcontext.cpp \
            $$MESSAGE_SERVER/messageserver.cpp \
            $$MESSAGE_SERVER/prepareaccounts.cpp \
            $$MESSAGE_SERVER/servicehandler.cpp \
-           $$MESSAGE_SERVER/newcountnotifier.cpp
+           $$MESSAGE_SERVER/newcountnotifier.cpp \
+           $$MESSAGE_SERVER/sparqlindexer.cpp
 
 !symbian:!win32 {
 	HEADERS += testmalloc.h 3rdparty/cycle_p.h
diff --git a/qmf.pro b/qmf.pro
index d88fb14..bcec51a 100644
--- a/qmf.pro
+++ b/qmf.pro
@@ -1,26 +1,26 @@
-TEMPLATE = subdirs
-SUBDIRS = src/libraries/qtopiamail \
-          src/libraries/messageserver \
-          src/libraries/qmfutil \
-          src/plugins/messageservices/imap \
-          src/plugins/messageservices/pop \
-          src/plugins/messageservices/smtp \
-          src/plugins/messageservices/qtopiamailfile \
-          src/plugins/contentmanagers/qtopiamailfile \
-          src/plugins/viewers/generic \
-          src/plugins/composers/email \
-          src/tools/messageserver \
-          examples/applications/qtmail \
-          examples/settings/messagingaccounts \
-          tests \
-          benchmarks \
-
-CONFIG += ordered
-
-# Custom target 'doc' to generate documentation
-dox.target = doc
-dox.commands = THISYEAR=2009 qdoc3 $$_PRO_FILE_PWD_/doc/src/qmf.qdocconf
-dox.depends =
-
-QMAKE_EXTRA_TARGETS += dox
-
+TEMPLATE = subdirs
+SUBDIRS = src/libraries/qtopiamail \
+          src/libraries/messageserver \
+          src/libraries/qmfutil \
+          src/libraries/sparql \
+          src/plugins/messageservices/imap \
+          src/plugins/messageservices/pop \
+          src/plugins/messageservices/smtp \
+          src/plugins/messageservices/qtopiamailfile \
+          src/plugins/contentmanagers/qtopiamailfile \
+          src/plugins/viewers/generic \
+          src/plugins/composers/email \
+          src/tools/messageserver \
+          examples/applications/qtmail \
+          examples/settings/messagingaccounts \
+          tests \
+          benchmarks \
+
+CONFIG += ordered
+
+# Custom target 'doc' to generate documentation
+dox.target = doc
+dox.commands = THISYEAR=2009 qdoc3 $$_PRO_FILE_PWD_/doc/src/qmf.qdocconf
+dox.depends =
+
+QMAKE_EXTRA_TARGETS += dox
diff --git a/src/libraries/messageserver/include/QMailAuthenticator b/src/libraries/messageserver/include/QMailAuthenticator
new file mode 100644
index 0000000..a1c5ba5
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailAuthenticator
@@ -0,0 +1 @@
+#include "qmailauthenticator.h"
diff --git a/src/libraries/messageserver/include/QMailMessageClassifier b/src/libraries/messageserver/include/QMailMessageClassifier
new file mode 100644
index 0000000..285ed1a
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailMessageClassifier
@@ -0,0 +1 @@
+#include "qmailmessageclassifier.h"
diff --git a/src/libraries/messageserver/include/QMailMessageService b/src/libraries/messageserver/include/QMailMessageService
new file mode 100644
index 0000000..8df572e
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailMessageService
@@ -0,0 +1 @@
+#include "qmailmessageservice.h"
diff --git a/src/libraries/messageserver/include/QMailMessageServiceConfigurator b/src/libraries/messageserver/include/QMailMessageServiceConfigurator
new file mode 100644
index 0000000..8df572e
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailMessageServiceConfigurator
@@ -0,0 +1 @@
+#include "qmailmessageservice.h"
diff --git a/src/libraries/messageserver/include/QMailMessageServiceEditor b/src/libraries/messageserver/include/QMailMessageServiceEditor
new file mode 100644
index 0000000..8df572e
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailMessageServiceEditor
@@ -0,0 +1 @@
+#include "qmailmessageservice.h"
diff --git a/src/libraries/messageserver/include/QMailMessageServiceFactory b/src/libraries/messageserver/include/QMailMessageServiceFactory
new file mode 100644
index 0000000..8df572e
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailMessageServiceFactory
@@ -0,0 +1 @@
+#include "qmailmessageservice.h"
diff --git a/src/libraries/messageserver/include/QMailMessageServicePlugin b/src/libraries/messageserver/include/QMailMessageServicePlugin
new file mode 100644
index 0000000..8df572e
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailMessageServicePlugin
@@ -0,0 +1 @@
+#include "qmailmessageservice.h"
diff --git a/src/libraries/messageserver/include/QMailMessageSink b/src/libraries/messageserver/include/QMailMessageSink
new file mode 100644
index 0000000..8df572e
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailMessageSink
@@ -0,0 +1 @@
+#include "qmailmessageservice.h"
diff --git a/src/libraries/messageserver/include/QMailMessageSource b/src/libraries/messageserver/include/QMailMessageSource
new file mode 100644
index 0000000..8df572e
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailMessageSource
@@ -0,0 +1 @@
+#include "qmailmessageservice.h"
diff --git a/src/libraries/messageserver/include/QMailServiceConfiguration b/src/libraries/messageserver/include/QMailServiceConfiguration
new file mode 100644
index 0000000..c6f8a6c
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailServiceConfiguration
@@ -0,0 +1 @@
+#include "qmailserviceconfiguration.h"
diff --git a/src/libraries/messageserver/include/QMailTransport b/src/libraries/messageserver/include/QMailTransport
new file mode 100644
index 0000000..1b390c9
--- /dev/null
+++ b/src/libraries/messageserver/include/QMailTransport
@@ -0,0 +1 @@
+#include "qmailtransport.h"
diff --git a/src/libraries/messageserver/messageserver.pro b/src/libraries/messageserver/messageserver.pro
index b6e78da..eaf1ff6 100644
--- a/src/libraries/messageserver/messageserver.pro
+++ b/src/libraries/messageserver/messageserver.pro
@@ -17,6 +17,9 @@ DEFINES += MESSAGESERVER_INTERNAL
 
 DEPENDPATH += .
 
+CONFIG += warn_on create_pc create_prl
+
+
 INCLUDEPATH += . ../qtopiamail ../qtopiamail/support
 
 LIBS += -L../qtopiamail -lqtopiamail
@@ -35,3 +38,13 @@ SOURCES += qmailauthenticator.cpp \
            qmailstoreaccountfilter.cpp \
            qmailtransport.cpp
 
+# Install headers
+headers.files = $$HEADERS include/*
+headers.path  = $$QMF_INSTALL_ROOT/include/qmf
+
+INSTALLS += headers 
+
+# Install pkgconfig file
+QMAKE_PKGCONFIG_LIBDIR  = $$target.path
+QMAKE_PKGCONFIG_INCDIR  = $$headers.path
+QMAKE_PKGCONFIG_DESTDIR = pkgconfig
diff --git a/src/libraries/messageserver/qmailmessageservice.h b/src/libraries/messageserver/qmailmessageservice.h
index e194a4d..449b9e6 100644
--- a/src/libraries/messageserver/qmailmessageservice.h
+++ b/src/libraries/messageserver/qmailmessageservice.h
@@ -237,6 +237,7 @@ public:
 
     virtual bool available() const = 0;
 
+    virtual bool requiresReregistration() { return true; }
 public slots:
     virtual bool cancelOperation() = 0;
 
diff --git a/src/libraries/qmfutil/include/QMailComposerFactory b/src/libraries/qmfutil/include/QMailComposerFactory
new file mode 100644
index 0000000..23b68f1
--- /dev/null
+++ b/src/libraries/qmfutil/include/QMailComposerFactory
@@ -0,0 +1 @@
+#include "qmailcomposer.h"
\ No newline at end of file
diff --git a/src/libraries/qmfutil/include/QMailComposerInterface b/src/libraries/qmfutil/include/QMailComposerInterface
new file mode 100644
index 0000000..23b68f1
--- /dev/null
+++ b/src/libraries/qmfutil/include/QMailComposerInterface
@@ -0,0 +1 @@
+#include "qmailcomposer.h"
\ No newline at end of file
diff --git a/src/libraries/qmfutil/include/QMailMessageDelegate b/src/libraries/qmfutil/include/QMailMessageDelegate
new file mode 100644
index 0000000..6d19eb2
--- /dev/null
+++ b/src/libraries/qmfutil/include/QMailMessageDelegate
@@ -0,0 +1 @@
+#include "qmailmessagedelegate.h"
\ No newline at end of file
diff --git a/src/libraries/qmfutil/include/QMailViewerFactory b/src/libraries/qmfutil/include/QMailViewerFactory
new file mode 100644
index 0000000..81a8bde
--- /dev/null
+++ b/src/libraries/qmfutil/include/QMailViewerFactory
@@ -0,0 +1 @@
+#include "qmailviewer.h"
diff --git a/src/libraries/qmfutil/include/QMailViewerInterface b/src/libraries/qmfutil/include/QMailViewerInterface
new file mode 100644
index 0000000..dc9d052
--- /dev/null
+++ b/src/libraries/qmfutil/include/QMailViewerInterface
@@ -0,0 +1 @@
+#include "qmailviewer.h"
\ No newline at end of file
diff --git a/src/libraries/qmfutil/include/QtopiaHomeMailMessageDelegate b/src/libraries/qmfutil/include/QtopiaHomeMailMessageDelegate
new file mode 100644
index 0000000..6d19eb2
--- /dev/null
+++ b/src/libraries/qmfutil/include/QtopiaHomeMailMessageDelegate
@@ -0,0 +1 @@
+#include "qmailmessagedelegate.h"
\ No newline at end of file
diff --git a/src/libraries/qmfutil/qmfutil.pro b/src/libraries/qmfutil/qmfutil.pro
index 760488c..75f459a 100644
--- a/src/libraries/qmfutil/qmfutil.pro
+++ b/src/libraries/qmfutil/qmfutil.pro
@@ -18,6 +18,9 @@ INCLUDEPATH += . ../qtopiamail ../qtopiamail/support
 
 LIBS += -L../qtopiamail -lqtopiamail
 
+
+CONFIG += warn_on create_pc create_prl
+
 HEADERS += emailfoldermodel.h \
            emailfolderview.h \
            folderdelegate.h \
@@ -51,4 +54,3 @@ TRANSLATIONS += libqmfutil-ar.ts \
                 libqmfutil-zh_TW.ts
 
 RESOURCES += qmfutil.qrc
-
diff --git a/src/libraries/qtopiamail/include/MailId b/src/libraries/qtopiamail/include/MailId
new file mode 100644
index 0000000..e2db656
--- /dev/null
+++ b/src/libraries/qtopiamail/include/MailId
@@ -0,0 +1 @@
+#include "qmailid.h"
diff --git a/src/libraries/qtopiamail/include/QMailAccount b/src/libraries/qtopiamail/include/QMailAccount
new file mode 100644
index 0000000..e403614
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailAccount
@@ -0,0 +1 @@
+#include "qmailaccount.h"
diff --git a/src/libraries/qtopiamail/include/QMailAccountConfiguration b/src/libraries/qtopiamail/include/QMailAccountConfiguration
new file mode 100644
index 0000000..0631517
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailAccountConfiguration
@@ -0,0 +1 @@
+#include "qmailaccountconfiguration.h"
diff --git a/src/libraries/qtopiamail/include/QMailAccountId b/src/libraries/qtopiamail/include/QMailAccountId
new file mode 100644
index 0000000..e2db656
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailAccountId
@@ -0,0 +1 @@
+#include "qmailid.h"
diff --git a/src/libraries/qtopiamail/include/QMailAccountKey b/src/libraries/qtopiamail/include/QMailAccountKey
new file mode 100644
index 0000000..1c39992
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailAccountKey
@@ -0,0 +1 @@
+#include "qmailaccountkey.h"
diff --git a/src/libraries/qtopiamail/include/QMailAccountListModel b/src/libraries/qtopiamail/include/QMailAccountListModel
new file mode 100644
index 0000000..a9d6feb
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailAccountListModel
@@ -0,0 +1 @@
+#include "qmailaccountlistmodel.h"
diff --git a/src/libraries/qtopiamail/include/QMailAccountMessageSet b/src/libraries/qtopiamail/include/QMailAccountMessageSet
new file mode 100644
index 0000000..d8be240
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailAccountMessageSet
@@ -0,0 +1 @@
+#include "qmailmessageset.h"
diff --git a/src/libraries/qtopiamail/include/QMailAccountSortKey b/src/libraries/qtopiamail/include/QMailAccountSortKey
new file mode 100644
index 0000000..87a88f6
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailAccountSortKey
@@ -0,0 +1 @@
+#include "qmailaccountsortkey.h"
diff --git a/src/libraries/qtopiamail/include/QMailAddress b/src/libraries/qtopiamail/include/QMailAddress
new file mode 100644
index 0000000..80d6726
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailAddress
@@ -0,0 +1 @@
+#include "qmailaddress.h"
diff --git a/src/libraries/qtopiamail/include/QMailBase64Codec b/src/libraries/qtopiamail/include/QMailBase64Codec
new file mode 100644
index 0000000..1a908f2
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailBase64Codec
@@ -0,0 +1 @@
+#include "qmailcodec.h"
diff --git a/src/libraries/qtopiamail/include/QMailCodec b/src/libraries/qtopiamail/include/QMailCodec
new file mode 100644
index 0000000..1a908f2
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailCodec
@@ -0,0 +1 @@
+#include "qmailcodec.h"
diff --git a/src/libraries/qtopiamail/include/QMailContentManager b/src/libraries/qtopiamail/include/QMailContentManager
new file mode 100644
index 0000000..7c05cb5
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailContentManager
@@ -0,0 +1 @@
+#include "qmailcontentmanager.h"
diff --git a/src/libraries/qtopiamail/include/QMailContentManagerFactory b/src/libraries/qtopiamail/include/QMailContentManagerFactory
new file mode 100644
index 0000000..7c05cb5
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailContentManagerFactory
@@ -0,0 +1 @@
+#include "qmailcontentmanager.h"
diff --git a/src/libraries/qtopiamail/include/QMailContentManagerPlugin b/src/libraries/qtopiamail/include/QMailContentManagerPlugin
new file mode 100644
index 0000000..7c05cb5
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailContentManagerPlugin
@@ -0,0 +1 @@
+#include "qmailcontentmanager.h"
diff --git a/src/libraries/qtopiamail/include/QMailFilterMessageSet b/src/libraries/qtopiamail/include/QMailFilterMessageSet
new file mode 100644
index 0000000..d8be240
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailFilterMessageSet
@@ -0,0 +1 @@
+#include "qmailmessageset.h"
diff --git a/src/libraries/qtopiamail/include/QMailFolder b/src/libraries/qtopiamail/include/QMailFolder
new file mode 100644
index 0000000..cae2455
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailFolder
@@ -0,0 +1 @@
+#include "qmailfolder.h"
diff --git a/src/libraries/qtopiamail/include/QMailFolderId b/src/libraries/qtopiamail/include/QMailFolderId
new file mode 100644
index 0000000..e2db656
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailFolderId
@@ -0,0 +1 @@
+#include "qmailid.h"
diff --git a/src/libraries/qtopiamail/include/QMailFolderKey b/src/libraries/qtopiamail/include/QMailFolderKey
new file mode 100644
index 0000000..5effe63
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailFolderKey
@@ -0,0 +1 @@
+#include "qmailfolderkey.h"
diff --git a/src/libraries/qtopiamail/include/QMailFolderMessageSet b/src/libraries/qtopiamail/include/QMailFolderMessageSet
new file mode 100644
index 0000000..d8be240
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailFolderMessageSet
@@ -0,0 +1 @@
+#include "qmailmessageset.h"
diff --git a/src/libraries/qtopiamail/include/QMailFolderSortKey b/src/libraries/qtopiamail/include/QMailFolderSortKey
new file mode 100644
index 0000000..231dba5
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailFolderSortKey
@@ -0,0 +1 @@
+#include "qmailfoldersortkey.h"
diff --git a/src/libraries/qtopiamail/include/QMailLineEndingCodec b/src/libraries/qtopiamail/include/QMailLineEndingCodec
new file mode 100644
index 0000000..1a908f2
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailLineEndingCodec
@@ -0,0 +1 @@
+#include "qmailcodec.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessage b/src/libraries/qtopiamail/include/QMailMessage
new file mode 100644
index 0000000..1f120e0
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessage
@@ -0,0 +1 @@
+#include "qmailmessage.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageBody b/src/libraries/qtopiamail/include/QMailMessageBody
new file mode 100644
index 0000000..1f120e0
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageBody
@@ -0,0 +1 @@
+#include "qmailmessage.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageContentDisposition b/src/libraries/qtopiamail/include/QMailMessageContentDisposition
new file mode 100644
index 0000000..1f120e0
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageContentDisposition
@@ -0,0 +1 @@
+#include "qmailmessage.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageContentType b/src/libraries/qtopiamail/include/QMailMessageContentType
new file mode 100644
index 0000000..1f120e0
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageContentType
@@ -0,0 +1 @@
+#include "qmailmessage.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageHeaderField b/src/libraries/qtopiamail/include/QMailMessageHeaderField
new file mode 100644
index 0000000..1f120e0
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageHeaderField
@@ -0,0 +1 @@
+#include "qmailmessage.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageId b/src/libraries/qtopiamail/include/QMailMessageId
new file mode 100644
index 0000000..e2db656
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageId
@@ -0,0 +1 @@
+#include "qmailid.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageKey b/src/libraries/qtopiamail/include/QMailMessageKey
new file mode 100644
index 0000000..06211f5
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageKey
@@ -0,0 +1 @@
+#include "qmailmessagekey.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageListModel b/src/libraries/qtopiamail/include/QMailMessageListModel
new file mode 100644
index 0000000..5eb664a
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageListModel
@@ -0,0 +1 @@
+#include "qmailmessagelistmodel.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageMetaData b/src/libraries/qtopiamail/include/QMailMessageMetaData
new file mode 100644
index 0000000..1f120e0
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageMetaData
@@ -0,0 +1 @@
+#include "qmailmessage.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessagePart b/src/libraries/qtopiamail/include/QMailMessagePart
new file mode 100644
index 0000000..1f120e0
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessagePart
@@ -0,0 +1 @@
+#include "qmailmessage.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessagePartContainer b/src/libraries/qtopiamail/include/QMailMessagePartContainer
new file mode 100644
index 0000000..1f120e0
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessagePartContainer
@@ -0,0 +1 @@
+#include "qmailmessage.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageRemovalRecord b/src/libraries/qtopiamail/include/QMailMessageRemovalRecord
new file mode 100644
index 0000000..737bd83
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageRemovalRecord
@@ -0,0 +1 @@
+#include "qmailmessageremovalrecord.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageServer b/src/libraries/qtopiamail/include/QMailMessageServer
new file mode 100644
index 0000000..5398cdc
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageServer
@@ -0,0 +1 @@
+#include "qmailmessageserver.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageSet b/src/libraries/qtopiamail/include/QMailMessageSet
new file mode 100644
index 0000000..d8be240
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageSet
@@ -0,0 +1 @@
+#include "qmailmessageset.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageSetContainer b/src/libraries/qtopiamail/include/QMailMessageSetContainer
new file mode 100644
index 0000000..d8be240
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageSetContainer
@@ -0,0 +1 @@
+#include "qmailmessageset.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageSetModel b/src/libraries/qtopiamail/include/QMailMessageSetModel
new file mode 100644
index 0000000..d8be240
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageSetModel
@@ -0,0 +1 @@
+#include "qmailmessageset.h"
diff --git a/src/libraries/qtopiamail/include/QMailMessageSortKey b/src/libraries/qtopiamail/include/QMailMessageSortKey
new file mode 100644
index 0000000..b6f0399
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailMessageSortKey
@@ -0,0 +1 @@
+#include "qmailmessagesortkey.h"
diff --git a/src/libraries/qtopiamail/include/QMailNewEmailHandler b/src/libraries/qtopiamail/include/QMailNewEmailHandler
new file mode 100644
index 0000000..61db895
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailNewEmailHandler
@@ -0,0 +1 @@
+#include "qmailnewmessagehandler.h"
diff --git a/src/libraries/qtopiamail/include/QMailNewMessageHandler b/src/libraries/qtopiamail/include/QMailNewMessageHandler
new file mode 100644
index 0000000..61db895
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailNewMessageHandler
@@ -0,0 +1 @@
+#include "qmailnewmessagehandler.h"
diff --git a/src/libraries/qtopiamail/include/QMailPassThroughCodec b/src/libraries/qtopiamail/include/QMailPassThroughCodec
new file mode 100644
index 0000000..1a908f2
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailPassThroughCodec
@@ -0,0 +1 @@
+#include "qmailcodec.h"
diff --git a/src/libraries/qtopiamail/include/QMailQuotedPrintableCodec b/src/libraries/qtopiamail/include/QMailQuotedPrintableCodec
new file mode 100644
index 0000000..1a908f2
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailQuotedPrintableCodec
@@ -0,0 +1 @@
+#include "qmailcodec.h"
diff --git a/src/libraries/qtopiamail/include/QMailRetrievalAction b/src/libraries/qtopiamail/include/QMailRetrievalAction
new file mode 100644
index 0000000..cfbd6ca
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailRetrievalAction
@@ -0,0 +1 @@
+#include "qmailserviceaction.h"
diff --git a/src/libraries/qtopiamail/include/QMailSearchAction b/src/libraries/qtopiamail/include/QMailSearchAction
new file mode 100644
index 0000000..cfbd6ca
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailSearchAction
@@ -0,0 +1 @@
+#include "qmailserviceaction.h"
diff --git a/src/libraries/qtopiamail/include/QMailServiceAction b/src/libraries/qtopiamail/include/QMailServiceAction
new file mode 100644
index 0000000..cfbd6ca
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailServiceAction
@@ -0,0 +1 @@
+#include "qmailserviceaction.h"
diff --git a/src/libraries/qtopiamail/include/QMailStorageAction b/src/libraries/qtopiamail/include/QMailStorageAction
new file mode 100644
index 0000000..cfbd6ca
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailStorageAction
@@ -0,0 +1 @@
+#include "qmailserviceaction.h"
diff --git a/src/libraries/qtopiamail/include/QMailStore b/src/libraries/qtopiamail/include/QMailStore
new file mode 100644
index 0000000..217a7a7
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailStore
@@ -0,0 +1 @@
+#include "qmailstore.h"
diff --git a/src/libraries/qtopiamail/include/QMailTimeStamp b/src/libraries/qtopiamail/include/QMailTimeStamp
new file mode 100644
index 0000000..07bfe99
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailTimeStamp
@@ -0,0 +1 @@
+#include "qmailtimestamp.h"
diff --git a/src/libraries/qtopiamail/include/QMailTransmitAction b/src/libraries/qtopiamail/include/QMailTransmitAction
new file mode 100644
index 0000000..cfbd6ca
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QMailTransmitAction
@@ -0,0 +1 @@
+#include "qmailserviceaction.h"
diff --git a/src/libraries/qtopiamail/include/QPrivatelyImplemented b/src/libraries/qtopiamail/include/QPrivatelyImplemented
new file mode 100644
index 0000000..0b73b3b
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QPrivatelyImplemented
@@ -0,0 +1 @@
+#include "qprivateimplementation.h"
diff --git a/src/libraries/qtopiamail/include/QPrivatelyNoncopyable b/src/libraries/qtopiamail/include/QPrivatelyNoncopyable
new file mode 100644
index 0000000..0b73b3b
--- /dev/null
+++ b/src/libraries/qtopiamail/include/QPrivatelyNoncopyable
@@ -0,0 +1 @@
+#include "qprivateimplementation.h"
diff --git a/src/libraries/qtopiamail/include/ServiceConfiguration b/src/libraries/qtopiamail/include/ServiceConfiguration
new file mode 100644
index 0000000..0631517
--- /dev/null
+++ b/src/libraries/qtopiamail/include/ServiceConfiguration
@@ -0,0 +1 @@
+#include "qmailaccountconfiguration.h"
diff --git a/src/libraries/qtopiamail/include/Status b/src/libraries/qtopiamail/include/Status
new file mode 100644
index 0000000..cfbd6ca
--- /dev/null
+++ b/src/libraries/qtopiamail/include/Status
@@ -0,0 +1 @@
+#include "qmailserviceaction.h"
diff --git a/src/libraries/qtopiamail/qmailmessagelistmodel.cpp b/src/libraries/qtopiamail/qmailmessagelistmodel.cpp
index ee47531..2993830 100644
--- a/src/libraries/qtopiamail/qmailmessagelistmodel.cpp
+++ b/src/libraries/qtopiamail/qmailmessagelistmodel.cpp
@@ -571,15 +571,12 @@ QMailMessageListModel::~QMailMessageListModel()
 }
 
 /*! \reimp */
-QModelIndex QMailMessageListModel::index(int row, int column, const QModelIndex &idx) const
+QModelIndex QMailMessageListModel::index(int row, int column, const QModelIndex &parent) const
 {
-    if (idx.isValid()) {
-        return QModelIndex();
-    }
-
-    return createIndex(row, column);
+    return hasIndex(row, column, parent) ? createIndex(row, column, 0) : QModelIndex();
 }
 
+
 /*! \reimp */
 QModelIndex QMailMessageListModel::parent(const QModelIndex &idx) const
 {
diff --git a/src/libraries/qtopiamail/qmailmessagelistmodel.h b/src/libraries/qtopiamail/qmailmessagelistmodel.h
index c779cb3..80310cf 100644
--- a/src/libraries/qtopiamail/qmailmessagelistmodel.h
+++ b/src/libraries/qtopiamail/qmailmessagelistmodel.h
@@ -55,7 +55,7 @@ public:
     QMailMessageListModel(QObject* parent = 0);
     virtual ~QMailMessageListModel();
 
-    QModelIndex index(int row, int column = 0, const QModelIndex &idx = QModelIndex()) const;
+    QModelIndex index(int row, int column = 0, const QModelIndex &parent = QModelIndex()) const;
     QModelIndex parent(const QModelIndex &idx) const;
 
     QModelIndex generateIndex(int row, int column, void *ptr);
diff --git a/src/libraries/qtopiamail/qmailstore_p.cpp b/src/libraries/qtopiamail/qmailstore_p.cpp
index 21b25f4..22d2fdf 100644
--- a/src/libraries/qtopiamail/qmailstore_p.cpp
+++ b/src/libraries/qtopiamail/qmailstore_p.cpp
@@ -53,6 +53,7 @@
 #include <QSqlError>
 #include <QSqlRecord>
 #include <QTextCodec>
+#include <QSharedPointer>
 
 #define Q_USE_SQLITE
 
@@ -174,7 +175,7 @@ public:
 
     Guard(Mutex& m)
         : mutex(m),
-          locked(false) 
+          locked(false)
     {
     }
 
@@ -192,7 +193,7 @@ public:
     {
         if (locked) {
             mutex.unlock();
-            locked = false; 
+            locked = false;
         }
     }
 };
@@ -258,7 +259,7 @@ template<>
 class MessageValueExtractor<QMailMessageMetaData>
 {
     const QMailMessageMetaData &_data;
-    
+
 public:
     MessageValueExtractor(const QMailMessageMetaData &d) : _data(d) {}
 
@@ -305,7 +306,7 @@ template<>
 class MessageValueExtractor<QVariant>
 {
     const QVariant &_value;
-    
+
 public:
     MessageValueExtractor(const QVariant &v) : _value(v) {}
 
@@ -346,9 +347,9 @@ public:
 
 
 // Properties of the mailmessages table
-static QMailStorePrivate::MessagePropertyMap messagePropertyMap() 
+static QMailStorePrivate::MessagePropertyMap messagePropertyMap()
 {
-    QMailStorePrivate::MessagePropertyMap map; 
+    QMailStorePrivate::MessagePropertyMap map;
 
     map.insert(QMailMessageKey::Id,"id");
     map.insert(QMailMessageKey::Type,"type");
@@ -384,16 +385,16 @@ static QString messagePropertyName(QMailMessageKey::Property property)
     if ((property != QMailMessageKey::AncestorFolderIds) &&
         (property != QMailMessageKey::Custom))
         qWarning() << "Unknown message property:" << property;
-    
+
     return QString();
 }
 
 typedef QMap<QMailAccountKey::Property, QString> AccountPropertyMap;
 
 // Properties of the mailaccounts table
-static AccountPropertyMap accountPropertyMap() 
+static AccountPropertyMap accountPropertyMap()
 {
-    AccountPropertyMap map; 
+    AccountPropertyMap map;
 
     map.insert(QMailAccountKey::Id,"id");
     map.insert(QMailAccountKey::Name,"name");
@@ -421,9 +422,9 @@ static QString accountPropertyName(QMailAccountKey::Property property)
 typedef QMap<QMailFolderKey::Property, QString> FolderPropertyMap;
 
 // Properties of the mailfolders table
-static FolderPropertyMap folderPropertyMap() 
+static FolderPropertyMap folderPropertyMap()
 {
-    FolderPropertyMap map; 
+    FolderPropertyMap map;
 
     map.insert(QMailFolderKey::Id,"id");
     map.insert(QMailFolderKey::Path,"name");
@@ -612,7 +613,7 @@ class ArgumentExtractorBase
 {
 protected:
     const Argument &arg;
-    
+
     ArgumentExtractorBase(const Argument &a) : arg(a) {}
 
     QString minimalString(const QString &s) const
@@ -623,7 +624,7 @@ protected:
             QString minimal(address.minimalPhoneNumber());
 
             // Rather than compare exact numbers, we will only use the trailing
-            // digits to compare phone numbers - otherwise, slightly different 
+            // digits to compare phone numbers - otherwise, slightly different
             // forms of the same number will not be matched
             static const int significantDigits = 8;
 
@@ -678,10 +679,10 @@ protected:
     template<typename ID>
     quint64 idValue() const
     {
-        return QMailStorePrivate::extractValue<ID>(arg.valueList.first()).toULongLong(); 
+        return QMailStorePrivate::extractValue<ID>(arg.valueList.first()).toULongLong();
     }
 
-    template<typename ClauseKey>
+    template <typename ClauseKey>
     QVariantList idValues() const
     {
         const QVariant& var = arg.valueList.first();
@@ -735,7 +736,6 @@ protected:
     }
 };
 
-
 template<typename PropertyType, typename BitmapType = int>
 class RecordExtractorBase
 {
@@ -745,10 +745,10 @@ protected:
 
     RecordExtractorBase(const QSqlRecord &r, BitmapType b = 0) : record(r), bitmap(b) {}
     virtual ~RecordExtractorBase() {}
-    
+
     template<typename ValueType>
-    ValueType value(const QString &field, const ValueType &defaultValue = ValueType()) const 
-    { 
+    ValueType value(const QString &field, const ValueType &defaultValue = ValueType()) const
+    {
         int index(fieldIndex(field, bitmap));
 
         if (record.isNull(index))
@@ -756,10 +756,10 @@ protected:
         else
             return QMailStorePrivate::extractValue<ValueType>(record.value(index), defaultValue);
     }
-    
+
     template<typename ValueType>
-    ValueType value(PropertyType p, const ValueType &defaultValue = ValueType()) const 
-    { 
+    ValueType value(PropertyType p, const ValueType &defaultValue = ValueType()) const
+    {
         return value(fieldName(p, QString()), defaultValue);
     }
 
@@ -789,7 +789,7 @@ protected:
 class MessageRecord : public RecordExtractorBase<QMailMessageKey::Property, QMailMessageKey::Properties>
 {
 public:
-    MessageRecord(const QSqlRecord &r, QMailMessageKey::Properties props) 
+    MessageRecord(const QSqlRecord &r, QMailMessageKey::Properties props)
         : RecordExtractorBase<QMailMessageKey::Property, QMailMessageKey::Properties>(r, props) {}
 
     QMailMessageId id() const { return QMailMessageId(value<quint64>(QMailMessageKey::Id)); }
@@ -820,18 +820,18 @@ public:
 
     QMailFolderId previousParentFolderId() const { return QMailFolderId(value<quint64>(QMailMessageKey::PreviousParentFolderId)); }
 
-    QString contentScheme() const 
-    { 
-        if (_uriElements.first.isNull()) 
-            _uriElements = extractUriElements(value<QString>(QMailMessageKey::ContentScheme)); 
+    QString contentScheme() const
+    {
+        if (_uriElements.first.isNull())
+            _uriElements = extractUriElements(value<QString>(QMailMessageKey::ContentScheme));
 
         return _uriElements.first;
     }
 
-    QString contentIdentifier() const 
-    { 
-        if (_uriElements.first.isNull()) 
-            _uriElements = extractUriElements(value<QString>(QMailMessageKey::ContentIdentifier)); 
+    QString contentIdentifier() const
+    {
+        if (_uriElements.first.isNull())
+            _uriElements = extractUriElements(value<QString>(QMailMessageKey::ContentIdentifier));
 
         return _uriElements.second;
     }
@@ -858,7 +858,7 @@ QMap<QMailMessageKey::Properties, QMap<QString, int> > MessageRecord::_fieldInde
 class MessageKeyArgumentExtractor : public ArgumentExtractorBase<QMailMessageKey>
 {
 public:
-    MessageKeyArgumentExtractor(const QMailMessageKey::ArgumentType &a) 
+    MessageKeyArgumentExtractor(const QMailMessageKey::ArgumentType &a)
         : ArgumentExtractorBase<QMailMessageKey>(a) {}
 
     QVariantList id() const { return idValues<QMailMessageKey>(); }
@@ -895,10 +895,10 @@ public:
 
     QVariantList previousParentFolderId() const { return idValues<QMailFolderKey>(); }
 
-    QVariant contentScheme() const 
-    { 
+    QVariant contentScheme() const
+    {
         // Any colons in the field will be stored in escaped format
-        QString value(escape(QMailStorePrivate::extractValue<QString>(arg.valueList.first()), ':')); 
+        QString value(escape(QMailStorePrivate::extractValue<QString>(arg.valueList.first()), ':'));
 
         if ((arg.op == Includes) || (arg.op == Excludes)) {
             value.prepend('%').append('%');
@@ -908,10 +908,10 @@ public:
         return value;
     }
 
-    QVariant contentIdentifier() const 
-    { 
+    QVariant contentIdentifier() const
+    {
         // Any colons in the field will be stored in escaped format
-        QString value(escape(QMailStorePrivate::extractValue<QString>(arg.valueList.first()), ':')); 
+        QString value(escape(QMailStorePrivate::extractValue<QString>(arg.valueList.first()), ':'));
 
         if ((arg.op == Includes) || (arg.op == Excludes)) {
             value.prepend('%').append('%');
@@ -936,7 +936,7 @@ void appendWhereValues<QMailMessageKey::ArgumentType>(const QMailMessageKey::Arg
     const MessageKeyArgumentExtractor extractor(a);
 
     switch (a.property)
-    { 
+    {
     case QMailMessageKey::Id:
         if (a.valueList.count() < IdLookupThreshold) {
             values += extractor.id();
@@ -1031,38 +1031,6 @@ void appendWhereValues<QMailMessageKey::ArgumentType>(const QMailMessageKey::Arg
     }
 }
 
-
-// Class to extract data from records of the mailaccounts table
-class AccountRecord : public RecordExtractorBase<QMailAccountKey::Property>
-{
-public:
-    AccountRecord(const QSqlRecord &r) 
-        : RecordExtractorBase<QMailAccountKey::Property>(r) {}
-
-    QMailAccountId id() const { return QMailAccountId(value<quint64>(QMailAccountKey::Id)); }
-
-    QString name() const { return value<QString>(QMailAccountKey::Name); }
-
-    QMailMessage::MessageType messageType() const { return static_cast<QMailMessage::MessageType>(value<int>(QMailAccountKey::MessageType, -1)); }
-
-    QString fromAddress() const { return value<QString>(QMailAccountKey::FromAddress); }
-
-    quint64 status() const { return value<quint64>(QMailAccountKey::Status); }
-
-    QString signature() const { return value<QString>("signature"); }
-
-private:
-    int fieldIndex(const QString &field, int props) const
-    {
-        return mappedFieldIndex(field, props, _fieldIndex);
-    }
-
-    static QMap<int, QMap<QString, int> > _fieldIndex;
-};
-
-QMap<int, QMap<QString, int> > AccountRecord::_fieldIndex;
-
-
 // Class to convert QMailAccountKey argument values to SQL bind values
 class AccountKeyArgumentExtractor : public ArgumentExtractorBase<QMailAccountKey>
 {
@@ -1076,8 +1044,8 @@ public:
 
     QVariant messageType() const { return intValue(); }
 
-    QVariant fromAddress() const 
-    { 
+    QVariant fromAddress() const
+    {
         QString value(QMailStorePrivate::extractValue<QString>(arg.valueList.first()));
 
         // This test will be converted to a LIKE test, for all comparators
@@ -1127,7 +1095,6 @@ void appendWhereValues<QMailAccountKey::ArgumentType>(const QMailAccountKey::Arg
     }
 }
 
-
 // Class to extract data from records of the mailfolders table
 class FolderRecord : public RecordExtractorBase<QMailFolderKey::Property>
 {
@@ -1307,7 +1274,7 @@ QString buildOrderClause(const ArgumentListType &list, const QString &alias)
 
 QString operatorString(QMailKey::Comparator op, bool multipleArgs = false, bool patternMatch = false, bool bitwiseMultiples = false)
 {
-    switch (op) 
+    switch (op)
     {
     case Equal:
         return (multipleArgs ? " IN " : (patternMatch ? " LIKE " : " = "));
@@ -1350,7 +1317,7 @@ QString operatorString(QMailKey::Comparator op, bool multipleArgs = false, bool
 
 QString combineOperatorString(QMailKey::Combiner op)
 {
-    switch (op) 
+    switch (op)
     {
     case And:
         return " AND ";
@@ -1396,7 +1363,7 @@ QString columnExpression(const QString &column, QMailKey::Comparator op, const Q
 
 QString columnExpression(const QString &column, QMailKey::Comparator op, const QVariantList &valueList, bool patternMatch = false, bool bitwiseMultiples = false, bool noCase = false)
 {
-    QString value(QMailStorePrivate::expandValueList(valueList)); 
+    QString value(QMailStorePrivate::expandValueList(valueList));
 
     return columnExpression(column, op, value, (valueList.count() > 1), patternMatch, bitwiseMultiples, noCase);
 }
@@ -1411,7 +1378,7 @@ template<typename Key>
 QString whereClauseItem(const Key &key, const typename Key::ArgumentType &arg, const QString &alias, const QString &field, const QMailStorePrivate &store);
 
 template<>
-QString whereClauseItem<QMailAccountKey>(const QMailAccountKey &, const QMailAccountKey::ArgumentType &a, const QString &alias, const QString &field, const QMailStorePrivate &store)
+QString whereClauseItem<QMailAccountKey>(const QMailAccountKey &, const QMailAccountKey::ArgumentType &a, const QString &alias, const QString &field, const QMailStorePrivate &)
 {
     QString item;
     {
@@ -1429,53 +1396,18 @@ QString whereClauseItem<QMailAccountKey>(const QMailAccountKey &, const QMailAcc
         bool noCase((a.property == QMailAccountKey::Name) || (a.property == QMailAccountKey::FromAddress));
 
         QString expression = columnExpression(columnName, a.op, a.valueList, patternMatching, bitwise, noCase);
-        
-        switch(a.property)
-        {
-        case QMailAccountKey::Id:
-            if (a.valueList.first().canConvert<QMailAccountKey>()) {
-                QMailAccountKey subKey = a.valueList.first().value<QMailAccountKey>();
-                QString nestedAlias(incrementAlias(alias));
-
-                // Expand comparison to sub-query result
-                q << baseExpression(columnName, a.op, true) << "( SELECT " << qualifiedName("id", nestedAlias) << " FROM mailaccounts " << nestedAlias;
-                q << store.buildWhereClause(QMailStorePrivate::Key(subKey, nestedAlias)) << ")";
-            } else {
-                q << expression;
-            }
-            break;
-
-        case QMailAccountKey::Custom:
-            // Match on custom field
-            {
-                QString nestedAlias(incrementAlias(alias));
-
-                // Is this an existence test or a value test?
-                if ((a.op == QMailKey::Present) || (a.op == QMailKey::Absent)) {
-                    q << qualifiedName("id", alias) << operatorString(a.op, true) << "( SELECT " << qualifiedName("id", nestedAlias);
-                    q << " FROM mailaccountcustom " << nestedAlias << " WHERE name=? COLLATE NOCASE )";
-                } else {
-                    q << qualifiedName("id", alias) << " IN ( SELECT " << qualifiedName("id", nestedAlias); q << " FROM mailaccountcustom " << nestedAlias;
-                    q << " WHERE " << qualifiedName("name", nestedAlias) << "=? COLLATE NOCASE AND " 
-                      << qualifiedName("value", nestedAlias) << operatorString(a.op, false) << "? COLLATE NOCASE )";
-                }
-            }
-            break;
-
-        case QMailAccountKey::Status:
-        case QMailAccountKey::MessageType:
-        case QMailAccountKey::Name:
-        case QMailAccountKey::FromAddress:
 
-            q << expression;
-            break;
-        }
+        // Only ID could be queried here,
+        // All other properties will be queried
+        // from Accounts subsystem
+        Q_ASSERT(a.property == QMailAccountKey::Id);
+        q << expression;
     }
     return item;
 }
 
 template<>
-QString whereClauseItem<QMailMessageKey>(const QMailMessageKey &, const QMailMessageKey::ArgumentType &a, const QString &alias, const QString &field, const QMailStorePrivate &store)
+QString whereClauseItem<QMailMessageKey>(const QMailMessageKey &key, const QMailMessageKey::ArgumentType &a, const QString &alias, const QString &field, const QMailStorePrivate &store)
 {
     QString item;
     {
@@ -1494,7 +1426,7 @@ QString whereClauseItem<QMailMessageKey>(const QMailMessageKey &, const QMailMes
         bool noCase((a.property == QMailMessageKey::Sender) || (a.property == QMailMessageKey::Recipients) || (a.property == QMailMessageKey::Subject));
 
         QString expression = columnExpression(columnName, a.op, a.valueList, patternMatching, bitwise, noCase);
-        
+
         switch(a.property)
         {
         case QMailMessageKey::Id:
@@ -1548,10 +1480,12 @@ QString whereClauseItem<QMailMessageKey>(const QMailMessageKey &, const QMailMes
         case QMailMessageKey::ParentAccountId:
             if(a.valueList.first().canConvert<QMailAccountKey>()) {
                 QMailAccountKey parentAccountKey = a.valueList.first().value<QMailAccountKey>();
-                QString nestedAlias(incrementAlias(alias));
+                QMailAccountIdList parentAccountIdList = store.searchSSOAccounts(parentAccountKey);
 
-                q << baseExpression(columnName, a.op, true) << "( SELECT " << qualifiedName("id", nestedAlias) << " FROM mailaccounts " << nestedAlias;
-                q << store.buildWhereClause(QMailStorePrivate::Key(parentAccountKey, nestedAlias)) << ")";
+                // Rewrite argument and execute builder again
+                QMailMessageKey::ArgumentType &arg = const_cast<QMailMessageKey::ArgumentType&>(a);
+                arg = QMailMessageKey::parentAccountId(parentAccountIdList, QMailDataComparator::Includes).arguments().first();
+                return whereClauseItem(key, arg, alias, field, store);
             } else {
                 q << expression;
             }
@@ -1568,7 +1502,7 @@ QString whereClauseItem<QMailMessageKey>(const QMailMessageKey &, const QMailMes
                     q << " FROM mailmessagecustom " << nestedAlias << " WHERE name=? COLLATE NOCASE )";
                 } else {
                     q << qualifiedName("id", alias) << " IN ( SELECT " << qualifiedName("id", nestedAlias); q << " FROM mailmessagecustom " << nestedAlias;
-                    q << " WHERE " << qualifiedName("name", nestedAlias) << "=? COLLATE NOCASE AND " 
+                    q << " WHERE " << qualifiedName("name", nestedAlias) << "=? COLLATE NOCASE AND "
                       << qualifiedName("value", nestedAlias) << operatorString(a.op, false) << "? COLLATE NOCASE )";
                 }
             }
@@ -1631,14 +1565,14 @@ QString whereClauseItem<QMailMessageKey>(const QMailMessageKey &, const QMailMes
         case QMailMessageKey::ContentIdentifier:
         case QMailMessageKey::ResponseType:
             q << expression;
-            break;     
+            break;
         }
     }
     return item;
 }
 
 template<>
-QString whereClauseItem<QMailFolderKey>(const QMailFolderKey &, const QMailFolderKey::ArgumentType &a, const QString &alias, const QString &field, const QMailStorePrivate &store)
+QString whereClauseItem<QMailFolderKey>(const QMailFolderKey &key, const QMailFolderKey::ArgumentType &a, const QString &alias, const QString &field, const QMailStorePrivate &store)
 {
     QString item;
     {
@@ -1655,7 +1589,7 @@ QString whereClauseItem<QMailFolderKey>(const QMailFolderKey &, const QMailFolde
         bool noCase((a.property == QMailFolderKey::Path) || (a.property == QMailFolderKey::DisplayName));
 
         QString expression = columnExpression(columnName, a.op, a.valueList, false, bitwise, noCase);
-        
+
         switch (a.property)
         {
         case QMailFolderKey::Id:
@@ -1704,10 +1638,12 @@ QString whereClauseItem<QMailFolderKey>(const QMailFolderKey &, const QMailFolde
         case QMailFolderKey::ParentAccountId:
             if(a.valueList.first().canConvert<QMailAccountKey>()) {
                 QMailAccountKey accountSubKey = a.valueList.first().value<QMailAccountKey>();
-                QString nestedAlias(incrementAlias(alias));
+                QMailAccountIdList acountIdList = store.searchSSOAccounts(accountSubKey);
 
-                q << baseExpression(columnName, a.op, true) << "( SELECT " << qualifiedName("id", nestedAlias) << " FROM mailaccounts " << nestedAlias;
-                q << store.buildWhereClause(QMailStorePrivate::Key(accountSubKey, nestedAlias)) << ")";
+                // Rewrite argument and execute builder again
+                QMailFolderKey::ArgumentType &arg = const_cast<QMailFolderKey::ArgumentType&>(a);
+                arg = QMailFolderKey::parentAccountId(acountIdList, QMailDataComparator::Includes).arguments().first();
+                return whereClauseItem(key, arg, alias, field, store);
             } else {
                 q << expression;
             }
@@ -1724,7 +1660,7 @@ QString whereClauseItem<QMailFolderKey>(const QMailFolderKey &, const QMailFolde
                     q << " FROM mailfoldercustom " << nestedAlias << " WHERE name=? COLLATE NOCASE )";
                 } else {
                     q << qualifiedName("id", alias) << " IN ( SELECT " << qualifiedName("id", nestedAlias); q << " FROM mailfoldercustom " << nestedAlias;
-                    q << " WHERE " << qualifiedName("name", nestedAlias) << "=? COLLATE NOCASE AND " 
+                    q << " WHERE " << qualifiedName("name", nestedAlias) << "=? COLLATE NOCASE AND "
                       << qualifiedName("value", nestedAlias) << operatorString(a.op, false) << "? COLLATE NOCASE )";
                 }
             }
@@ -1745,15 +1681,15 @@ QString whereClauseItem<QMailFolderKey>(const QMailFolderKey &, const QMailFolde
 }
 
 template<typename KeyType, typename ArgumentListType, typename KeyListType, typename CombineType>
-QString buildWhereClause(const KeyType &key, 
-                         const ArgumentListType &args, 
-                         const KeyListType &subKeys, 
-                         CombineType combine, 
-                         bool negated, 
+QString buildWhereClause(const KeyType &key,
+                         const ArgumentListType &args,
+                         const KeyListType &subKeys,
+                         CombineType combine,
+                         bool negated,
                          bool nested,
                          bool firstClause,
-                         const QString &alias, 
-                         const QString &field, 
+                         const QString &alias,
+                         const QString &field,
                          const QMailStorePrivate& store)
 {
     QString whereClause;
@@ -1775,12 +1711,12 @@ QString buildWhereClause(const KeyType &key,
 
         foreach (typename KeyListType::const_reference subkey, subKeys) {
             QString nestedWhere(store.buildWhereClause(QMailStorePrivate::Key(subkey, alias), true));
-            if (!nestedWhere.isEmpty()) 
+            if (!nestedWhere.isEmpty())
                 s << op << " (" << nestedWhere << ") ";
 
             op = logicalOpString;
-        }       
-    }       
+        }
+    }
 
     // Finalise the where clause
     if (!whereClause.isEmpty()) {
@@ -1810,6 +1746,427 @@ QMailContentManager::DurabilityRequirement durability(bool commitOnSuccess)
     return (commitOnSuccess ? QMailContentManager::EnsureDurability : QMailContentManager::DeferDurability);
 }
 
+// Forward declaration
+bool SSOAccountSatisfyTheKey(Accounts::Account* ssoAccount, const QMailAccountKey& key);
+
+template <typename Property>
+bool SSOAccountCompareProperty(Accounts::Account* ssoAccount, Property value, QMailKey::Comparator op, const QMailAccountKey::ArgumentType::ValueList& arguments)
+{
+    // Argument list should not be empty.
+    // Otherwise we have nothing to compare.
+    Q_ASSERT(arguments.count());
+
+    if (arguments.count() == 1)
+    {
+        if (!arguments.front().canConvert<Property>())
+        {
+            if (arguments.front().canConvert<QMailAccountKey>())
+            {
+                QMailAccountKey accountKey = arguments.front().value<QMailAccountKey>();
+                return SSOAccountSatisfyTheKey(ssoAccount, accountKey);
+            }
+
+            qMailLog(Messaging) << "Failed to convert argument";
+            return false;
+        }
+
+        Property argument = arguments.front().value<Property>();
+        switch (op)
+        {
+            case QMailKey::Equal:
+                return value == argument;
+
+            case QMailKey::NotEqual:
+                return value != argument;
+
+            case QMailKey::Includes:
+            case QMailKey::Present:
+            case QMailKey::Excludes:
+            case QMailKey::Absent:
+            case QMailKey::LessThan:
+            case QMailKey::LessThanEqual:
+            case QMailKey::GreaterThan:
+            case QMailKey::GreaterThanEqual:
+            default:
+                qMailLog(Messaging) << "This comparator is not supported";
+                Q_ASSERT(false);
+                break;
+        }
+
+    } else {
+        switch (op)
+        {
+            case QMailKey::Includes:
+            case QMailKey::Present:
+                foreach (const QVariant& argument, arguments)
+                {
+                    if (argument.canConvert<Property>() && argument.value<Property>() == value)
+                        return true;
+                }
+                return false;
+
+            case QMailKey::Excludes:
+            case QMailKey::Absent:
+                foreach (const QVariant& argument, arguments)
+                {
+                    if (argument.canConvert<Property>() && argument.value<Property>() == value)
+                        return false;
+                }
+                return true;
+
+
+            case QMailKey::LessThan:
+            case QMailKey::LessThanEqual:
+            case QMailKey::GreaterThan:
+            case QMailKey::GreaterThanEqual:
+            case QMailKey::Equal:
+            case QMailKey::NotEqual:
+            default:
+                qMailLog(Messaging) << "This comparator is not supported";
+                Q_ASSERT(false);
+                break;
+        }
+
+    }
+
+    Q_ASSERT(false);
+    return false;
+}
+
+template <>
+bool SSOAccountCompareProperty(Accounts::Account*, quint64 value, QMailKey::Comparator op, const QMailAccountKey::ArgumentType::ValueList& arguments)
+{
+    // Argument list should not be empty.
+    // Otherwise we have nothing to compare.
+    Q_ASSERT(arguments.count());
+
+    if (arguments.count() == 1)
+    {
+        bool ok = false;
+        quint64 argument = arguments.front().toULongLong(&ok);
+        if (!ok)
+        {
+            qMailLog(Messaging) << "Failed to convert to quing64";
+            return false;
+        }
+
+        switch (op)
+        {
+            case QMailKey::LessThan:
+                return value < argument;
+
+            case QMailKey::LessThanEqual:
+                return value <= argument;
+
+            case QMailKey::GreaterThan:
+                return value > argument;
+
+            case QMailKey::GreaterThanEqual:
+                return value >= argument;
+
+            case QMailKey::Equal:
+                return value == argument;
+
+            case QMailKey::NotEqual:
+                return value != argument;
+
+            case QMailKey::Includes:
+            case QMailKey::Present:
+                return value & argument;
+
+            case QMailKey::Excludes:
+            case QMailKey::Absent:
+                return !(value & argument);
+
+            default:
+                Q_ASSERT(false);
+                break;
+        }
+
+    } else {
+
+        switch (op)
+        {
+            case QMailKey::LessThan:
+            case QMailKey::LessThanEqual:
+            case QMailKey::GreaterThan:
+            case QMailKey::GreaterThanEqual:
+            case QMailKey::Equal:
+            case QMailKey::NotEqual:
+                // This comparator is not supported for multiple integer arguments
+                Q_ASSERT(false);
+                break;
+
+            case QMailKey::Includes:
+            case QMailKey::Present:
+                foreach (const QVariant& argument, arguments)
+                {
+                    if (value == argument.toULongLong())
+                        return true;
+                }
+                return false;
+
+            case QMailKey::Excludes:
+            case QMailKey::Absent:
+                foreach (const QVariant& argument, arguments)
+                {
+                    if (value == argument.toULongLong())
+                        return false;
+                }
+                return true;
+
+            default:
+                Q_ASSERT(false);
+                break;
+        }
+
+    }
+    Q_ASSERT(false);
+    return false;
+}
+
+template <>
+bool SSOAccountCompareProperty(Accounts::Account*, const QString& value, QMailKey::Comparator op, const QMailAccountKey::ArgumentType::ValueList& arguments)
+{
+    // Argument list should not be empty.
+    // Otherwise we have nothing to compare.
+    Q_ASSERT(arguments.count());
+
+    if (arguments.count() == 1)
+    {
+        if (!arguments.front().canConvert<QString>())
+        {
+            qMailLog(Messaging) << "Failed to convert to string";
+            return false;
+        }
+
+        QString argument = arguments.front().toString();
+        switch (op)
+        {
+            case QMailKey::LessThan:
+                return value < argument;
+
+            case QMailKey::LessThanEqual:
+                return value <= argument;
+
+            case QMailKey::GreaterThan:
+                return value > argument;
+
+            case QMailKey::GreaterThanEqual:
+                return value >= argument;
+
+            case QMailKey::Equal:
+                return value == argument;
+
+            case QMailKey::NotEqual:
+                return value != argument;
+
+            case QMailKey::Includes:
+            case QMailKey::Present:
+                return value.contains(argument);
+
+            case QMailKey::Excludes:
+            case QMailKey::Absent:
+                return !value.contains(argument);
+
+            default:
+                Q_ASSERT(false);
+                break;
+        }
+
+    } else {
+
+        switch (op)
+        {
+            case QMailKey::LessThan:
+            case QMailKey::LessThanEqual:
+            case QMailKey::GreaterThan:
+            case QMailKey::GreaterThanEqual:
+            case QMailKey::Equal:
+            case QMailKey::NotEqual:
+                // This comparator is not supported for multiple integer arguments
+                Q_ASSERT(false);
+                break;
+
+            case QMailKey::Includes:
+            case QMailKey::Present:
+                foreach (const QVariant& argument, arguments)
+                {
+                    if (value == argument.toString())
+                        return true;
+                }
+                return false;
+
+            case QMailKey::Excludes:
+            case QMailKey::Absent:
+                foreach (const QVariant& argument, arguments)
+                {
+                    if (value == argument.toString())
+                        return false;
+                }
+                return true;
+
+            default:
+                Q_ASSERT(false);
+                break;
+        }
+
+    }
+    Q_ASSERT(false);
+    return false;
+}
+
+bool SSOAccountCompareProperty(Accounts::Account* ssoAccount, QMailKey::Comparator op, const QMailAccountKey::ArgumentType::ValueList& arguments)
+{
+    // Argument list should not be empty.
+    // Otherwise we have nothing to compare.
+    Q_ASSERT(arguments.count() == 1);
+
+    QStringList argument = arguments.front().toStringList();
+
+    QString key   = argument.front();
+    QString value = argument.count() == 2 ? argument.back() : QString();
+
+    ssoAccount->beginGroup("customFields");
+
+    bool result = false;
+    switch (op)
+    {
+        case QMailKey::LessThan:
+        case QMailKey::LessThanEqual:
+        case QMailKey::GreaterThan:
+        case QMailKey::GreaterThanEqual:
+            // This comparator is not supported for custom fields
+            Q_ASSERT(false);
+            break;
+
+        case QMailKey::Equal:
+            result = ssoAccount->contains(key) && (ssoAccount->valueAsString(key) == value);
+            break;
+
+        case QMailKey::NotEqual:
+            result = !ssoAccount->contains(key) || (ssoAccount->valueAsString(key) != value);
+            break;
+
+        case QMailKey::Includes:
+        case QMailKey::Present:
+            result = ssoAccount->contains(key) &&  ssoAccount->valueAsString(key).contains(value);
+            break;
+
+        case QMailKey::Excludes:
+        case QMailKey::Absent:
+            result = !(ssoAccount->contains(key) && ssoAccount->valueAsString(key).contains(value));
+            break;
+
+        default:
+            Q_ASSERT(false);
+            break;
+    }
+    ssoAccount->endGroup();
+    return result;
+}
+
+bool SSOAccountSatisfyTheProperty(Accounts::Account* ssoAccount, const QMailAccountKey::ArgumentType& argument)
+{
+    Q_ASSERT(ssoAccount);
+
+    switch (argument.property)
+    {
+        case QMailAccountKey::Id:
+            return SSOAccountCompareProperty<QMailAccountId>(ssoAccount, QMailAccountId(ssoAccount->id()), argument.op, argument.valueList);
+
+        case QMailAccountKey::Name:
+            return SSOAccountCompareProperty<const QString&>(ssoAccount, ssoAccount->displayName(), argument.op, argument.valueList);
+
+        case QMailAccountKey::MessageType:
+            return SSOAccountCompareProperty<quint64>(ssoAccount, ssoAccount->valueAsInt("type"), argument.op, argument.valueList);
+
+        case QMailAccountKey::FromAddress:
+            return SSOAccountCompareProperty<const QString&>(ssoAccount, QMailAddress(ssoAccount->valueAsString("emailaddress")).address(), argument.op, argument.valueList);
+
+        case QMailAccountKey::Status:
+            return SSOAccountCompareProperty<quint64>(ssoAccount, ssoAccount->valueAsUInt64("status"), argument.op, argument.valueList);
+
+        case QMailAccountKey::Custom:
+            return SSOAccountCompareProperty(ssoAccount, argument.op, argument.valueList);
+
+        default:
+            Q_ASSERT(false);
+            break;
+    }
+    return false;
+}
+
+bool SSOAccountSatisfyTheKey(Accounts::Account* ssoAccount, const QMailAccountKey& key)
+{
+    Q_ASSERT(ssoAccount);
+
+    if (key.isNonMatching())
+        return false;
+
+    if (key.isEmpty())
+        return true;
+
+    // In case of it is not compound key and has got a list of arguments
+    // follow the list of arguments and compare
+    if (!key.arguments().isEmpty())
+    {
+        typedef QList<QMailAccountKey::ArgumentType> ListOfArguments;
+        ListOfArguments::const_iterator it = key.arguments().begin();
+
+        bool result = SSOAccountSatisfyTheProperty(ssoAccount, *it);
+        while (++it != key.arguments().end())
+        {
+            switch (key.combiner())
+            {
+                case QMailKey::And:
+                    result = result && SSOAccountSatisfyTheProperty(ssoAccount, *it);
+                    break;
+                case QMailKey::Or:
+                    result = result || SSOAccountSatisfyTheProperty(ssoAccount, *it);
+                    break;
+                default:
+                    Q_ASSERT(false);
+                    break;
+            }
+        }
+
+        // Return negated value if key was negeated
+        return key.isNegated() ? !result : result;
+    }
+
+    // In case of compound key, process each subkey separatelly
+    if (!key.subKeys().isEmpty())
+    {
+        typedef QList<QMailAccountKey> ListOfKeys;
+        ListOfKeys::const_iterator it = key.subKeys().begin();
+
+        bool result = SSOAccountSatisfyTheKey(ssoAccount, *it);
+        while (++it != key.subKeys().end())
+        {
+            switch (key.combiner())
+            {
+                case QMailKey::And:
+                    result = result && SSOAccountSatisfyTheKey(ssoAccount, *it);
+                    break;
+                case QMailKey::Or:
+                    result = result || SSOAccountSatisfyTheKey(ssoAccount, *it);
+                    break;
+                default:
+                    Q_ASSERT(false);
+                    break;
+            }
+        }
+
+        // Return negated value if key was negeated
+        return key.isNegated() ? !result : result;
+    }
+
+    // This key is not empty and has neither subkeys nor arguments.
+    Q_ASSERT(false);
+    return false;
+}
+
 } // namespace
 
 
@@ -1833,7 +2190,7 @@ public:
 };
 
 QMailStorePrivate::Transaction::Transaction(QMailStorePrivate* d)
-    : m_d(d), 
+    : m_d(d),
       m_initted(false),
       m_committed(false)
 {
@@ -2014,19 +2371,19 @@ const QMailMessageKey::Properties &QMailStorePrivate::allMessageProperties()
     return p;
 }
 
-const QMailStorePrivate::MessagePropertyMap& QMailStorePrivate::messagePropertyMap() 
+const QMailStorePrivate::MessagePropertyMap& QMailStorePrivate::messagePropertyMap()
 {
     static const MessagePropertyMap map(::messagePropertyMap());
     return map;
 }
 
-const QMailStorePrivate::MessagePropertyList& QMailStorePrivate::messagePropertyList() 
+const QMailStorePrivate::MessagePropertyList& QMailStorePrivate::messagePropertyList()
 {
     static const MessagePropertyList list(messagePropertyMap().keys());
     return list;
 }
 
-const QString &QMailStorePrivate::defaultContentScheme() 
+const QString &QMailStorePrivate::defaultContentScheme()
 {
     static QString scheme(QMailContentManagerFactory::defaultScheme());
     return scheme;
@@ -2049,7 +2406,8 @@ QMailStorePrivate::QMailStorePrivate(QMailStore* parent)
       inTransaction(false),
       lastQueryError(0),
       mutex(0),
-      readLock(0)
+      readLock(0),
+      manager(new Accounts::Manager(this))
 {
     ProcessMutex creationMutex(QDir::rootPath());
     MutexGuard guard(creationMutex);
@@ -2103,9 +2461,6 @@ bool QMailStorePrivate::initStore()
 
         if (!ensureVersionInfo() ||
             !setupTables(QList<TableInfo>() << tableInfo("maintenancerecord", 100)
-                                            << tableInfo("mailaccounts", 106)
-                                            << tableInfo("mailaccountcustom", 100)
-                                            << tableInfo("mailaccountconfig", 100)
                                             << tableInfo("mailaccountfolders", 100)
                                             << tableInfo("mailfolders", 104)
                                             << tableInfo("mailfoldercustom", 100)
@@ -2138,7 +2493,7 @@ bool QMailStorePrivate::initStore()
 
 #if defined(Q_USE_SQLITE)
     // default sqlite cache_size of 2000*1.5KB is too large, as we only want
-    // to cache 100 metadata records 
+    // to cache 100 metadata records
     QSqlQuery query( database );
     query.exec(QLatin1String("PRAGMA cache_size=50"));
 #endif
@@ -2166,6 +2521,22 @@ void QMailStorePrivate::clearContent()
 
     Transaction t(this);
 
+    // Remove all SSO email accounts
+    Accounts::AccountIdList accountIDList = manager->accountList("e-mail");
+
+    // Populate all E-Mail accounts
+    foreach (Accounts::AccountId accountID, accountIDList)
+    {
+        Accounts::Account* ssoAccount = manager->account(accountID);
+        Q_ASSERT(ssoAccount);
+
+        // Remove account
+        ssoAccount->remove();
+        ssoAccount->syncAndBlock();
+
+        delete ssoAccount;
+    }
+
     // Drop all data
     foreach (const QString &table, database.tables()) {
         if (table != "versioninfo" && table != "mailstatusflags") {
@@ -2253,7 +2624,7 @@ QSqlQuery QMailStorePrivate::prepare(const QString& sql)
 
             {
                 QSqlQuery createQuery(database);
-                if (!createQuery.exec(QString("CREATE TEMP TABLE %1 ( id %2 PRIMARY KEY )").arg(tableName).arg(key.second))) { 
+                if (!createQuery.exec(QString("CREATE TEMP TABLE %1 ( id %2 PRIMARY KEY )").arg(tableName).arg(key.second))) {
                     setQueryError(createQuery.lastError(), "Failed to create temporary table", queryText(createQuery));
                     qMailLog(Messaging) << "Unable to prepare query:" << sql;
                     return QSqlQuery();
@@ -2280,13 +2651,13 @@ QSqlQuery QMailStorePrivate::prepare(const QString& sql)
 
                     switch (type) {
                     case 1:
-                        id = var.value<QMailMessageId>().toULongLong(); 
+                        id = var.value<QMailMessageId>().toULongLong();
                         break;
                     case 2:
-                        id = var.value<QMailFolderId>().toULongLong(); 
+                        id = var.value<QMailFolderId>().toULongLong();
                         break;
                     case 3:
-                        id = var.value<QMailAccountId>().toULongLong(); 
+                        id = var.value<QMailAccountId>().toULongLong();
                         break;
                     default:
                         qMailLog(Messaging) << "Unable to extract ID value from valuelist!";
@@ -2302,7 +2673,7 @@ QSqlQuery QMailStorePrivate::prepare(const QString& sql)
                     QSqlQuery insertQuery(database);
                     insertQuery.prepare(QString("INSERT INTO %1 VALUES (?)").arg(tableName));
                     insertQuery.addBindValue(idValues);
-                    if (!insertQuery.execBatch()) { 
+                    if (!insertQuery.execBatch()) {
                         setQueryError(insertQuery.lastError(), "Failed to populate integer temporary table", queryText(insertQuery));
                         qMailLog(Messaging) << "Unable to prepare query:" << sql;
                         return QSqlQuery();
@@ -2317,7 +2688,7 @@ QSqlQuery QMailStorePrivate::prepare(const QString& sql)
                     QSqlQuery insertQuery(database);
                     insertQuery.prepare(QString("INSERT INTO %1 VALUES (?)").arg(tableName));
                     insertQuery.addBindValue(idValues);
-                    if (!insertQuery.execBatch()) { 
+                    if (!insertQuery.execBatch()) {
                         setQueryError(insertQuery.lastError(), "Failed to populate varchar temporary table", queryText(insertQuery));
                         qMailLog(Messaging) << "Unable to prepare query:" << sql;
                         return QSqlQuery();
@@ -2344,7 +2715,7 @@ bool QMailStorePrivate::execute(QSqlQuery& query, bool batch)
         return false;
     }
 
-#ifdef QMAILSTORE_LOG_SQL 
+#ifdef QMAILSTORE_LOG_SQL
     qMailLog(Messaging) << "(" << pid << ")" << qPrintable(queryText(query));
 #endif
 
@@ -2363,7 +2734,7 @@ bool QMailStorePrivate::commit(void)
         qMailLog(Messaging) << "(" << pid << ")" << "Transaction does not exist at commit!";
         qWarning() << "Transaction does not exist at commit!";
     }
-    
+
     if (!database.commit()) {
         setQueryError(database.lastError(), "Failed to commit transaction");
         return false;
@@ -2384,7 +2755,7 @@ void QMailStorePrivate::rollback(void)
         qMailLog(Messaging) << "(" << pid << ")" << "Transaction does not exist at rollback!";
         qWarning() << "Transaction does not exist at rollback!";
     }
-    
+
     inTransaction = false;
 
     if (!database.rollback()) {
@@ -2412,7 +2783,7 @@ void QMailStorePrivate::setQueryError(const QSqlError &error, const QString &des
     qWarning() << qPrintable(s);
 }
 
-void QMailStorePrivate::clearQueryError(void) 
+void QMailStorePrivate::clearQueryError(void)
 {
     lastQueryError = QSqlError::NoError;
 }
@@ -2476,9 +2847,10 @@ bool QMailStorePrivate::idValueExists(quint64 id, const QString& table)
     return (query.first());
 }
 
-bool QMailStorePrivate::idExists(const QMailAccountId& id, const QString& table)
+bool QMailStorePrivate::idExists(const QMailAccountId& id)
 {
-    return idValueExists(id.toULongLong(), (table.isEmpty() ? "mailaccounts" : table));
+    QSharedPointer<Accounts::Account> ssoAccount(manager->account(id.toULongLong()));
+    return (ssoAccount != NULL);
 }
 
 bool QMailStorePrivate::idExists(const QMailFolderId& id, const QString& table)
@@ -2491,17 +2863,17 @@ bool QMailStorePrivate::idExists(const QMailMessageId& id, const QString& table)
     return idValueExists(id.toULongLong(), (table.isEmpty() ? "mailmessages" : table));
 }
 
-QMailAccount QMailStorePrivate::extractAccount(const QSqlRecord& r)
+QMailAccount QMailStorePrivate::extractAccount(const QSharedPointer<Accounts::Account>& ssoAccount)
 {
-    const AccountRecord record(r);
+    Q_ASSERT(ssoAccount);
 
     QMailAccount result;
-    result.setId(record.id());
-    result.setName(record.name());
-    result.setMessageType(record.messageType());
-    result.setStatus(record.status());
-    result.setSignature(record.signature());
-    result.setFromAddress(QMailAddress(record.fromAddress()));
+    result.setId(QMailAccountId(ssoAccount->id()));
+    result.setName(ssoAccount->displayName());
+    result.setMessageType(static_cast<QMailMessageMetaDataFwd::MessageType>(ssoAccount->valueAsInt("type")));
+    result.setStatus(ssoAccount->valueAsUInt64("status"));
+    result.setSignature(ssoAccount->valueAsString("signature"));
+    result.setFromAddress(QMailAddress(ssoAccount->valueAsString("emailaddress")));
 
     return result;
 }
@@ -2612,7 +2984,7 @@ void QMailStorePrivate::extractMessageMetaData(const QSqlRecord& r,
                 break;
         }
     }
-    
+
     if (unloadedProperties) {
         // This message is not completely loaded
         metaData->setStatus(QMailMessage::UnloadedData, true);
@@ -2660,7 +3032,7 @@ QMailMessage QMailStorePrivate::extractMessage(const QSqlRecord& r, const QMap<Q
         if (!lock.lock(1000)) {
             qMailLog(Messaging) << "Unable to acquire message body mutex in extractMessage!";
             return QMailMessage();
-        } 
+        }
 
         QMailContentManager *contentManager = QMailContentManagerFactory::create(elements.first);
         if (contentManager) {
@@ -2703,9 +3075,10 @@ QString QMailStorePrivate::buildOrderClause(const Key& key) const
         const QMailFolderSortKey &sortKey(key.key<QMailFolderSortKey>());
         return ::buildOrderClause(sortKey.arguments(), key.alias());
     } else if (key.isType<QMailAccountSortKey>()) {
-        const QMailAccountSortKey &sortKey(key.key<QMailAccountSortKey>());
-        return ::buildOrderClause(sortKey.arguments(), key.alias());
-    } 
+        Q_ASSERT(false);
+        //const QMailAccountSortKey &sortKey(key.key<QMailAccountSortKey>());
+        //return ::buildOrderClause(sortKey.arguments(), key.alias());
+    }
 
     return QString();
 }
@@ -2747,7 +3120,7 @@ QVariantList QMailStorePrivate::whereClauseValues(const Key& key) const
     } else if (key.isType<QMailAccountKey>()) {
         const QMailAccountKey &accountKey(key.key<QMailAccountKey>());
         return ::whereClauseValues(accountKey);
-    } 
+    }
 
     return QVariantList();
 }
@@ -2962,7 +3335,7 @@ bool QMailStorePrivate::executeFile(QFile &file)
     QTextStream ts(&file);
     ts.setCodec(QTextCodec::codecForName("utf8"));
     ts.setAutoDetectUnicode(true);
-    
+
     QString sql = parseSql(ts);
     while (result && !sql.isEmpty()) {
         QSqlQuery query(database);
@@ -3125,7 +3498,7 @@ bool QMailStorePrivate::setupTables(const QList<TableInfo> &tableList)
             }
         }
     }
-        
+
     return result;
 }
 
@@ -3134,7 +3507,7 @@ bool QMailStorePrivate::setupFolders(const QList<FolderInfo> &folderList)
     QSet<quint64> folderIds;
 
     {
-        QSqlQuery query(simpleQuery("SELECT id FROM mailfolders", 
+        QSqlQuery query(simpleQuery("SELECT id FROM mailfolders",
                                     "folder ids query"));
         if (query.lastError().type() != QSqlError::NoError)
             return false;
@@ -3297,8 +3670,8 @@ QString QMailStorePrivate::parseSql(QTextStream& ts)
         if (line.trimmed ().length () == 0)
             continue;
         qry += line;
-        
-        if ( line.contains( ';' ) == false) 
+
+        if ( line.contains( ';' ) == false)
             qry += QLatin1String(" ");
         else
             return qry;
@@ -3327,7 +3700,7 @@ QString QMailStorePrivate::expandValueList(int valueCount)
     }
 }
 
-QString QMailStorePrivate::expandProperties(const QMailMessageKey::Properties& prop, bool update) const 
+QString QMailStorePrivate::expandProperties(const QMailMessageKey::Properties& prop, bool update) const
 {
     QString out;
 
@@ -3340,7 +3713,7 @@ QString QMailStorePrivate::expandProperties(const QMailMessageKey::Properties& p
     foreach (QMailMessageKey::Property p, messagePropertyList()) {
         if (properties & p) {
             if (!out.isEmpty())
-                out += ",";                     
+                out += ",";
             out += map.value(p);
             if (update)
                 out += "=?";
@@ -3353,18 +3726,18 @@ QString QMailStorePrivate::expandProperties(const QMailMessageKey::Properties& p
 bool QMailStorePrivate::addAccount(QMailAccount *account, QMailAccountConfiguration *config,
                                    QMailAccountIdList *addedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptAddAccount, this, 
-                                        account, config, 
-                                        addedAccountIds), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptAddAccount, this,
+                                        account, config,
+                                        addedAccountIds),
                                    "addAccount");
 }
 
 bool QMailStorePrivate::addFolder(QMailFolder *folder,
                                   QMailFolderIdList *addedFolderIds, QMailAccountIdList *modifiedAccountIds)
-{   
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptAddFolder, this, 
-                                        folder, 
-                                        addedFolderIds, modifiedAccountIds), 
+{
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptAddFolder, this,
+                                        folder,
+                                        addedFolderIds, modifiedAccountIds),
                                    "addFolder");
 }
 
@@ -3388,9 +3761,9 @@ bool QMailStorePrivate::addMessages(const QList<QMailMessage *> &messages,
             }
         }
 
-        if (!repeatedly<WriteAccess>(bind(func, this, 
+        if (!repeatedly<WriteAccess>(bind(func, this,
                                           message, cref(identifier), cref(references),
-                                          addedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds), 
+                                          addedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds),
                                      "addMessages",
                                      &t)) {
             return false;
@@ -3435,9 +3808,9 @@ bool QMailStorePrivate::addMessages(const QList<QMailMessageMetaData *> &message
         QString identifier;
         QStringList references;
 
-        if (!repeatedly<WriteAccess>(bind(func, this, 
+        if (!repeatedly<WriteAccess>(bind(func, this,
                                           metaData, cref(identifier), cref(references),
-                                          addedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds), 
+                                          addedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds),
                                      "addMessages",
                                      &t)) {
             return false;
@@ -3455,54 +3828,54 @@ bool QMailStorePrivate::addMessages(const QList<QMailMessageMetaData *> &message
 bool QMailStorePrivate::removeAccounts(const QMailAccountKey &key,
                                        QMailAccountIdList *deletedAccountIds, QMailFolderIdList *deletedFolderIds, QMailMessageIdList *deletedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRemoveAccounts, this, 
-                                        cref(key), 
-                                        deletedAccountIds, deletedFolderIds, deletedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRemoveAccounts, this,
+                                        cref(key),
+                                        deletedAccountIds, deletedFolderIds, deletedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds),
                                    "removeAccounts");
 }
 
 bool QMailStorePrivate::removeFolders(const QMailFolderKey &key, QMailStore::MessageRemovalOption option,
                                       QMailFolderIdList *deletedFolderIds, QMailMessageIdList *deletedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRemoveFolders, this, 
-                                        cref(key), option, 
-                                        deletedFolderIds, deletedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRemoveFolders, this,
+                                        cref(key), option,
+                                        deletedFolderIds, deletedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds),
                                    "removeFolders");
 }
 
 bool QMailStorePrivate::removeMessages(const QMailMessageKey &key, QMailStore::MessageRemovalOption option,
                                        QMailMessageIdList *deletedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRemoveMessages, this, 
-                                        cref(key), option, 
-                                        deletedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRemoveMessages, this,
+                                        cref(key), option,
+                                        deletedMessageIds, updatedMessageIds, modifiedFolderIds, modifiedAccountIds),
                                    "removeMessages");
 }
 
 bool QMailStorePrivate::updateAccount(QMailAccount *account, QMailAccountConfiguration *config,
                                       QMailAccountIdList *updatedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateAccount, this, 
-                                        account, config, 
-                                        updatedAccountIds), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateAccount, this,
+                                        account, config,
+                                        updatedAccountIds),
                                    "updateAccount");
 }
 
 bool QMailStorePrivate::updateAccountConfiguration(QMailAccountConfiguration *config,
                                                    QMailAccountIdList *updatedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateAccount, this, 
-                                        reinterpret_cast<QMailAccount*>(0), config, 
-                                        updatedAccountIds), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateAccount, this,
+                                        reinterpret_cast<QMailAccount*>(0), config,
+                                        updatedAccountIds),
                                    "updateAccount");
 }
 
 bool QMailStorePrivate::updateFolder(QMailFolder *folder,
                                      QMailFolderIdList *updatedFolderIds, QMailAccountIdList *modifiedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateFolder, this, 
-                                        folder, 
-                                        updatedFolderIds, modifiedAccountIds), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateFolder, this,
+                                        folder,
+                                        updatedFolderIds, modifiedAccountIds),
                                    "updateFolder");
 }
 
@@ -3516,9 +3889,9 @@ bool QMailStorePrivate::updateMessages(const QList<QPair<QMailMessageMetaData*,
     typedef QPair<QMailMessageMetaData*, QMailMessage*> PairType;
 
     foreach (const PairType &pair, messages) {
-        if (!repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateMessage, this, 
+        if (!repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateMessage, this,
                                           pair.first, pair.second,
-                                          updatedMessageIds, modifiedMessageIds, modifiedFolderIds, modifiedAccountIds), 
+                                          updatedMessageIds, modifiedMessageIds, modifiedFolderIds, modifiedAccountIds),
                                      "updateMessages",
                                      &t)) {
             return false;
@@ -3554,42 +3927,42 @@ bool QMailStorePrivate::updateMessages(const QList<QPair<QMailMessageMetaData*,
 bool QMailStorePrivate::updateMessagesMetaData(const QMailMessageKey &key, const QMailMessageKey::Properties &properties, const QMailMessageMetaData &data,
                                                QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateMessagesMetaData, this, 
-                                        cref(key), cref(properties), cref(data), 
-                                        updatedMessageIds, modifiedFolderIds, modifiedAccountIds), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateMessagesMetaData, this,
+                                        cref(key), cref(properties), cref(data),
+                                        updatedMessageIds, modifiedFolderIds, modifiedAccountIds),
                                    "updateMessagesMetaData");
 }
 
 bool QMailStorePrivate::updateMessagesMetaData(const QMailMessageKey &key, quint64 status, bool set,
                                                QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateMessagesStatus, this, 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptUpdateMessagesStatus, this,
                                         cref(key), status, set,
-                                        updatedMessageIds, modifiedFolderIds, modifiedAccountIds), 
+                                        updatedMessageIds, modifiedFolderIds, modifiedAccountIds),
                                    "updateMessagesMetaData"); // not 'updateMessagesStatus', due to function name exported by QMailStore
 }
 
 bool QMailStorePrivate::restoreToPreviousFolder(const QMailMessageKey &key,
                                                 QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRestoreToPreviousFolder, this, 
-                                        cref(key), 
-                                        updatedMessageIds, modifiedFolderIds, modifiedAccountIds), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRestoreToPreviousFolder, this,
+                                        cref(key),
+                                        updatedMessageIds, modifiedFolderIds, modifiedAccountIds),
                                    "restoreToPreviousFolder");
 }
 
 bool QMailStorePrivate::purgeMessageRemovalRecords(const QMailAccountId &accountId, const QStringList &serverUids)
 {
-    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptPurgeMessageRemovalRecords, this, 
-                                        cref(accountId), cref(serverUids)), 
+    return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptPurgeMessageRemovalRecords, this,
+                                        cref(accountId), cref(serverUids)),
                                    "purgeMessageRemovalRecords");
 }
 
 int QMailStorePrivate::countAccounts(const QMailAccountKey &key) const
 {
     int result(0);
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptCountAccounts, const_cast<QMailStorePrivate*>(this), 
-                                cref(key), &result), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptCountAccounts, const_cast<QMailStorePrivate*>(this),
+                                cref(key), &result),
                            "countAccounts");
     return result;
 }
@@ -3597,8 +3970,8 @@ int QMailStorePrivate::countAccounts(const QMailAccountKey &key) const
 int QMailStorePrivate::countFolders(const QMailFolderKey &key) const
 {
     int result(0);
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptCountFolders, const_cast<QMailStorePrivate*>(this), 
-                                cref(key), &result), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptCountFolders, const_cast<QMailStorePrivate*>(this),
+                                cref(key), &result),
                            "countFolders");
     return result;
 }
@@ -3606,8 +3979,8 @@ int QMailStorePrivate::countFolders(const QMailFolderKey &key) const
 int QMailStorePrivate::countMessages(const QMailMessageKey &key) const
 {
     int result(0);
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptCountMessages, const_cast<QMailStorePrivate*>(this), 
-                                cref(key), &result), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptCountMessages, const_cast<QMailStorePrivate*>(this),
+                                cref(key), &result),
                            "countMessages");
     return result;
 }
@@ -3615,8 +3988,8 @@ int QMailStorePrivate::countMessages(const QMailMessageKey &key) const
 int QMailStorePrivate::sizeOfMessages(const QMailMessageKey &key) const
 {
     int result(0);
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptSizeOfMessages, const_cast<QMailStorePrivate*>(this), 
-                                cref(key), &result), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptSizeOfMessages, const_cast<QMailStorePrivate*>(this),
+                                cref(key), &result),
                            "sizeOfMessages");
     return result;
 }
@@ -3624,8 +3997,8 @@ int QMailStorePrivate::sizeOfMessages(const QMailMessageKey &key) const
 QMailAccountIdList QMailStorePrivate::queryAccounts(const QMailAccountKey &key, const QMailAccountSortKey &sortKey, uint limit, uint offset) const
 {
     QMailAccountIdList ids;
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptQueryAccounts, const_cast<QMailStorePrivate*>(this), 
-                                cref(key), cref(sortKey), limit, offset, &ids), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptQueryAccounts, const_cast<QMailStorePrivate*>(this),
+                                cref(key), cref(sortKey), limit, offset, &ids),
                            "queryAccounts");
     return ids;
 }
@@ -3633,8 +4006,8 @@ QMailAccountIdList QMailStorePrivate::queryAccounts(const QMailAccountKey &key,
 QMailFolderIdList QMailStorePrivate::queryFolders(const QMailFolderKey &key, const QMailFolderSortKey &sortKey, uint limit, uint offset) const
 {
     QMailFolderIdList ids;
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptQueryFolders, const_cast<QMailStorePrivate*>(this), 
-                                cref(key), cref(sortKey), limit, offset, &ids), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptQueryFolders, const_cast<QMailStorePrivate*>(this),
+                                cref(key), cref(sortKey), limit, offset, &ids),
                            "queryFolders");
     return ids;
 }
@@ -3642,8 +4015,8 @@ QMailFolderIdList QMailStorePrivate::queryFolders(const QMailFolderKey &key, con
 QMailMessageIdList QMailStorePrivate::queryMessages(const QMailMessageKey &key, const QMailMessageSortKey &sortKey, uint limit, uint offset) const
 {
     QMailMessageIdList ids;
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptQueryMessages, const_cast<QMailStorePrivate*>(this), 
-                                cref(key), cref(sortKey), limit, offset, &ids), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptQueryMessages, const_cast<QMailStorePrivate*>(this),
+                                cref(key), cref(sortKey), limit, offset, &ids),
                            "queryMessages");
     return ids;
 }
@@ -3654,8 +4027,8 @@ QMailAccount QMailStorePrivate::account(const QMailAccountId &id) const
         return accountCache.lookup(id);
 
     QMailAccount account;
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptAccount, const_cast<QMailStorePrivate*>(this), 
-                                cref(id), &account), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptAccount, const_cast<QMailStorePrivate*>(this),
+                                cref(id), &account),
                            "account");
     return account;
 }
@@ -3663,8 +4036,8 @@ QMailAccount QMailStorePrivate::account(const QMailAccountId &id) const
 QMailAccountConfiguration QMailStorePrivate::accountConfiguration(const QMailAccountId &id) const
 {
     QMailAccountConfiguration config;
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptAccountConfiguration, const_cast<QMailStorePrivate*>(this), 
-                                cref(id), &config), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptAccountConfiguration, const_cast<QMailStorePrivate*>(this),
+                                cref(id), &config),
                            "accountConfiguration");
     return config;
 }
@@ -3675,8 +4048,8 @@ QMailFolder QMailStorePrivate::folder(const QMailFolderId &id) const
         return folderCache.lookup(id);
 
     QMailFolder folder;
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptFolder, const_cast<QMailStorePrivate*>(this), 
-                                cref(id), &folder), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptFolder, const_cast<QMailStorePrivate*>(this),
+                                cref(id), &folder),
                            "folder");
     return folder;
 }
@@ -3687,8 +4060,8 @@ QMailMessage QMailStorePrivate::message(const QMailMessageId &id) const
     AttemptResult (QMailStorePrivate::*func)(const QMailMessageId&, QMailMessage*, ReadLock&) = &QMailStorePrivate::attemptMessage;
 
     QMailMessage msg;
-    repeatedly<ReadAccess>(bind(func, const_cast<QMailStorePrivate*>(this), 
-                                cref(id), &msg), 
+    repeatedly<ReadAccess>(bind(func, const_cast<QMailStorePrivate*>(this),
+                                cref(id), &msg),
                            "message(id)");
     return msg;
 }
@@ -3699,8 +4072,8 @@ QMailMessage QMailStorePrivate::message(const QString &uid, const QMailAccountId
     AttemptResult (QMailStorePrivate::*func)(const QString&, const QMailAccountId&, QMailMessage*, ReadLock&) = &QMailStorePrivate::attemptMessage;
 
     QMailMessage msg;
-    repeatedly<ReadAccess>(bind(func, const_cast<QMailStorePrivate*>(this), 
-                                cref(uid), cref(accountId), &msg), 
+    repeatedly<ReadAccess>(bind(func, const_cast<QMailStorePrivate*>(this),
+                                cref(uid), cref(accountId), &msg),
                            "message(uid, accountId)");
     return msg;
 }
@@ -3732,15 +4105,15 @@ QMailMessageMetaData QMailStorePrivate::messageMetaData(const QString &uid, cons
         // Resolve from overloaded member functions:
         AttemptResult (QMailStorePrivate::*func)(const QMailMessageId&, QMailMessageMetaData*, ReadLock&) = &QMailStorePrivate::attemptMessageMetaData;
 
-        success = repeatedly<ReadAccess>(bind(func, const_cast<QMailStorePrivate*>(this), 
-                                              cref(id), &metaData), 
+        success = repeatedly<ReadAccess>(bind(func, const_cast<QMailStorePrivate*>(this),
+                                              cref(id), &metaData),
                                          "messageMetaData(id)");
     } else {
         // Resolve from overloaded member functions:
         AttemptResult (QMailStorePrivate::*func)(const QString&, const QMailAccountId&, QMailMessageMetaData*, ReadLock&) = &QMailStorePrivate::attemptMessageMetaData;
 
-        success = repeatedly<ReadAccess>(bind(func, const_cast<QMailStorePrivate*>(this), 
-                                              cref(uid), cref(accountId), &metaData), 
+        success = repeatedly<ReadAccess>(bind(func, const_cast<QMailStorePrivate*>(this),
+                                              cref(uid), cref(accountId), &metaData),
                                          "messageMetaData(uid/accountId)");
     }
 
@@ -3755,8 +4128,8 @@ QMailMessageMetaData QMailStorePrivate::messageMetaData(const QString &uid, cons
 QMailMessageMetaDataList QMailStorePrivate::messagesMetaData(const QMailMessageKey &key, const QMailMessageKey::Properties &properties, QMailStore::ReturnOption option) const
 {
     QMailMessageMetaDataList metaData;
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptMessagesMetaData, const_cast<QMailStorePrivate*>(this), 
-                                cref(key), cref(properties), option, &metaData), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptMessagesMetaData, const_cast<QMailStorePrivate*>(this),
+                                cref(key), cref(properties), option, &metaData),
                            "messagesMetaData");
     return metaData;
 }
@@ -3764,8 +4137,8 @@ QMailMessageMetaDataList QMailStorePrivate::messagesMetaData(const QMailMessageK
 QMailMessageRemovalRecordList QMailStorePrivate::messageRemovalRecords(const QMailAccountId &accountId, const QMailFolderId &folderId) const
 {
     QMailMessageRemovalRecordList removalRecords;
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptMessageRemovalRecords, const_cast<QMailStorePrivate*>(this), 
-                                cref(accountId), cref(folderId), &removalRecords), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptMessageRemovalRecords, const_cast<QMailStorePrivate*>(this),
+                                cref(accountId), cref(folderId), &removalRecords),
                            "messageRemovalRecords(accountId, folderId)");
     return removalRecords;
 }
@@ -3777,7 +4150,7 @@ bool QMailStorePrivate::registerAccountStatusFlag(const QString &name)
 
     static const QString context("accountstatus");
     return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRegisterStatusBit, this,
-                                        cref(name), cref(context), 64), 
+                                        cref(name), cref(context), 64),
                                    "registerAccountStatusBit");
 }
 
@@ -3796,7 +4169,7 @@ bool QMailStorePrivate::registerFolderStatusFlag(const QString &name)
 
     static const QString context("folderstatus");
     return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRegisterStatusBit, this,
-                                        cref(name), cref(context), 64), 
+                                        cref(name), cref(context), 64),
                                    "registerFolderStatusBit");
 }
 
@@ -3815,7 +4188,7 @@ bool QMailStorePrivate::registerMessageStatusFlag(const QString &name)
 
     static const QString context("messagestatus");
     return repeatedly<WriteAccess>(bind(&QMailStorePrivate::attemptRegisterStatusBit, this,
-                                        cref(name), cref(context), 64), 
+                                        cref(name), cref(context), 64),
                                    "registerMessageStatusBit");
 }
 
@@ -3834,8 +4207,8 @@ quint64 QMailStorePrivate::queryStatusMap(const QString &name, const QString &co
         return it.value();
 
     int result(0);
-    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptStatusBit, const_cast<QMailStorePrivate*>(this), 
-                                cref(name), cref(context), &result), 
+    repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptStatusBit, const_cast<QMailStorePrivate*>(this),
+                                cref(name), cref(context), &result),
                            "folderStatusMask");
     if (result == 0)
         return 0;
@@ -3856,7 +4229,7 @@ QMailFolderIdList QMailStorePrivate::folderAncestorIds(const QMailFolderIdList&
         *result = self->attemptFolderAncestorIds(ids, &ancestorIds, l);
     } else {
         bool ok = repeatedly<ReadAccess>(bind(&QMailStorePrivate::attemptFolderAncestorIds, self,
-                                              cref(ids), &ancestorIds), 
+                                              cref(ids), &ancestorIds),
                                          "folderAncestorIds");
         if (result)
             *result = ok ? Success : Failure;
@@ -3939,7 +4312,7 @@ bool QMailStorePrivate::repeatedly(FunctionType func, const QString &description
                 setLastError(errorType(AccessType()));
             }
             return false;
-        } else { 
+        } else {
             // result == DatabaseFailure
             if (queryError() == Sqlite3BusyErrorNumber) {
                 if (attemptCount < MaxAttempts) {
@@ -3973,6 +4346,110 @@ bool QMailStorePrivate::repeatedly(FunctionType func, const QString &description
     return false;
 }
 
+QMailStorePrivate::AttemptResult QMailStorePrivate::addAccountCustomFields(QSharedPointer<Accounts::Account>& ssoAccount, const QMap<QString, QString>& fields)
+{
+    if (!fields.isEmpty())
+    {
+        ssoAccount->beginGroup("customFields");
+
+        // Insert any custom fields belonging to this account
+        QMap<QString, QString>::const_iterator it = fields.begin(), end = fields.end();
+        for ( ; it != end; ++it) {
+            ssoAccount->setValue(it.key(), QVariant(it.value()));
+        }
+        ssoAccount->endGroup();
+
+        if (!ssoAccount->syncAndBlock())
+            return DatabaseFailure;
+    }
+
+    return Success;
+}
+
+QMailStorePrivate::AttemptResult QMailStorePrivate::updateAccountCustomFields(QSharedPointer<Accounts::Account>& ssoAccount, const QMap<QString, QString> &fields)
+{
+    ssoAccount->beginGroup("customFields");
+
+    QMap<QString, QString> existing;
+    {
+        foreach (const QString& name, ssoAccount->allKeys())
+        {
+             existing.insert(name, ssoAccount->valueAsString(name));
+        }
+    }
+
+    QVariantList obsoleteFields;
+    QVariantList modifiedFields;
+    QVariantList modifiedValues;
+    QVariantList addedFields;
+    QVariantList addedValues;
+
+    // Compare the sets
+    QMap<QString, QString>::const_iterator fend = fields.end(), eend = existing.end();
+    QMap<QString, QString>::const_iterator it = existing.begin();
+    for ( ; it != eend; ++it) {
+        QMap<QString, QString>::const_iterator current = fields.find(it.key());
+        if (current == fend) {
+            obsoleteFields.append(QVariant(it.key()));
+        } else if (*current != *it) {
+            modifiedFields.append(QVariant(current.key()));
+            modifiedValues.append(QVariant(current.value()));
+        }
+    }
+
+    for (it = fields.begin(); it != fend; ++it) {
+        if (existing.find(it.key()) == eend) {
+            addedFields.append(QVariant(it.key()));
+            addedValues.append(QVariant(it.value()));
+        }
+    }
+
+    if (!obsoleteFields.isEmpty()) {
+        // Remove the obsolete fields
+        foreach (const QVariant& obsolet, obsoleteFields)
+        {
+            ssoAccount->remove(obsolet.toString());
+        }
+    }
+
+    if (!modifiedFields.isEmpty()) {
+        // Batch update of the modified fields
+        QVariantList::const_iterator field = modifiedFields.begin();
+        QVariantList::const_iterator value = modifiedValues.begin();
+        while (field != modifiedFields.end() && value != modifiedValues.end())
+            ssoAccount->setValue(field++->toString(), *value++);
+    }
+
+    if (!addedFields.isEmpty()) {
+        // Batch insert of the added fields
+        QVariantList::const_iterator field = addedFields.begin();
+        QVariantList::const_iterator value = addedValues.begin();
+        while (field != addedFields.end() && value != addedValues.end())
+            ssoAccount->setValue(field++->toString(), *value++);
+
+    }
+
+    ssoAccount->endGroup();
+    if (!ssoAccount->syncAndBlock())
+        return DatabaseFailure;
+
+    return Success;
+}
+
+QMailStorePrivate::AttemptResult QMailStorePrivate::accountCustomFields(QSharedPointer<Accounts::Account>& ssoAccount, QMap<QString, QString>* fields)
+{
+    qMailLog(Messaging) << "Load custom fields";
+    ssoAccount->beginGroup("customFields");
+    foreach (const QString& key, ssoAccount->allKeys())
+    {
+        qMailLog(Messaging) << "Custom Field:" << key << "=" << ssoAccount->valueAsString(key);
+        fields->insert(key, ssoAccount->valueAsString(key));
+    }
+    ssoAccount->endGroup();
+
+    return Success;
+}
+
 QMailStorePrivate::AttemptResult QMailStorePrivate::addCustomFields(quint64 id, const QMap<QString, QString> &fields, const QString &tableName)
 {
     if (!fields.isEmpty()) {
@@ -4092,8 +4569,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::customFields(quint64 id, QMa
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddAccount(QMailAccount *account, QMailAccountConfiguration* config, 
-                                                                      QMailAccountIdList *addedAccountIds, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddAccount(QMailAccount *account, QMailAccountConfiguration* config,
+                                                                      QMailAccountIdList *addedAccountIds,
                                                                       Transaction &t, bool commitOnSuccess)
 {
     if (account->id().isValid() && idExists(account->id())) {
@@ -4101,29 +4578,40 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddAccount(QMailAccou
         return Failure;
     }
 
-    QMailAccountId insertId;
+    // Create new account in Accounts subsystem
+    QSharedPointer<Accounts::Account> ssoAccount(manager->createAccount("GenericProvider"));
+    if (!ssoAccount)
+    {
+        qMailLog(Messaging) << "Failed to create account";
+        return DatabaseFailure;
+    }
 
+    ssoAccount->setDisplayName(account->name());
+    ssoAccount->setEnabled(account->status() & QMailAccount::Enabled);
+
+    Accounts::ServiceList services = ssoAccount->services("e-mail");
+    if (!services.count())
     {
-        QString properties("type,name,status,signature,emailaddress");
-        QString values("?,?,?,?,?");
-        QVariantList propertyValues;
-        propertyValues << static_cast<int>(account->messageType()) 
-                       << account->name() 
-                       << account->status()
-                       << account->signature()
-                       << account->fromAddress().toString(true);
+        qMailLog(Messaging) << "Services not found, make sure that *.service and *.provider files are properly installed.";
+        return DatabaseFailure;
+    }
 
-        {
-            QSqlQuery query(simpleQuery(QString("INSERT INTO mailaccounts (%1) VALUES (%2)").arg(properties).arg(values),
-                                        propertyValues,
-                                        "addAccount mailaccounts query"));
-            if (query.lastError().type() != QSqlError::NoError)
-                return DatabaseFailure;
+    Accounts::Service* service = services.first();
+    Q_ASSERT(service);
+    ssoAccount->selectService(service);
 
-            //Extract the insert id
-            insertId = QMailAccountId(extractValue<quint64>(query.lastInsertId()));
-        }
+    ssoAccount->setValue("type", static_cast<int>(account->messageType()));
+    ssoAccount->setValue("status", account->status());
+    ssoAccount->setValue("signature", account->signature());
+    ssoAccount->setValue("emailaddress", account->fromAddress().toString(true));
+
+    if (!ssoAccount->syncAndBlock())
+        return DatabaseFailure;
 
+    // Extract the id
+    QMailAccountId insertId = QMailAccountId(ssoAccount->id());
+
+    {
         // Insert any standard folders configured for this account
         const QMap<QMailFolder::StandardFolder, QMailFolderId> &folders(account->standardFolders());
         if (!folders.isEmpty()) {
@@ -4143,38 +4631,48 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddAccount(QMailAccou
                                                       << QVariant(folderIds),
                                        "addAccount mailaccountfolders query"));
             if (query.lastError().type() != QSqlError::NoError)
+            {
+                ssoAccount->remove();
+                ssoAccount->syncAndBlock();
                 return DatabaseFailure;
+            }
         }
 
         // Insert any custom fields belonging to this account
-        AttemptResult result = addCustomFields(insertId.toULongLong(), account->customFields(), "mailaccountcustom");
+        AttemptResult result = addAccountCustomFields(ssoAccount, account->customFields());
         if (result != Success)
+        {
+            ssoAccount->remove();
+            ssoAccount->syncAndBlock();
             return result;
+        }
     }
 
     if (config) {
+
         foreach (const QString &service, config->services()) {
             QMailAccountConfiguration::ServiceConfiguration &serviceConfig(config->serviceConfiguration(service));
             const QMap<QString, QString> &fields = serviceConfig.values();
+            QString serviceName = serviceConfig.service();
 
-            QVariantList configFields;
-            QVariantList configValues;
+            // Open configuration group
+            ssoAccount->beginGroup(serviceName);
 
             // Insert any configuration fields belonging to this account
             QMap<QString, QString>::const_iterator it = fields.begin(), end = fields.end();
             for ( ; it != end; ++it) {
-                configFields.append(QVariant(it.key()));
-                configValues.append(QVariant(it.value()));
+                ssoAccount->setValue(it.key(), QVariant(it.value()));
             }
+            // Close group of keys
+            ssoAccount->endGroup();
+        }
 
-            // Batch insert the custom fields
-            QString sql("INSERT INTO mailaccountconfig (id,service,name,value) VALUES (%1,'%2',?,?)");
-            QSqlQuery query(batchQuery(sql.arg(QString::number(insertId.toULongLong())).arg(service),
-                                       QVariantList() << QVariant(configFields)
-                                                      << QVariant(configValues),
-                                       "addAccount mailaccountconfig query"));
-            if (query.lastError().type() != QSqlError::NoError)
-                return DatabaseFailure;
+        // Save all changes
+        if (!ssoAccount->syncAndBlock())
+        {
+            ssoAccount->remove();
+            ssoAccount->syncAndBlock();
+            return DatabaseFailure;
         }
 
         config->setId(insertId);
@@ -4186,6 +4684,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddAccount(QMailAccou
         qMailLog(Messaging) << "Could not commit account changes to database";
 
         account->setId(QMailAccountId()); //revert the id
+        ssoAccount->remove();
+        ssoAccount->syncAndBlock();
         return DatabaseFailure;
     }
 
@@ -4193,10 +4693,10 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddAccount(QMailAccou
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddFolder(QMailFolder *folder, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddFolder(QMailFolder *folder,
                                                                      QMailFolderIdList *addedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                                      Transaction &t, bool commitOnSuccess)
-{   
+{
     //check that the parent folder actually exists
     if (!checkPreconditions(*folder))
         return Failure;
@@ -4236,7 +4736,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddFolder(QMailFolder
             //add records for each ancestor folder
             QSqlQuery query(simpleQuery("INSERT INTO mailfolderlinks "
                                         "SELECT DISTINCT id,? FROM mailfolderlinks WHERE descendantid=?",
-                                        QVariantList() << folder->id().toULongLong() 
+                                        QVariantList() << folder->id().toULongLong()
                                                        << folder->parentFolderId().toULongLong(),
                                         "mailfolderlinks insert ancestors"));
             if (query.lastError().type() != QSqlError::NoError)
@@ -4246,7 +4746,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddFolder(QMailFolder
         {
             // Our direct parent is also an ancestor
             QSqlQuery query(simpleQuery("INSERT INTO mailfolderlinks VALUES (?,?)",
-                                        QVariantList() << folder->parentFolderId().toULongLong() 
+                                        QVariantList() << folder->parentFolderId().toULongLong()
                                                        << folder->id().toULongLong(),
                                         "mailfolderlinks insert parent"));
             if (query.lastError().type() != QSqlError::NoError)
@@ -4260,7 +4760,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddFolder(QMailFolder
         folder->setId(QMailFolderId()); //revert the id
         return DatabaseFailure;
     }
-   
+
     addedFolderIds->append(insertId);
     if (folder->parentAccountId().isValid())
         modifiedAccountIds->append(folder->parentAccountId());
@@ -4323,7 +4823,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddMessage(QMailMessa
     if (!lock.lock(1000)) {
         qMailLog(Messaging) << "Unable to acquire message body mutex in addMessage!";
         return Failure;
-    } 
+    }
 
     ReferenceStorer refStorer(message);
     const_cast<const QMailMessage*>(message)->foreachPart<ReferenceStorer&>(refStorer);
@@ -4363,7 +4863,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddMessage(QMailMessa
 }
 
 QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddMessage(QMailMessageMetaData *metaData, const QString &identifier, const QStringList &references,
-                                                                      QMailMessageIdList *addedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds, 
+                                                                      QMailMessageIdList *addedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                                       Transaction &t, bool commitOnSuccess)
 {
     if (!metaData->parentFolderId().isValid()) {
@@ -4538,7 +5038,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAddMessage(QMailMessa
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRemoveAccounts(const QMailAccountKey &key, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRemoveAccounts(const QMailAccountKey &key,
                                                                           QMailAccountIdList *deletedAccountIds, QMailFolderIdList *deletedFolderIds, QMailMessageIdList *deletedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                                           Transaction &t, bool commitOnSuccess)
 {
@@ -4555,7 +5055,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRemoveAccounts(const
     return DatabaseFailure;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRemoveFolders(const QMailFolderKey &key, QMailStore::MessageRemovalOption option, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRemoveFolders(const QMailFolderKey &key, QMailStore::MessageRemovalOption option,
                                                                          QMailFolderIdList *deletedFolderIds, QMailMessageIdList *deletedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                                          Transaction &t, bool commitOnSuccess)
 {
@@ -4572,7 +5072,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRemoveFolders(const Q
     return DatabaseFailure;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRemoveMessages(const QMailMessageKey &key, QMailStore::MessageRemovalOption option, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRemoveMessages(const QMailMessageKey &key, QMailStore::MessageRemovalOption option,
                                                                           QMailMessageIdList *deletedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                                           Transaction &t, bool commitOnSuccess)
 {
@@ -4589,7 +5089,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRemoveMessages(const
     return DatabaseFailure;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateAccount(QMailAccount *account, QMailAccountConfiguration *config, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateAccount(QMailAccount *account, QMailAccountConfiguration *config,
                                                                          QMailAccountIdList *updatedAccountIds,
                                                                          Transaction &t, bool commitOnSuccess)
 {
@@ -4597,22 +5097,27 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateAccount(QMailAc
     if (!id.isValid())
         return Failure;
 
-    if (account) {
-        QString properties("type=?, name=?, status=?, signature=?, emailaddress=?");
-        QVariantList propertyValues;
-        propertyValues << static_cast<int>(account->messageType()) 
-                       << account->name() 
-                       << account->status()
-                       << account->signature()
-                       << account->fromAddress().toString(true);
+    QSharedPointer<Accounts::Account> ssoAccount(manager->account(id.toULongLong()));
+    Q_ASSERT(ssoAccount);
+    Accounts::ServiceList services = ssoAccount->services("e-mail");
+    if (!services.count())
+    {
+        qMailLog(Messaging) << "Services not found, make sure that *.service and *.provider files are properly installed.";
+        return DatabaseFailure;
+    }
 
-        {
-            QSqlQuery query(simpleQuery(QString("UPDATE mailaccounts SET %1 WHERE id=?").arg(properties),
-                                        propertyValues << id.toULongLong(),
-                                        "updateAccount mailaccounts query"));
-            if (query.lastError().type() != QSqlError::NoError)
-                return DatabaseFailure;
-        }
+    Accounts::Service* service = services.first();
+    Q_ASSERT(service);
+    ssoAccount->selectService(service);
+
+    if (account)
+    {
+        ssoAccount->setDisplayName(account->name());
+        ssoAccount->setEnabled(account->status() & QMailAccount::Enabled);
+        ssoAccount->setValue("type", static_cast<int>(account->messageType()));
+        ssoAccount->setValue("status", account->status());
+        ssoAccount->setValue("signature", account->signature());
+        ssoAccount->setValue("emailaddress", account->fromAddress().toString(true));
 
         // Update any standard folders configured
         const QMap<QMailFolder::StandardFolder, QMailFolderId> &folders(account->standardFolders());
@@ -4620,7 +5125,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateAccount(QMailAc
 
         {
             // Find the existing folders
-            QSqlQuery query(simpleQuery("SELECT foldertype,folderid FROM mailaccountfolders WHERE id=?", 
+            QSqlQuery query(simpleQuery("SELECT foldertype,folderid FROM mailaccountfolders WHERE id=?",
                                         QVariantList() << id.toULongLong(),
                                         "updateAccount mailaccountfolders select query"));
             if (query.lastError().type() != QSqlError::NoError)
@@ -4689,7 +5194,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateAccount(QMailAc
         }
 
         if (account->customFieldsModified()) {
-            AttemptResult result = updateCustomFields(id.toULongLong(), account->customFields(), "mailaccountcustom");
+            AttemptResult result = updateAccountCustomFields(ssoAccount, account->customFields());
             if (result != Success)
                 return result;
         }
@@ -4709,18 +5214,21 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateAccount(QMailAc
                 fields.insert(qMakePair(service, it.key()), it.value());
         }
 
-        // Find the existing fields in the database
+        // Find the existing fields in SSO account
         QMap<QPair<QString, QString>, QString> existing;
-
         {
-            QSqlQuery query(simpleQuery("SELECT service,name,value FROM mailaccountconfig WHERE id=?",
-                                        QVariantList() << id.toULongLong(),
-                                        "updateAccount mailaccountconfig select query"));
-            if (query.lastError().type() != QSqlError::NoError)
-                return DatabaseFailure;
-
-            while (query.next())
-                existing.insert(qMakePair(query.value(0).toString(), query.value(1).toString()), query.value(2).toString());
+            foreach (const QString& group, ssoAccount->childGroups())
+            {
+                if (group != "customFields")
+                {
+                    ssoAccount->beginGroup(group);
+                    foreach (const QString& name, ssoAccount->allKeys())
+                    {
+                         existing.insert(qMakePair(group, name), ssoAccount->valueAsString(name));
+                    }
+                    ssoAccount->endGroup();
+                }
+            }
         }
 
         QMap<QString, QVariantList> obsoleteFields;
@@ -4754,50 +5262,57 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateAccount(QMailAc
         if (!obsoleteFields.isEmpty()) {
             // Remove the obsolete fields
             QMap<QString, QVariantList>::const_iterator it = obsoleteFields.begin(), end = obsoleteFields.end();
-            for ( ; it != end; ++it) {
+            for ( ; it != end; ++it)
+            {
                 const QString &service = it.key();
                 const QVariantList &fields = it.value();
-                
-                QString sql("DELETE FROM mailaccountconfig WHERE id=? AND service='%1' AND name IN %2");
-                QSqlQuery query(simpleQuery(sql.arg(service).arg(expandValueList(fields)),
-                                            QVariantList() << id.toULongLong() << fields,
-                                            "updateAccount mailaccountconfig delete query"));
-                if (query.lastError().type() != QSqlError::NoError)
-                    return DatabaseFailure;
+
+                ssoAccount->beginGroup(service);
+                foreach (const QVariant& field, fields)
+                {
+                    ssoAccount->remove(field.toString());
+                }
+                ssoAccount->endGroup();
             }
         }
 
         if (!modifiedFields.isEmpty()) {
             // Batch update the modified fields
             QMap<QString, QVariantList>::const_iterator it = modifiedFields.begin(), end = modifiedFields.end();
-            for (QMap<QString, QVariantList>::const_iterator vit = modifiedValues.begin(); it != end; ++it, ++vit) {
+            for (QMap<QString, QVariantList>::const_iterator vit = modifiedValues.begin(); it != end; ++it, ++vit)
+            {
                 const QString &service = it.key();
                 const QVariantList &fields = it.value();
                 const QVariantList &values = vit.value();
-                
-                QString sql("UPDATE mailaccountconfig SET value=? WHERE id=%1 AND service='%2' AND name=?");
-                QSqlQuery query(batchQuery(sql.arg(QString::number(id.toULongLong())).arg(service),
-                                           QVariantList() << QVariant(values) << QVariant(fields),
-                                           "updateAccount mailaccountconfig update query"));
-                if (query.lastError().type() != QSqlError::NoError)
-                    return DatabaseFailure;
+
+                QVariantList::const_iterator field = fields.begin();
+                QVariantList::const_iterator value = values.begin();
+
+                ssoAccount->beginGroup(service);
+                while (field != fields.end() && value != values.end())
+                    ssoAccount->setValue(field++->toString(), *value++);
+
+                ssoAccount->endGroup();
             }
         }
 
         if (!addedFields.isEmpty()) {
             // Batch insert the added fields
             QMap<QString, QVariantList>::const_iterator it = addedFields.begin(), end = addedFields.end();
-            for (QMap<QString, QVariantList>::const_iterator vit = addedValues.begin(); it != end; ++it, ++vit) {
+            for (QMap<QString, QVariantList>::const_iterator vit = addedValues.begin(); it != end; ++it, ++vit)
+            {
                 const QString &service = it.key();
                 const QVariantList &fields = it.value();
                 const QVariantList &values = vit.value();
-                
-                QString sql("INSERT INTO mailaccountconfig (id,service,name,value) VALUES (%1,'%2',?,?)");
-                QSqlQuery query(batchQuery(sql.arg(QString::number(id.toULongLong())).arg(service),
-                                           QVariantList() << QVariant(fields) << QVariant(values),
-                                           "updateAccount mailaccountconfig insert query"));
-                if (query.lastError().type() != QSqlError::NoError)
-                    return DatabaseFailure;
+
+                QVariantList::const_iterator field = fields.begin();
+                QVariantList::const_iterator value = values.begin();
+
+                ssoAccount->beginGroup(service);
+                while (field != fields.end() && value != values.end())
+                    ssoAccount->setValue(field++->toString(), *value++);
+
+                ssoAccount->endGroup();
             }
         }
     }
@@ -4806,7 +5321,10 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateAccount(QMailAc
         qMailLog(Messaging) << "Could not commit account update to database";
         return DatabaseFailure;
     }
-        
+
+    if (!ssoAccount->syncAndBlock())
+        return DatabaseFailure;
+
     if (account) {
         // Update the account cache
         if (accountCache.contains(id))
@@ -4817,7 +5335,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateAccount(QMailAc
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateFolder(QMailFolder *folder, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateFolder(QMailFolder *folder,
                                                                         QMailFolderIdList *updatedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                                         Transaction &t, bool commitOnSuccess)
 {
@@ -4857,7 +5375,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateFolder(QMailFol
         if (query.lastError().type() != QSqlError::NoError)
             return DatabaseFailure;
     }
-    
+
     if (folder->customFieldsModified()) {
         AttemptResult result = updateCustomFields(folder->id().toULongLong(), folder->customFields(), "mailfoldercustom");
         if (result != Success)
@@ -4884,7 +5402,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateFolder(QMailFol
             //add links to the new parent
             QSqlQuery query(simpleQuery("INSERT INTO mailfolderlinks "
                                         "SELECT DISTINCT id,? FROM mailfolderlinks WHERE descendantid=?",
-                                        QVariantList() << folder->id().toULongLong() 
+                                        QVariantList() << folder->id().toULongLong()
                                                        << folder->parentFolderId().toULongLong(),
                                         "mailfolderlinks insert ancestors"));
             if (query.lastError().type() != QSqlError::NoError)
@@ -4900,7 +5418,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateFolder(QMailFol
                 return DatabaseFailure;
         }
     }
-        
+
     if (commitOnSuccess && !t.commit()) {
         qMailLog(Messaging) << "Could not commit folder update to database";
         return DatabaseFailure;
@@ -4914,7 +5432,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateFolder(QMailFol
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessage(QMailMessageMetaData *metaData, QMailMessage *message, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessage(QMailMessageMetaData *metaData, QMailMessage *message,
                                                                          QMailMessageIdList *updatedMessageIds, QMailMessageIdList *modifiedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                                          Transaction &t, bool commitOnSuccess)
 {
@@ -4946,7 +5464,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessage(QMailMe
     // Do we actually have an update to perform?
     bool updateContent(message && message->contentModified());
     if (metaData->dataModified() || updateContent) {
-        // Find the existing properties 
+        // Find the existing properties
         {
             QSqlQuery query(simpleQuery("SELECT parentaccountid,parentfolderid,responseid,mailfile FROM mailmessages WHERE id=?",
                                         QVariantList() << updateId,
@@ -5016,7 +5534,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessage(QMailMe
             if (!lock.lock(1000)) {
                 qMailLog(Messaging) << "Unable to acquire message body mutex in updateMessage!";
                 return Failure;
-            } 
+            }
 
             if (QMailContentManager *contentManager = QMailContentManagerFactory::create(metaData->contentScheme())) {
                 QString contentUri(::contentUri(*metaData));
@@ -5136,7 +5654,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessage(QMailMe
                         return DatabaseFailure;
                 }
             }
-            
+
             // Remove any missing message/ancestor references associated with this message
 
             {
@@ -5323,16 +5841,16 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessage(QMailMe
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessagesMetaData(const QMailMessageKey &key, const QMailMessageKey::Properties &props, const QMailMessageMetaData &data, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessagesMetaData(const QMailMessageKey &key, const QMailMessageKey::Properties &props, const QMailMessageMetaData &data,
                                                                                   QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
-                                                                                  Transaction &t, bool commitOnSuccess) 
+                                                                                  Transaction &t, bool commitOnSuccess)
 {
     //do some checks first
     if (props & QMailMessageKey::Id) {
         qMailLog(Messaging) << "Updating of messages IDs is not supported";
         return Failure;
     }
-    
+
     QMailMessageKey::Properties properties(props);
 
     if (properties & QMailMessageKey::ParentFolderId) {
@@ -5437,8 +5955,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessagesMetaDat
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessagesStatus(const QMailMessageKey &key, quint64 status, bool set, 
-                                                                                QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessagesStatus(const QMailMessageKey &key, quint64 status, bool set,
+                                                                                QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                                                 Transaction &t, bool commitOnSuccess)
 {
     //get the valid ids
@@ -5481,8 +5999,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptUpdateMessagesStatus(
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRestoreToPreviousFolder(const QMailMessageKey &key, 
-                                                                                   QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRestoreToPreviousFolder(const QMailMessageKey &key,
+                                                                                   QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                                                    Transaction &t, bool commitOnSuccess)
 {
     // Find the message and folders that are affected by this update
@@ -5560,7 +6078,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptPurgeMessageRemovalRe
             bindValues << uidValues;
         }
 
-        QSqlQuery query(simpleQuery(sql, 
+        QSqlQuery query(simpleQuery(sql,
                                     bindValues,
                                     "purgeMessageRemovalRecord info query"));
         if (query.lastError().type() != QSqlError::NoError)
@@ -5587,22 +6105,15 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptPurgeMessageRemovalRe
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptCountAccounts(const QMailAccountKey &key, int *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptCountAccounts(const QMailAccountKey &key, int *result,
                                                                          ReadLock &)
 {
-    QSqlQuery query(simpleQuery("SELECT COUNT(*) FROM mailaccounts",
-                                Key(key),
-                                "countAccounts mailaccounts query"));
-    if (query.lastError().type() != QSqlError::NoError)
-        return DatabaseFailure;
-
-    if (query.first())
-        *result = extractValue<int>(query.value(0));
-
+    QMailAccountIdList accountIDList = searchSSOAccounts(key);
+    *result =  accountIDList.count();
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptCountFolders(const QMailFolderKey &key, int *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptCountFolders(const QMailFolderKey &key, int *result,
                                                                         ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT COUNT(*) FROM mailfolders",
@@ -5617,8 +6128,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptCountFolders(const QM
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptCountMessages(const QMailMessageKey &key, 
-                                                                         int *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptCountMessages(const QMailMessageKey &key,
+                                                                         int *result,
                                                                          ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT COUNT(*) FROM mailmessages",
@@ -5633,8 +6144,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptCountMessages(const Q
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptSizeOfMessages(const QMailMessageKey &key, 
-                                                                          int *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptSizeOfMessages(const QMailMessageKey &key,
+                                                                          int *result,
                                                                           ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT SUM(size FROM mailmessages",
@@ -5650,25 +6161,21 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptSizeOfMessages(const
 }
 
 QMailStorePrivate::AttemptResult QMailStorePrivate::attemptQueryAccounts(const QMailAccountKey &key, const QMailAccountSortKey &sortKey, uint limit, uint offset,
-                                                                         QMailAccountIdList *ids, 
+                                                                         QMailAccountIdList *ids,
                                                                          ReadLock &)
 {
-    QSqlQuery query(simpleQuery("SELECT id FROM mailaccounts",
-                                QVariantList(),
-                                QList<Key>() << Key(key) << Key(sortKey),
-                                qMakePair(limit, offset),
-                                "queryAccounts mailaccounts query"));
-    if (query.lastError().type() != QSqlError::NoError)
-        return DatabaseFailure;
+    QMailAccountIdList accountIDList = searchSSOAccounts(key, sortKey);
 
-    while (query.next())
-        ids->append(QMailAccountId(extractValue<quint64>(query.value(0))));
+    if (limit)
+        *ids << accountIDList.mid(offset, limit);
+    else
+        *ids << accountIDList.mid(offset, -1);
 
     return Success;
 }
 
 QMailStorePrivate::AttemptResult QMailStorePrivate::attemptQueryFolders(const QMailFolderKey &key, const QMailFolderSortKey &sortKey, uint limit, uint offset,
-                                                                        QMailFolderIdList *ids, 
+                                                                        QMailFolderIdList *ids,
                                                                         ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT id FROM mailfolders",
@@ -5686,7 +6193,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptQueryFolders(const QM
 }
 
 QMailStorePrivate::AttemptResult QMailStorePrivate::attemptQueryMessages(const QMailMessageKey &key, const QMailMessageSortKey &sortKey, uint limit, uint offset,
-                                                                         QMailMessageIdList *ids, 
+                                                                         QMailMessageIdList *ids,
                                                                          ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT id FROM mailmessages",
@@ -5706,116 +6213,118 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptQueryMessages(const Q
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAccount(const QMailAccountId &id, 
-                                                                   QMailAccount *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAccount(const QMailAccountId &id,
+                                                                   QMailAccount *result,
                                                                    ReadLock &)
 {
+    if (!id.isValid())
+        return Failure;
+
+    QSharedPointer<Accounts::Account> ssoAccount(manager->account(id.toULongLong()));
+    if (!ssoAccount)
+    {
+        qMailLog(Messaging) << "Account with was not found by id:" << id.toULongLong();
+        return Failure;
+    }
+
+    Accounts::ServiceList services = ssoAccount->services("e-mail");
+    if (!services.count())
+    {
+        qMailLog(Messaging) << "Services not found, make sure that *.service and *.provider files are properly installed.";
+        return DatabaseFailure;
+    }
+
+    Accounts::Service* service = services.first();
+    Q_ASSERT(service);
+    ssoAccount->selectService(service);
+
+    *result = extractAccount(ssoAccount);
+    Q_ASSERT(result->id() == id);
+
     {
-        QSqlQuery query(simpleQuery("SELECT * FROM mailaccounts WHERE id=?",
+        // Find any standard folders configured for this account
+        QSqlQuery query(simpleQuery("SELECT foldertype,folderid FROM mailaccountfolders WHERE id=?",
                                     QVariantList() << id.toULongLong(),
-                                    "account mailaccounts query"));
+                                    "account mailaccountfolders query"));
         if (query.lastError().type() != QSqlError::NoError)
             return DatabaseFailure;
 
-        if (query.first()) {
-            *result = extractAccount(query.record());
-        }
+        while (query.next())
+            result->setStandardFolder(QMailFolder::StandardFolder(query.value(0).toInt()), QMailFolderId(query.value(1).toULongLong()));
     }
 
-    if (result->id().isValid()) {
-        {
-            // Find any standard folders configured for this account
-            QSqlQuery query(simpleQuery("SELECT foldertype,folderid FROM mailaccountfolders WHERE id=?",
-                                        QVariantList() << id.toULongLong(),
-                                        "account mailaccountfolders query"));
-            if (query.lastError().type() != QSqlError::NoError)
-                return DatabaseFailure;
-
-            while (query.next())
-                result->setStandardFolder(QMailFolder::StandardFolder(query.value(0).toInt()), QMailFolderId(query.value(1).toULongLong()));
-        }
-
-        // Find any custom fields for this account
-        QMap<QString, QString> fields;
-        AttemptResult attemptResult = customFields(id.toULongLong(), &fields, "mailaccountcustom");
-        if (attemptResult != Success)
-            return attemptResult;
+    // Find any custom fields for this SSO account
+    QMap<QString, QString> fields;
+    AttemptResult attemptResult = accountCustomFields(ssoAccount, &fields);
+    if (attemptResult != Success)
+        return attemptResult;
 
-        result->setCustomFields(fields);
-        result->setCustomFieldsModified(false);
+    result->setCustomFields(fields);
+    result->setCustomFieldsModified(false);
 
+    // Find the type of the account
+    foreach (const QString& group, ssoAccount->childGroups())
+    {
+        if (group != "customFields")
         {
-            // Find the type of the account
-            QSqlQuery query(simpleQuery("SELECT service,value FROM mailaccountconfig WHERE id=? AND name='servicetype'",
-                                        QVariantList() << id.toULongLong(),
-                                        "account mailaccountconfig query"));
-            if (query.lastError().type() != QSqlError::NoError)
-                return DatabaseFailure;
+            ssoAccount->beginGroup(group);
 
-            while (query.next()) {
-                QString service(query.value(0).toString());
-                QString type(query.value(1).toString());
+            QString serviceType = ssoAccount->valueAsString("servicetype");
+            if (serviceType.contains("source"))
+                result->addMessageSource(group);
 
-                if (type.contains("source")) {
-                    result->addMessageSource(service);
-                }
-                if (type.contains("sink")) {
-                    result->addMessageSink(service);
-                }
-            }
-        }
+            if (serviceType.contains("sink"))
+                result->addMessageSink(group);
 
-        //update cache 
-        accountCache.insert(*result);
-        return Success;
+            ssoAccount->endGroup();
+        }
     }
 
-    return Failure;
+    //update cache
+    accountCache.insert(*result);
+    return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAccountConfiguration(const QMailAccountId &id, 
-                                                                                QMailAccountConfiguration *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAccountConfiguration(const QMailAccountId &id,
+                                                                                QMailAccountConfiguration *result,
                                                                                 ReadLock &)
 {
-    // Find any configuration fields for this account
-    QSqlQuery query(simpleQuery("SELECT service,name,value FROM mailaccountconfig WHERE id=? ORDER BY service",
-                                QVariantList() << id.toULongLong(),
-                                "accountConfiguration mailaccountconfig query"));
-    if (query.lastError().type() != QSqlError::NoError)
-        return DatabaseFailure;
+    QSharedPointer<Accounts::Account> ssoAccount(manager->account(id.toULongLong()));
 
-    QString service;
-    QMailAccountConfiguration::ServiceConfiguration *serviceConfig = 0;
+    if (!ssoAccount)
+        return Failure;
 
-    while (query.next()) {
-        QString svc(query.value(0).toString());
-        if (svc != service) {
-            service = svc;
+    Accounts::ServiceList services = ssoAccount->services("e-mail");
+    if (!services.count())
+    {
+        qMailLog(Messaging) << "Services not found, make sure that *.service and *.provider files are properly installed.";
+        return DatabaseFailure;
+    }
+
+    Accounts::Service* service = services.first();
+    Q_ASSERT(service);
+    ssoAccount->selectService(service);
 
-            if (!result->services().contains(service)) {
+    foreach (const QString& group, ssoAccount->childGroups())
+    {
+        if (group != "customFields")
+        {
+            if (!result->services().contains(group)) {
                 // Add this service to the configuration
-                result->addServiceConfiguration(service);
+                result->addServiceConfiguration(group);
             }
 
-            serviceConfig = &result->serviceConfiguration(service);
-        }
-
-        serviceConfig->setValue(query.value(1).toString(), query.value(2).toString());
-    }
-
-    if (service.isEmpty()) {
-        // No services - is this an error?
-        QSqlQuery query(simpleQuery("SELECT COUNT(*) FROM mailaccounts WHERE id=?",
-                                    QVariantList() << id.toULongLong(),
-                                    "accountConfiguration mailaccounts query"));
-        if (query.lastError().type() != QSqlError::NoError)
-            return DatabaseFailure;
+            QMailAccountConfiguration::ServiceConfiguration* serviceConfig = &result->serviceConfiguration(group);
+            Q_ASSERT(serviceConfig);
 
-        if (query.first()) {
-            if (extractValue<int>(query.value(0)) == 0)
-                return Failure;
+            ssoAccount->beginGroup(group);
+            foreach (const QString& key, ssoAccount->allKeys())
+            {
+                serviceConfig->setValue(key,ssoAccount->valueAsString(key));
+            }
+            ssoAccount->endGroup();
         }
-    } 
+    }
 
     result->setId(id);
     result->setModified(false);
@@ -5823,8 +6332,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptAccountConfiguration(
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptFolder(const QMailFolderId &id, 
-                                                                  QMailFolder *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptFolder(const QMailFolderId &id,
+                                                                  QMailFolder *result,
                                                                   ReadLock &)
 {
     {
@@ -5849,7 +6358,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptFolder(const QMailFol
         result->setCustomFields(fields);
         result->setCustomFieldsModified(false);
 
-        //update cache 
+        //update cache
         folderCache.insert(*result);
         return Success;
     }
@@ -5857,8 +6366,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptFolder(const QMailFol
     return Failure;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessage(const QMailMessageId &id, 
-                                                                   QMailMessage *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessage(const QMailMessageId &id,
+                                                                   QMailMessage *result,
                                                                    ReadLock &)
 {
     // Find any custom fields for this message
@@ -5882,8 +6391,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessage(const QMailMe
     return Failure;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessage(const QString &uid, const QMailAccountId &accountId, 
-                                                                   QMailMessage *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessage(const QString &uid, const QMailAccountId &accountId,
+                                                                   QMailMessage *result,
                                                                    ReadLock &lock)
 {
     quint64 id(0);
@@ -5891,7 +6400,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessage(const QString
     AttemptResult attemptResult = attemptMessageId(uid, accountId, &id, lock);
     if (attemptResult != Success)
         return attemptResult;
-            
+
     if (id != 0) {
         return attemptMessage(QMailMessageId(id), result, lock);
     }
@@ -5900,7 +6409,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessage(const QString
 }
 
 QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageMetaData(const QMailMessageId &id,
-                                                                           QMailMessageMetaData *result, 
+                                                                           QMailMessageMetaData *result,
                                                                            ReadLock &)
 {
     // Find any custom fields for this message
@@ -5924,8 +6433,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageMetaData(const
     return Failure;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageMetaData(const QString &uid, const QMailAccountId &accountId, 
-                                                                           QMailMessageMetaData *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageMetaData(const QString &uid, const QMailAccountId &accountId,
+                                                                           QMailMessageMetaData *result,
                                                                            ReadLock &lock)
 {
     quint64 id(0);
@@ -5933,7 +6442,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageMetaData(const
     AttemptResult attemptResult = attemptMessageId(uid, accountId, &id, lock);
     if (attemptResult != Success)
         return attemptResult;
-            
+
     if (id != 0) {
         return attemptMessageMetaData(QMailMessageId(id), result, lock);
     }
@@ -5941,8 +6450,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageMetaData(const
     return Failure;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessagesMetaData(const QMailMessageKey& key, const QMailMessageKey::Properties &properties, QMailStore::ReturnOption option, 
-                                                                            QMailMessageMetaDataList *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessagesMetaData(const QMailMessageKey& key, const QMailMessageKey::Properties &properties, QMailStore::ReturnOption option,
+                                                                            QMailMessageMetaDataList *result,
                                                                             ReadLock &)
 {
     if (properties == QMailMessageKey::Custom) {
@@ -6033,8 +6542,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessagesMetaData(cons
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageRemovalRecords(const QMailAccountId &accountId, const QMailFolderId &folderId, 
-                                                                                 QMailMessageRemovalRecordList *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageRemovalRecords(const QMailAccountId &accountId, const QMailFolderId &folderId,
+                                                                                 QMailMessageRemovalRecordList *result,
                                                                                  ReadLock &)
 {
     QVariantList values;
@@ -6058,8 +6567,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageRemovalRecords
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageFolderIds(const QMailMessageKey &key, 
-                                                                            QMailFolderIdList *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageFolderIds(const QMailMessageKey &key,
+                                                                            QMailFolderIdList *result,
                                                                             ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT DISTINCT t0.parentfolderid FROM mailmessages t0",
@@ -6074,8 +6583,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageFolderIds(cons
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptFolderAccountIds(const QMailFolderKey &key, 
-                                                                            QMailAccountIdList *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptFolderAccountIds(const QMailFolderKey &key,
+                                                                            QMailAccountIdList *result,
                                                                             ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT DISTINCT parentaccountid FROM mailfolders t0",
@@ -6090,8 +6599,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptFolderAccountIds(cons
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptFolderAncestorIds(const QMailFolderIdList &ids, 
-                                                                             QMailFolderIdList *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptFolderAncestorIds(const QMailFolderIdList &ids,
+                                                                             QMailFolderIdList *result,
                                                                              ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT DISTINCT id FROM mailfolderlinks",
@@ -6174,8 +6683,8 @@ void QMailStorePrivate::preloadHeaderCache(const QMailMessageId& id) const
     }
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptStatusBit(const QString &name, const QString &context, 
-                                                                     int *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptStatusBit(const QString &name, const QString &context,
+                                                                     int *result,
                                                                      ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT COALESCE(statusbit,0) FROM mailstatusflags WHERE name=? AND context=?",
@@ -6191,13 +6700,13 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptStatusBit(const QStri
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRegisterStatusBit(const QString &name, const QString &context, int maximum, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRegisterStatusBit(const QString &name, const QString &context, int maximum,
                                                                              Transaction &t, bool commitOnSuccess)
 {
     int highest = 0;
 
     {
-        // Find the highest 
+        // Find the highest
         QSqlQuery query(simpleQuery("SELECT MAX(statusbit) FROM mailstatusflags WHERE context=?",
                                     QVariantList() << context,
                                     "mailstatusflags register select"));
@@ -6226,8 +6735,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptRegisterStatusBit(con
     return Success;
 }
 
-QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageId(const QString &uid, const QMailAccountId &accountId, 
-                                                                     quint64 *result, 
+QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageId(const QString &uid, const QMailAccountId &accountId,
+                                                                     quint64 *result,
                                                                      ReadLock &)
 {
     QSqlQuery query(simpleQuery("SELECT id FROM mailmessages WHERE serveruid=? AND parentaccountid=?",
@@ -6240,7 +6749,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::attemptMessageId(const QStri
         *result = extractValue<quint64>(query.value(0));
         return Success;
     }
-        
+
     return Failure;
 }
 
@@ -6357,9 +6866,9 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::messagePredecessor(QMailMess
                                         ")"
                                     ") "
                                     "ORDER BY stamp DESC",
-                                    QVariantList() << metaData->id().toULongLong() 
-                                                    << metaData->parentAccountId().toULongLong() 
-                                                    << metaData->date().toLocalTime() 
+                                    QVariantList() << metaData->id().toULongLong()
+                                                    << metaData->parentAccountId().toULongLong()
+                                                    << metaData->date().toLocalTime()
                                                     << baseSubject,
                                     "messagePredecessor mailmessages select query"));
         if (query.lastError().type() != QSqlError::NoError)
@@ -6646,7 +7155,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::registerSubject(const QStrin
         if (query.next())
             subjectId = extractValue<quint64>(query.value(0));
     }
-    
+
     if (subjectId == 0) {
         QSqlQuery query(simpleQuery("INSERT INTO mailsubjects (basesubject) VALUES (?)",
                                     QVariantList() << baseSubject,
@@ -6671,7 +7180,7 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::registerSubject(const QStrin
         if (query.next())
             count = extractValue<int>(query.value(0));
     }
-    
+
     if (count == 0) {
         QSqlQuery query(simpleQuery("INSERT INTO mailthreadsubjects (threadid,subjectid) SELECT threadid,? FROM mailthreadmessages WHERE messageid=?",
                                     QVariantList() << subjectId << messageId,
@@ -6716,8 +7225,8 @@ QMailStorePrivate::AttemptResult QMailStorePrivate::registerSubject(const QStrin
 
 bool QMailStorePrivate::checkPreconditions(const QMailFolder& folder, bool update)
 {
-    //if the parent is valid, check that it exists 
-    //if the account is valid, check that is exists 
+    //if the parent is valid, check that it exists
+    //if the account is valid, check that is exists
 
     if(!update)
     {
@@ -6727,7 +7236,7 @@ bool QMailStorePrivate::checkPreconditions(const QMailFolder& folder, bool updat
             return false;
         }
     }
-    else 
+    else
     {
         if(!folder.id().isValid())
         {
@@ -6753,21 +7262,30 @@ bool QMailStorePrivate::checkPreconditions(const QMailFolder& folder, bool updat
 
     if(folder.parentAccountId().isValid())
     {
-        if(!idExists(folder.parentAccountId(),"mailaccounts"))
+        Accounts::AccountId accountId = folder.parentAccountId().toULongLong();
+        QSharedPointer<Accounts::Account> ssoAccount(manager->account(accountId));
+
+        if (!ssoAccount)
         {
             qMailLog(Messaging) << "Parent account does not exist!";
             return false;
         }
+
+        if (!ssoAccount->supportsService("e-mail"))
+        {
+            qMailLog(Messaging) << "Parent account does not support e-mail service!";
+            return false;
+        }
     }
 
     return true;
 }
 
-bool QMailStorePrivate::deleteMessages(const QMailMessageKey& key, 
-                                       QMailStore::MessageRemovalOption option, 
-                                       QMailMessageIdList& deletedMessageIds, 
-                                       QStringList& expiredContent, 
-                                       QMailMessageIdList& updatedMessageIds, 
+bool QMailStorePrivate::deleteMessages(const QMailMessageKey& key,
+                                       QMailStore::MessageRemovalOption option,
+                                       QMailMessageIdList& deletedMessageIds,
+                                       QStringList& expiredContent,
+                                       QMailMessageIdList& updatedMessageIds,
                                        QMailFolderIdList& modifiedFolderIds,
                                        QMailAccountIdList& modifiedAccountIds)
 {
@@ -6790,7 +7308,7 @@ bool QMailStorePrivate::deleteMessages(const QMailMessageKey& key,
         while (query.next()) {
             QMailMessageId messageId(extractValue<quint64>(query.value(0)));
             deletedMessageIds.append(messageId);
-            
+
             QString contentUri(extractValue<QString>(query.value(1)));
             if (!contentUri.isEmpty())
                 expiredContent.append(contentUri);
@@ -6976,13 +7494,13 @@ bool QMailStorePrivate::deleteMessages(const QMailMessageKey& key,
     return true;
 }
 
-bool QMailStorePrivate::deleteFolders(const QMailFolderKey& key, 
-                                      QMailStore::MessageRemovalOption option, 
-                                      QMailFolderIdList& deletedFolderIds, 
-                                      QMailMessageIdList& deletedMessageIds, 
-                                      QStringList& expiredContent, 
-                                      QMailMessageIdList& updatedMessageIds, 
-                                      QMailFolderIdList& modifiedFolderIds, 
+bool QMailStorePrivate::deleteFolders(const QMailFolderKey& key,
+                                      QMailStore::MessageRemovalOption option,
+                                      QMailFolderIdList& deletedFolderIds,
+                                      QMailMessageIdList& deletedMessageIds,
+                                      QStringList& expiredContent,
+                                      QMailMessageIdList& updatedMessageIds,
+                                      QMailFolderIdList& modifiedFolderIds,
                                       QMailAccountIdList& modifiedAccountIds)
 {
     {
@@ -6998,16 +7516,16 @@ bool QMailStorePrivate::deleteFolders(const QMailFolderKey& key,
     }
 
     // No folders? Then we're already done
-    if (deletedFolderIds.isEmpty()) 
+    if (deletedFolderIds.isEmpty())
         return true;
 
     // Create a key to select messages in the folders to be deleted
     QMailMessageKey messagesKey(QMailMessageKey::parentFolderId(key));
-    
+
     // Delete all the messages contained by the folders we're deleting
     if (!deleteMessages(messagesKey, option, deletedMessageIds, expiredContent, updatedMessageIds, modifiedFolderIds, modifiedAccountIds))
         return false;
-    
+
     // Delete any references to these folders in the mailfolderlinks table
     QString statement("DELETE FROM mailfolderlinks WHERE %1 IN ( SELECT t0.id FROM mailfolders t0");
     statement += buildWhereClause(Key(key, "t0")) + " )";
@@ -7070,45 +7588,36 @@ bool QMailStorePrivate::deleteFolders(const QMailFolderKey& key,
     return true;
 }
 
-bool QMailStorePrivate::deleteAccounts(const QMailAccountKey& key, 
-                                       QMailAccountIdList& deletedAccountIds, 
-                                       QMailFolderIdList& deletedFolderIds, 
-                                       QMailMessageIdList& deletedMessageIds, 
-                                       QStringList& expiredContent, 
-                                       QMailMessageIdList& updatedMessageIds, 
-                                       QMailFolderIdList& modifiedFolderIds, 
+bool QMailStorePrivate::deleteAccounts(const QMailAccountKey& key,
+                                       QMailAccountIdList& deletedAccountIds,
+                                       QMailFolderIdList& deletedFolderIds,
+                                       QMailMessageIdList& deletedMessageIds,
+                                       QStringList& expiredContent,
+                                       QMailMessageIdList& updatedMessageIds,
+                                       QMailFolderIdList& modifiedFolderIds,
                                        QMailAccountIdList& modifiedAccountIds)
 {
-    {
-        // Get the identifiers for all the accounts we're deleting
-        QSqlQuery query(simpleQuery("SELECT t0.id FROM mailaccounts t0",
-                                    Key(key, "t0"),
-                                    "deleteAccounts info query"));
-        if (query.lastError().type() != QSqlError::NoError)
-            return false;
-
-        while (query.next())
-            deletedAccountIds.append(QMailAccountId(extractValue<quint64>(query.value(0))));
-    }
+    // Searching across all accounts inside SSO
+    deletedAccountIds << searchSSOAccounts(key);
 
     // No accounts? Then we're already done
-    if (deletedAccountIds.isEmpty()) 
+    if (deletedAccountIds.isEmpty())
         return true;
 
     // Create a key to select folders from the accounts to be deleted
-    QMailFolderKey foldersKey(QMailFolderKey::parentAccountId(key));
-    
+    QMailFolderKey foldersKey(QMailFolderKey::parentAccountId(deletedAccountIds));
+
     // We won't create new message removal records, since there will be no account to link them to
     QMailStore::MessageRemovalOption option(QMailStore::NoRemovalRecord);
 
     // Delete all the folders contained by the accounts we're deleting
     if (!deleteFolders(foldersKey, option, deletedFolderIds, deletedMessageIds, expiredContent, updatedMessageIds, modifiedFolderIds, modifiedAccountIds))
         return false;
-    
+
     // Also delete any messages belonging to these accounts, that aren't in folders owned by the accounts
 
     // Create a key to select messages for the accounts to be deleted
-    QMailMessageKey messagesKey(QMailMessageKey::parentAccountId(key));
+    QMailMessageKey messagesKey(QMailMessageKey::parentAccountId(deletedAccountIds));
 
     // Delete all the messages contained by the folders we're deleting
     if (!deleteMessages(messagesKey, option, deletedMessageIds, expiredContent, updatedMessageIds, modifiedFolderIds, modifiedAccountIds))
@@ -7133,30 +7642,15 @@ bool QMailStorePrivate::deleteAccounts(const QMailAccountKey& key,
     }
 
     {
-        // Remove any custom fields associated with these accounts
-        QSqlQuery query(simpleQuery("DELETE FROM mailaccountcustom",
-                                    Key("id", QMailAccountKey::id(deletedAccountIds)),
-                                    "deleteAccounts delete mailaccountcustom query"));
-        if (query.lastError().type() != QSqlError::NoError)
-            return false;
-    }
-
-    {
-        // Remove any configuration fields associated with these accounts
-        QSqlQuery query(simpleQuery("DELETE FROM mailaccountconfig",
-                                    Key("id", QMailAccountKey::id(deletedAccountIds)),
-                                    "deleteAccounts delete mailaccountconfig query"));
-        if (query.lastError().type() != QSqlError::NoError)
-            return false;
-    }
-
-    {
-        // Perform the account deletion
-        QSqlQuery query(simpleQuery("DELETE FROM mailaccounts",
-                                    Key("id", QMailAccountKey::id(deletedAccountIds)),
-                                    "deleteAccounts delete mailaccounts query"));
-        if (query.lastError().type() != QSqlError::NoError)
-            return false;
+        // Remove accounts from SSO
+        foreach (const QMailAccountId& accountID, deletedAccountIds)
+        {
+            QSharedPointer<Accounts::Account> ssoAccount(manager->account(accountID.toULongLong()));
+            Q_ASSERT(ssoAccount);
+            ssoAccount->remove();
+            if (!ssoAccount->syncAndBlock())
+                return false;
+        }
     }
 
     // Do not report any deleted entities as updated
@@ -7321,3 +7815,39 @@ void QMailStorePrivate::emitIpcNotification(QMailStoreImplementation::MessageUpd
     QMailStoreImplementation::emitIpcNotification(signal, ids);
 }
 
+QMailAccountIdList QMailStorePrivate::searchSSOAccounts(const QMailAccountKey& key, const QMailAccountSortKey& sortKey) const
+{
+    Accounts::AccountIdList accountIDList = manager->accountList("e-mail");
+
+    // Populate all E-Mail accounts
+    typedef QList<Accounts::Account*> AccountList;
+    QMailAccountIdList accountList;
+
+    foreach (Accounts::AccountId accountID, accountIDList)
+    {
+        Accounts::Account* ssoAccount = manager->account(accountID);
+        Q_ASSERT(ssoAccount);
+
+        Accounts::ServiceList services = ssoAccount->services("e-mail");
+        if (!services.count())
+        {
+            qMailLog(Messaging) << "Services not found, make sure that *.service and *.provider files are properly installed.";
+            return QMailAccountIdList();
+        }
+
+        Accounts::Service* service = services.first();
+        Q_ASSERT(service);
+        ssoAccount->selectService(service);
+
+        if (SSOAccountSatisfyTheKey(ssoAccount, key))
+            accountList.append(QMailAccountId(ssoAccount->id()));
+
+        delete ssoAccount;
+    }
+
+    /*
+     * TBD: Use sortKey to sort found accounts properly
+     */
+
+    return accountList;
+}
diff --git a/src/libraries/qtopiamail/qmailstore_p.h b/src/libraries/qtopiamail/qmailstore_p.h
index 0bcc387..9ae3980 100644
--- a/src/libraries/qtopiamail/qmailstore_p.h
+++ b/src/libraries/qtopiamail/qmailstore_p.h
@@ -56,6 +56,9 @@
 #include "qmailstoreimplementation_p.h"
 #include <QSqlDatabase>
 #include <QCache>
+#include <QDomDocument>
+#include <accounts-qt/manager.h>
+#include <accounts-qt/account.h>
 
 //#define QMAILSTORE_LOG_SQL //define to enable SQL query logging
 //#define QMAILSTORE_USE_RTTI //define if RTTI is available to assist debugging
@@ -180,7 +183,9 @@ public:
     static ValueType extractValue(const QVariant& var, const ValueType &defaultValue = ValueType());
 
     enum AttemptResult { Success = 0, Failure, DatabaseFailure };
-    
+
+    QMailAccountIdList searchSSOAccounts(const QMailAccountKey& key, const QMailAccountSortKey& sortKey = QMailAccountSortKey()) const;
+
 private:
     friend class Transaction;
     friend class ReadLock;
@@ -254,7 +259,7 @@ private:
 
     bool idValueExists(quint64 id, const QString& table);
 
-    bool idExists(const QMailAccountId& id, const QString& table = QString());
+    bool idExists(const QMailAccountId& id);
     bool idExists(const QMailFolderId& id, const QString& table = QString());
     bool idExists(const QMailMessageId& id, const QString& table = QString());
 
@@ -302,152 +307,156 @@ private:
     template<typename AccessType, typename FunctionType>
     bool repeatedly(FunctionType func, const QString &description, Transaction *t = 0) const;
 
+    AttemptResult addAccountCustomFields(QSharedPointer<Accounts::Account>& ssoAccount, const QMap<QString, QString> &fields);
+    AttemptResult updateAccountCustomFields(QSharedPointer<Accounts::Account>& ssoAccount, const QMap<QString, QString> &fields);
+    AttemptResult accountCustomFields(QSharedPointer<Accounts::Account>& ssoAccount, QMap<QString, QString>* fields);
+
     AttemptResult addCustomFields(quint64 id, const QMap<QString, QString> &fields, const QString &tableName);
     AttemptResult updateCustomFields(quint64 id, const QMap<QString, QString> &fields, const QString &tableName);
     AttemptResult customFields(quint64 id, QMap<QString, QString> *fields, const QString &tableName);
 
-    AttemptResult attemptAddAccount(QMailAccount *account, QMailAccountConfiguration* config, 
-                                    QMailAccountIdList *addedAccountIds, 
+    AttemptResult attemptAddAccount(QMailAccount *account, QMailAccountConfiguration* config,
+                                    QMailAccountIdList *addedAccountIds,
                                     Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptAddFolder(QMailFolder *folder, 
+    AttemptResult attemptAddFolder(QMailFolder *folder,
                                    QMailFolderIdList *addedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                    Transaction &t, bool commitOnSuccess);
 
     AttemptResult attemptAddMessage(QMailMessage *message, const QString &identifier, const QStringList &references,
-                                    QMailMessageIdList *addedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds, 
+                                    QMailMessageIdList *addedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                     Transaction &t, bool commitOnSuccess);
 
     AttemptResult attemptAddMessage(QMailMessageMetaData *metaData, const QString &identifier, const QStringList &references,
-                                    QMailMessageIdList *addedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds, 
+                                    QMailMessageIdList *addedMessageIds, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                     Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptRemoveAccounts(const QMailAccountKey &key, 
+    AttemptResult attemptRemoveAccounts(const QMailAccountKey &key,
                                         QMailAccountIdList *deletedAccounts, QMailFolderIdList *deletedFolders, QMailMessageIdList *deletedMessages, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                         Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptRemoveFolders(const QMailFolderKey &key, QMailStore::MessageRemovalOption option, 
+    AttemptResult attemptRemoveFolders(const QMailFolderKey &key, QMailStore::MessageRemovalOption option,
                                        QMailFolderIdList *deletedFolders, QMailMessageIdList *deletedMessages, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                        Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptRemoveMessages(const QMailMessageKey &key, QMailStore::MessageRemovalOption option, 
+    AttemptResult attemptRemoveMessages(const QMailMessageKey &key, QMailStore::MessageRemovalOption option,
                                         QMailMessageIdList *deletedMessages, QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                         Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptUpdateAccount(QMailAccount *account, QMailAccountConfiguration *config, 
+    AttemptResult attemptUpdateAccount(QMailAccount *account, QMailAccountConfiguration *config,
                                        QMailAccountIdList *updatedAccountIds,
                                        Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptUpdateAccountConfiguration(QMailAccountConfiguration *config, 
+    AttemptResult attemptUpdateAccountConfiguration(QMailAccountConfiguration *config,
                                                     QMailAccountIdList *updatedAccountIds,
                                                     Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptUpdateFolder(QMailFolder *folder, 
+    AttemptResult attemptUpdateFolder(QMailFolder *folder,
                                       QMailFolderIdList *updatedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                       Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptUpdateMessage(QMailMessageMetaData *metaData, QMailMessage *mail, 
+    AttemptResult attemptUpdateMessage(QMailMessageMetaData *metaData, QMailMessage *mail,
                                        QMailMessageIdList *updatedMessageIds, QMailMessageIdList *modifiedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                        Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptUpdateMessagesMetaData(const QMailMessageKey &key, const QMailMessageKey::Properties &props, const QMailMessageMetaData &data, 
+    AttemptResult attemptUpdateMessagesMetaData(const QMailMessageKey &key, const QMailMessageKey::Properties &props, const QMailMessageMetaData &data,
                                                 QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
-                                                Transaction &t, bool commitOnSuccess); 
+                                                Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptUpdateMessagesStatus(const QMailMessageKey &key, quint64 status, bool set, 
-                                              QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds, 
+    AttemptResult attemptUpdateMessagesStatus(const QMailMessageKey &key, quint64 status, bool set,
+                                              QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                               Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptRestoreToPreviousFolder(const QMailMessageKey &key, 
-                                                 QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds, 
+    AttemptResult attemptRestoreToPreviousFolder(const QMailMessageKey &key,
+                                                 QMailMessageIdList *updatedMessageIds, QMailFolderIdList *modifiedFolderIds, QMailAccountIdList *modifiedAccountIds,
                                                  Transaction &t, bool commitOnSuccess);
 
     AttemptResult attemptPurgeMessageRemovalRecords(const QMailAccountId &accountId, const QStringList &serverUids,
                                                     Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptCountAccounts(const QMailAccountKey &key, int *result, 
+    AttemptResult attemptCountAccounts(const QMailAccountKey &key, int *result,
                                        ReadLock &);
 
-    AttemptResult attemptCountFolders(const QMailFolderKey &key, int *result, 
+    AttemptResult attemptCountFolders(const QMailFolderKey &key, int *result,
                                       ReadLock &);
 
-    AttemptResult attemptCountMessages(const QMailMessageKey &key, 
-                                       int *result, 
+    AttemptResult attemptCountMessages(const QMailMessageKey &key,
+                                       int *result,
                                        ReadLock &);
 
-    AttemptResult attemptSizeOfMessages(const QMailMessageKey &key, 
-                                        int *result, 
+    AttemptResult attemptSizeOfMessages(const QMailMessageKey &key,
+                                        int *result,
                                         ReadLock &);
 
     AttemptResult attemptQueryAccounts(const QMailAccountKey &key, const QMailAccountSortKey &sortKey, uint limit, uint offset,
-                                       QMailAccountIdList *ids, 
+                                       QMailAccountIdList *ids,
                                        ReadLock &);
 
     AttemptResult attemptQueryFolders(const QMailFolderKey &key, const QMailFolderSortKey &sortKey, uint limit, uint offset,
-                                      QMailFolderIdList *ids, 
+                                      QMailFolderIdList *ids,
                                       ReadLock &);
 
     AttemptResult attemptQueryMessages(const QMailMessageKey &key, const QMailMessageSortKey &sortKey, uint limit, uint offset,
-                                       QMailMessageIdList *ids, 
+                                       QMailMessageIdList *ids,
                                        ReadLock &);
 
-    AttemptResult attemptAccount(const QMailAccountId &id, 
-                                 QMailAccount *result, 
+    AttemptResult attemptAccount(const QMailAccountId &id,
+                                 QMailAccount *result,
                                  ReadLock &);
 
-    AttemptResult attemptAccountConfiguration(const QMailAccountId &id, 
-                                              QMailAccountConfiguration *result, 
+    AttemptResult attemptAccountConfiguration(const QMailAccountId &id,
+                                              QMailAccountConfiguration *result,
                                               ReadLock &);
 
-    AttemptResult attemptFolder(const QMailFolderId &id, 
-                                QMailFolder *result, 
+    AttemptResult attemptFolder(const QMailFolderId &id,
+                                QMailFolder *result,
                                 ReadLock &);
 
-    AttemptResult attemptMessage(const QMailMessageId &id, 
-                                 QMailMessage *result, 
+    AttemptResult attemptMessage(const QMailMessageId &id,
+                                 QMailMessage *result,
                                  ReadLock &);
 
-    AttemptResult attemptMessage(const QString &uid, const QMailAccountId &accountId, 
-                                 QMailMessage *result, 
+    AttemptResult attemptMessage(const QString &uid, const QMailAccountId &accountId,
+                                 QMailMessage *result,
                                  ReadLock &);
 
-    AttemptResult attemptMessageMetaData(const QMailMessageId &id, 
-                                         QMailMessageMetaData *result, 
+    AttemptResult attemptMessageMetaData(const QMailMessageId &id,
+                                         QMailMessageMetaData *result,
                                          ReadLock &);
 
-    AttemptResult attemptMessageMetaData(const QString &uid, const QMailAccountId &accountId, 
-                                         QMailMessageMetaData *result, 
+    AttemptResult attemptMessageMetaData(const QString &uid, const QMailAccountId &accountId,
+                                         QMailMessageMetaData *result,
                                          ReadLock &);
 
-    AttemptResult attemptMessagesMetaData(const QMailMessageKey& key, const QMailMessageKey::Properties &properties, QMailStore::ReturnOption option, 
-                                          QMailMessageMetaDataList *result, 
+    AttemptResult attemptMessagesMetaData(const QMailMessageKey& key, const QMailMessageKey::Properties &properties, QMailStore::ReturnOption option,
+                                          QMailMessageMetaDataList *result,
                                           ReadLock &);
 
-    AttemptResult attemptMessageRemovalRecords(const QMailAccountId &accountId, const QMailFolderId &parentFolderId, 
+    AttemptResult attemptMessageRemovalRecords(const QMailAccountId &accountId, const QMailFolderId &parentFolderId,
                                                QMailMessageRemovalRecordList *result,
                                                ReadLock &);
 
-    AttemptResult attemptMessageFolderIds(const QMailMessageKey &key, 
-                                          QMailFolderIdList *result, 
+    AttemptResult attemptMessageFolderIds(const QMailMessageKey &key,
+                                          QMailFolderIdList *result,
                                           ReadLock &);
 
-    AttemptResult attemptFolderAccountIds(const QMailFolderKey &key, 
-                                          QMailAccountIdList *result, 
+    AttemptResult attemptFolderAccountIds(const QMailFolderKey &key,
+                                          QMailAccountIdList *result,
                                           ReadLock &);
 
-    AttemptResult attemptFolderAncestorIds(const QMailFolderIdList &ids, 
-                                           QMailFolderIdList *result, 
+    AttemptResult attemptFolderAncestorIds(const QMailFolderIdList &ids,
+                                           QMailFolderIdList *result,
                                            ReadLock &);
 
-    AttemptResult attemptStatusBit(const QString &name, const QString &context, 
-                                   int *result, 
+    AttemptResult attemptStatusBit(const QString &name, const QString &context,
+                                   int *result,
                                    ReadLock &);
 
-    AttemptResult attemptRegisterStatusBit(const QString &name, const QString &context, int maximum, 
+    AttemptResult attemptRegisterStatusBit(const QString &name, const QString &context, int maximum,
                                            Transaction &t, bool commitOnSuccess);
 
-    AttemptResult attemptMessageId(const QString &uid, const QMailAccountId &accountId, 
-                                   quint64 *result, 
+    AttemptResult attemptMessageId(const QString &uid, const QMailAccountId &accountId,
+                                   quint64 *result,
                                    ReadLock &);
 
     AttemptResult affectedByMessageIds(const QMailMessageIdList &messages, QMailFolderIdList *folderIds, QMailAccountIdList *accountIds) const;
@@ -462,7 +471,7 @@ private:
 
     AttemptResult registerSubject(const QString &baseSubject, quint64 messageId, const QMailMessageId &predecessorId, bool missingAncestor);
 
-    QMailAccount extractAccount(const QSqlRecord& r);
+    QMailAccount extractAccount(const QSharedPointer<Accounts::Account>& ssoAccount);
     QMailFolder extractFolder(const QSqlRecord& r);
     QMailMessageMetaData extractMessageMetaData(const QSqlRecord& r, QMailMessageKey::Properties recordProperties, const QMailMessageKey::Properties& properties = allMessageProperties());
     QMailMessageMetaData extractMessageMetaData(const QSqlRecord& r, const QMap<QString, QString> &customFields, const QMailMessageKey::Properties& properties = allMessageProperties());
@@ -491,7 +500,7 @@ private:
     static void extractMessageMetaData(const QSqlRecord& r, QMailMessageKey::Properties recordProperties, const QMailMessageKey::Properties& properties, QMailMessageMetaData* metaData);
 
 private:
-    template <typename T, typename KeyType> 
+    template <typename T, typename KeyType>
     class Cache
     {
     public:
@@ -508,7 +517,7 @@ private:
         QCache<KeyType,T> mCache;
     };
 
-    template <typename T, typename ID> 
+    template <typename T, typename ID>
     class IdCache : public Cache<T, quint64>
     {
     public:
@@ -521,7 +530,7 @@ private:
     };
 
     mutable QSqlDatabase database;
-    
+
     mutable QMailMessageIdList lastQueryMessageResult;
 
     mutable IdCache<QMailMessageMetaData, QMailMessageId> messageCache;
@@ -540,6 +549,8 @@ private:
     ProcessReadLock *readLock;
 
     static ProcessMutex *contentMutex;
+
+    Accounts::Manager* manager;
 };
 
 template <typename ValueType>
@@ -559,18 +570,18 @@ ValueType QMailStorePrivate::extractValue(const QVariant &var, const ValueType &
 }
 
 
-template <typename T, typename KeyType> 
+template <typename T, typename KeyType>
 QMailStorePrivate::Cache<T, KeyType>::Cache(unsigned int cacheSize)
     : mCache(cacheSize)
 {
 }
 
-template <typename T, typename KeyType> 
+template <typename T, typename KeyType>
 QMailStorePrivate::Cache<T, KeyType>::~Cache()
 {
 }
 
-template <typename T, typename KeyType> 
+template <typename T, typename KeyType>
 T QMailStorePrivate::Cache<T, KeyType>::lookup(const KeyType& key) const
 {
     if (T* cachedItem = mCache.object(key))
@@ -579,32 +590,32 @@ T QMailStorePrivate::Cache<T, KeyType>::lookup(const KeyType& key) const
     return T();
 }
 
-template <typename T, typename KeyType> 
+template <typename T, typename KeyType>
 void QMailStorePrivate::Cache<T, KeyType>::insert(const KeyType& key, const T& item)
 {
     mCache.insert(key,new T(item));
 }
 
-template <typename T, typename KeyType> 
+template <typename T, typename KeyType>
 bool QMailStorePrivate::Cache<T, KeyType>::contains(const KeyType& key) const
 {
     return mCache.contains(key);
 }
 
-template <typename T, typename KeyType> 
+template <typename T, typename KeyType>
 void QMailStorePrivate::Cache<T, KeyType>::remove(const KeyType& key)
 {
     mCache.remove(key);
 }
 
-template <typename T, typename KeyType> 
+template <typename T, typename KeyType>
 void QMailStorePrivate::Cache<T, KeyType>::clear()
 {
     mCache.clear();
 }
 
 
-template <typename T, typename ID> 
+template <typename T, typename ID>
 T QMailStorePrivate::IdCache<T, ID>::lookup(const ID& id) const
 {
     if (id.isValid()) {
@@ -614,7 +625,7 @@ T QMailStorePrivate::IdCache<T, ID>::lookup(const ID& id) const
     return T();
 }
 
-template <typename T, typename ID> 
+template <typename T, typename ID>
 void QMailStorePrivate::IdCache<T, ID>::insert(const T& item)
 {
     if (item.id().isValid()) {
@@ -622,13 +633,13 @@ void QMailStorePrivate::IdCache<T, ID>::insert(const T& item)
     }
 }
 
-template <typename T, typename ID> 
+template <typename T, typename ID>
 bool QMailStorePrivate::IdCache<T, ID>::contains(const ID& id) const
 {
     return Cache<T, quint64>::contains(id.toULongLong());
 }
 
-template <typename T, typename ID> 
+template <typename T, typename ID>
 void QMailStorePrivate::IdCache<T, ID>::remove(const ID& id)
 {
     Cache<T, quint64>::remove(id.toULongLong());
diff --git a/src/libraries/qtopiamail/qtopiamail.pro b/src/libraries/qtopiamail/qtopiamail.pro
index aea6614..0a4d5ff 100644
--- a/src/libraries/qtopiamail/qtopiamail.pro
+++ b/src/libraries/qtopiamail/qtopiamail.pro
@@ -1,151 +1,175 @@
-TEMPLATE = lib 
-CONFIG += warn_on
+TEMPLATE = lib
+CONFIG += warn_on create_pc create_prl link_pkgconfig
 
 include(../../../common.pri)
 
+QT *= sql network xml
+
 TARGET = qtopiamail
-target.path += $$QMF_INSTALL_ROOT/lib 
+target.path += $$QMF_INSTALL_ROOT/lib
+
 INSTALLS += target
 
-DEFINES += QT_BUILD_QCOP_LIB QTOPIAMAIL_INTERNAL
 win32: {
     # QLocalSocket is broken on win32 prior to 4.5.2
     lessThan(QT_MAJOR_VERSION,5):lessThan(QT_MINOR_VERSION,6):lessThan(QT_PATCH_VERSION,2):DEFINES += QT_NO_QCOP_LOCAL_SOCKET
 }
 
-QT *= sql network
 symbian: {
     LIBS += -lefsrv
     MMP_RULES += EXPORTUNFROZEN
 }
 
-DEPENDPATH += .
+PKGCONFIG += accounts-qt
+
+DEFINES += QT_BUILD_QCOP_LIB QTOPIAMAIL_INTERNAL
+
+DEPENDPATH  += .
 
 INCLUDEPATH += support
 
 HEADERS += bind_p.h \
-           locks_p.h \
-           longstream_p.h \
-           longstring_p.h \
-           mailkeyimpl_p.h \
-           mailsortkeyimpl_p.h \
-           qmailaccount.h \
-           qmailaccountconfiguration.h \
-           qmailaccountkey.h \
-           qmailaccountkey_p.h \
-           qmailaccountlistmodel.h \
-           qmailaccountsortkey.h \
-           qmailaccountsortkey_p.h \
-           qmailaddress.h \
-           qmailcodec.h \
-           qmailcontentmanager.h \
-           qmaildatacomparator.h \
-           qmailfolder.h \
-           qmailfolderfwd.h \
-           qmailfolderkey.h \
-           qmailfolderkey_p.h \
-           qmailfoldersortkey.h \
-           qmailfoldersortkey_p.h \
-           qmailid.h \
-           qmailkeyargument.h \
-           qmailmessage_p.h \
-           qmailmessage.h \
-           qmailmessagefwd.h \
-           qmailmessagekey.h \
-           qmailmessagekey_p.h \
-           qmailmessagelistmodel.h \
-           qmailmessagemodelbase.h \
-           qmailmessageremovalrecord.h \
-           qmailmessageserver.h \
-           qmailmessageset_p.h \
-           qmailmessageset.h \
-           qmailmessagesortkey.h \
-           qmailmessagesortkey_p.h \
-           qmailmessagethreadedmodel.h \
-           qmailserviceaction_p.h \
-           qmailserviceaction.h \
-           qmailsortkeyargument.h \
-           qmailstore.h \
-           qmailstore_p.h \
-           qmailstoreimplementation_p.h \
-           qmailtimestamp.h \
-           qprivateimplementation.h \
-           qprivateimplementationdef.h \
-           support/qmailglobal.h \
-           support/qmaillog.h \
-           support/qmailnamespace.h \
-           support/qcopadaptor.h \
-           support/qcopapplicationchannel.h \
-           support/qcopchannel.h \
-           support/qcopchannel_p.h \
-           support/qcopchannelmonitor.h \
-           support/qcopserver.h \
-           support/qmailpluginmanager.h \
-           support/qringbuffer_p.h
+    locks_p.h \
+    longstream_p.h \
+    longstring_p.h \
+    mailkeyimpl_p.h \
+    mailsortkeyimpl_p.h \
+    qmailaccount.h \
+    qmailaccountconfiguration.h \
+    qmailaccountkey.h \
+    qmailaccountkey_p.h \
+    qmailaccountlistmodel.h \
+    qmailaccountsortkey.h \
+    qmailaccountsortkey_p.h \
+    qmailaddress.h \
+    qmailcodec.h \
+    qmailcontentmanager.h \
+    qmaildatacomparator.h \
+    qmailfolder.h \
+    qmailfolderfwd.h \
+    qmailfolderkey.h \
+    qmailfolderkey_p.h \
+    qmailfoldersortkey.h \
+    qmailfoldersortkey_p.h \
+    qmailid.h \
+    qmailkeyargument.h \
+    qmailmessage_p.h \
+    qmailmessage.h \
+    qmailmessagefwd.h \
+    qmailmessagekey.h \
+    qmailmessagekey_p.h \
+    qmailmessagelistmodel.h \
+    qmailmessagemodelbase.h \
+    qmailmessageremovalrecord.h \
+    qmailmessageserver.h \
+    qmailmessageset_p.h \
+    qmailmessageset.h \
+    qmailmessagesortkey.h \
+    qmailmessagesortkey_p.h \
+    qmailmessagethreadedmodel.h \
+    qmailserviceaction_p.h \
+    qmailserviceaction.h \
+    qmailsortkeyargument.h \
+    qmailstore.h \
+    qmailstore_p.h \
+    qmailstoreimplementation_p.h \
+    qmailtimestamp.h \
+    qprivateimplementation.h \
+    qprivateimplementationdef.h \
+    support/qmailglobal.h \
+    support/qmaillog.h \
+    support/qmailnamespace.h \
+    support/qcopadaptor.h \
+    support/qcopapplicationchannel.h \
+    support/qcopchannel.h \
+    support/qcopchannel_p.h \
+    support/qcopchannelmonitor.h \
+    support/qcopserver.h \
+    support/qmailpluginmanager.h \
+    support/qringbuffer_p.h \
+    support/qmailipc.h \
+    support/qlogsystem.h \
+    support/qloggers.h
 
 SOURCES += longstream.cpp \
-           longstring.cpp \
-           qmailaccount.cpp \
-           qmailaccountconfiguration.cpp \
-           qmailaccountkey.cpp \
-           qmailaccountlistmodel.cpp \
-           qmailaccountsortkey.cpp \
-           qmailaddress.cpp \
-           qmailcodec.cpp \
-           qmailcontentmanager.cpp \
-           qmaildatacomparator.cpp \
-           qmailfolder.cpp \
-           qmailfolderkey.cpp \
-           qmailfoldersortkey.cpp \
-           qmailid.cpp \
-           qmailinstantiations.cpp \
-           qmailkeyargument.cpp \
-           qmailmessage.cpp \
-           qmailmessagefwd.cpp \
-           qmailmessagekey.cpp \
-           qmailmessagelistmodel.cpp \
-           qmailmessagemodelbase.cpp \
-           qmailmessageremovalrecord.cpp \
-           qmailmessageserver.cpp \
-           qmailmessageset.cpp \
-           qmailmessagesortkey.cpp \
-           qmailmessagethreadedmodel.cpp \
-           qmailserviceaction.cpp \
-           qmailstore.cpp \
-           qmailstore_p.cpp \
-           qmailstoreimplementation_p.cpp \
-           qmailtimestamp.cpp \
-           qprivateimplementation.cpp \
-           support/qmailnamespace.cpp \
-           support/qmaillog.cpp \
-           support/qcopadaptor.cpp \
-           support/qcopapplicationchannel.cpp \
-           support/qcopchannel.cpp \
-           support/qcopchannelmonitor.cpp \
-           support/qcopserver.cpp \
-           support/qmailpluginmanager.cpp
-
-win32: {
-    SOURCES += locks_win32.cpp
-} else {
-    SOURCES += locks.cpp
-}
+    longstring.cpp \
+    qmailaccount.cpp \
+    qmailaccountconfiguration.cpp \
+    qmailaccountkey.cpp \
+    qmailaccountlistmodel.cpp \
+    qmailaccountsortkey.cpp \
+    qmailaddress.cpp \
+    qmailcodec.cpp \
+    qmailcontentmanager.cpp \
+    qmaildatacomparator.cpp \
+    qmailfolder.cpp \
+    qmailfolderkey.cpp \
+    qmailfoldersortkey.cpp \
+    qmailid.cpp \
+    qmailinstantiations.cpp \
+    qmailkeyargument.cpp \
+    qmailmessage.cpp \
+    qmailmessagefwd.cpp \
+    qmailmessagekey.cpp \
+    qmailmessagelistmodel.cpp \
+    qmailmessagemodelbase.cpp \
+    qmailmessageremovalrecord.cpp \
+    qmailmessageserver.cpp \
+    qmailmessageset.cpp \
+    qmailmessagesortkey.cpp \
+    qmailmessagethreadedmodel.cpp \
+    qmailserviceaction.cpp \
+    qmailstore.cpp \
+    qmailstore_p.cpp \
+    qmailstoreimplementation_p.cpp \
+    qmailtimestamp.cpp \
+    qprivateimplementation.cpp \
+    support/qmailnamespace.cpp \
+    support/qmaillog.cpp \
+    support/qcopadaptor.cpp \
+    support/qcopapplicationchannel.cpp \
+    support/qcopchannel.cpp \
+    support/qcopchannelmonitor.cpp \
+    support/qcopserver.cpp \
+    support/qmailpluginmanager.cpp \
+    support/qlogsystem.cpp
+    
+win32::SOURCES += locks_win32.cpp
+else:SOURCES += locks.cpp
 
 RESOURCES += qtopiamail.qrc \
-             qtopiamail_icons.qrc \
-             qtopiamail_qt.qrc
-
+    qtopiamail_icons.qrc \
+    qtopiamail_qt.qrc
+    
 TRANSLATIONS += libqtopiamail-ar.ts \
-                libqtopiamail-de.ts \
-                libqtopiamail-en_GB.ts \
-                libqtopiamail-en_SU.ts \
-                libqtopiamail-en_US.ts \
-                libqtopiamail-es.ts \
-                libqtopiamail-fr.ts \
-                libqtopiamail-it.ts \
-                libqtopiamail-ja.ts \
-                libqtopiamail-ko.ts \
-                libqtopiamail-pt_BR.ts \
-                libqtopiamail-zh_CN.ts \
-                libqtopiamail-zh_TW.ts
+    libqtopiamail-de.ts \
+    libqtopiamail-en_GB.ts \
+    libqtopiamail-en_SU.ts \
+    libqtopiamail-en_US.ts \
+    libqtopiamail-es.ts \
+    libqtopiamail-fr.ts \
+    libqtopiamail-it.ts \
+    libqtopiamail-ja.ts \
+    libqtopiamail-ko.ts \
+    libqtopiamail-pt_BR.ts \
+    libqtopiamail-zh_CN.ts \
+    libqtopiamail-zh_TW.ts
+    
+# Install headers
+headers.files = $$HEADERS include/*
+headers.path  = $$QMF_INSTALL_ROOT/include/qmf
+
+# Install generic SSO provider description
+sso_providers.files = share/GenericProvider.provider
+sso_providers.path  = $$QMF_INSTALL_ROOT/share/accounts/providers
+
+# Install generic SSO service description
+sso_services.files = share/GenericEmail.service
+sso_services.path  = $$QMF_INSTALL_ROOT/share/accounts/services
+
+INSTALLS += headers sso_providers sso_services
 
+# Install pkgconfig file
+QMAKE_PKGCONFIG_LIBDIR  = $$target.path
+QMAKE_PKGCONFIG_INCDIR  = $$headers.path
+QMAKE_PKGCONFIG_DESTDIR = pkgconfig
diff --git a/src/libraries/qtopiamail/share/GenericEmail.service b/src/libraries/qtopiamail/share/GenericEmail.service
new file mode 100644
index 0000000..3aed235
--- /dev/null
+++ b/src/libraries/qtopiamail/share/GenericEmail.service
@@ -0,0 +1,65 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+<service id="GenericEmail">
+  <type>e-mail</type>
+  <name>Email Mailbox</name>
+  <icon>generic_email</icon>
+  <provider>GenericProvider</provider>
+
+  <!-- default settings (account settings have precedence over these) -->
+  <template>
+    <setting name="type" type="i">0</setting>
+    <setting name="name">Generic Email Account</setting>
+    <setting name="status" type="i">0</setting>
+    <setting name="signature"></setting>
+    <setting name="emailaddress"></setting>
+    <setting name="enabled" type="b">false</setting>
+    <!-- Exclude default configuration
+    <pop3>
+      <setting name="server">pop3.example.com</setting>
+      <setting name="port" type="i">143</setting>
+      <setting name="encryption" type="b">0</setting>
+      <setting name="canDelete" type="b">0</setting>
+      <setting name="autoDownload" type="b">0</setting>
+      <setting name="maxSize" type="i">102400</setting>
+      <setting name="checkInterval" type="i">-1</setting>
+      <setting name="intervalCheckRoamingEnabled" type="i">0</setting>      
+    </pop3>
+    <imap4>
+       <setting name="server">imap.example.com</setting>
+       <setting name="port" type="i">110</setting>
+       <setting name="encryption" type="b">0</setting>
+       <setting name="canDelete" type="b">0</setting>
+       <setting name="autoDownload" type="b">0</setting>
+       <setting name="maxSize" type="i">102400</setting>
+       <setting name="pushEnabled" type="b">0</setting>
+       <setting name="baseFolder"></setting>
+       <setting name="draftsFolder"></setting>
+       <setting name="trashFolder"></setting>
+       <setting name="junkFolder"></setting>
+       <setting name="checkInterval" type="i">-1</setting>
+       <setting name="intervalCheckRoamingEnabled" type="b">0</setting>
+    </imap4>
+    <smtp>
+       <setting name="address">email@example.com</setting>
+       <setting name="server">smtp.example.com</setting>
+       <setting name="port" type="i">25</setting>
+       <setting name="authentication" type="b">0</setting>
+       <setting name="encryption" type="b">0</setting>
+     </smtp>
+     -->
+  </template>
+
+  <!-- preview account -->
+  <preview>
+    <parameters>
+      <setting name="server">talkdemo.google.com</setting>
+      <setting name="account">googledemo@gmail.com</setting>
+      <setting name="password">demo</setting>
+    </parameters>
+    <setting name="display_name">GTalk demo</setting>
+  </preview>
+
+  <!-- type-specific data -->
+  <type_data>
+  </type_data>
+</service>
diff --git a/src/libraries/qtopiamail/share/GenericProvider.provider b/src/libraries/qtopiamail/share/GenericProvider.provider
new file mode 100644
index 0000000..e5d7303
--- /dev/null
+++ b/src/libraries/qtopiamail/share/GenericProvider.provider
@@ -0,0 +1,5 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+<provider id="GenericProvider">
+  <name>Generic Service Provider</name>
+  <icon>generic_provider</icon>
+</provider>
diff --git a/src/libraries/qtopiamail/support/qloggers.h b/src/libraries/qtopiamail/support/qloggers.h
new file mode 100644
index 0000000..8f2fcc9
--- /dev/null
+++ b/src/libraries/qtopiamail/support/qloggers.h
@@ -0,0 +1,347 @@
+/****************************************************************************
+**
+** Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
+** Contact: Nokia Corporation (qt-info@nokia.com)
+**
+** This file is part of the Qt Messaging Framework.
+**
+** $QT_BEGIN_LICENSE:LGPL$
+** No Commercial Usage
+** This file contains pre-release code and may not be distributed.
+** You may use this file in accordance with the terms and conditions
+** contained in the either Technology Preview License Agreement or the
+** Beta Release License Agreement.
+**
+** GNU Lesser General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU Lesser
+** General Public License version 2.1 as published by the Free Software
+** Foundation and appearing in the file LICENSE.LGPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU Lesser General Public License version 2.1 requirements
+** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
+**
+** In addition, as a special exception, Nokia gives you certain
+** additional rights. These rights are described in the Nokia Qt LGPL
+** Exception version 1.0, included in the file LGPL_EXCEPTION.txt in this
+** package.
+**
+** GNU General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU
+** General Public License version 3.0 as published by the Free Software
+** Foundation and appearing in the file LICENSE.GPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU General Public License version 3.0 requirements will be
+** met: http://www.gnu.org/copyleft/gpl.html.
+**
+** If you are unsure which license is appropriate for your use, please
+** contact the sales department at qt-sales@nokia.com.
+** $QT_END_LICENSE$
+**
+****************************************************************************/
+
+#ifndef QLOGGERS_H
+#define QLOGGERS_H
+
+#include <qlogsystem.h>
+#include <syslog.h>
+/*!
+  \brief Base (and trivial) logger functionality
+
+  This template is used to simplify loggers declarations and implementations. The main logic it implements is
+  the "minimal log level" logic.  This template can not be used alone.  It should be used only with host class.
+  Host's void doLog(const char* fmt, va_list args) will be called by
+  BaseLogger::operator()(LogLevel lvl, const char* fmt, va_list args) if the lvl argument is greater or equal than
+  minimal log level.
+
+  Loggers are frequently used as singletons in the modern world of software design.  That's why logger's constructors
+  can be called before entering main() function. So, it would not be a perfect design style to throw exceptions in logger's
+  constructors. On the other hand, there is a common solution to initialize logger resources inside its constructors.  It is
+  clear, that such initialization procedure can fail. It is necessary to know the result of initialization after entering
+  main().  #isReady/#setUnReady methods pair of this class seems to be the solution of this dilemma.  #isReady is public
+  method which should be used to check loggers's "ready for the mission" (successfull initialization) status.
+  #SetUnReady is protected method which should be called by derived class's constructors instead of exception throwing.
+*/
+template <class Host, class Prefix = NoLogPrefix> class QTOPIAMAIL_EXPORT BaseLogger: public ILogger
+{
+public:
+        /*!
+          \brief  Stores reference to host (to make possible host.OutMsg call in operator()) and
+                  minimal log level. Messages with log level less than minimum log level will not be logged.
+
+          \param  host		Reference to host object
+          \param  min_lvl	Minimal log level
+        */
+        BaseLogger(Host& host, const LogLevel min_lvl = LlInfo);
+
+        /// Standard destructor
+        virtual ~BaseLogger()
+        {
+        }
+
+        /*!
+          \brief Sets minimal log level. Messages with log level less than minimum log level will not be logged.
+
+          \param min_lvl New value of minimal log level.
+        */
+        void setMinLogLvl(const LogLevel minlvl)
+        {
+            min_lvl = minlvl;
+        }
+        /*!
+          \brief  Log function. It is compatible with LogFunc_t declaration.  That's why obejcts of derived classes
+                  can be used as loggers.
+
+                  Checks lvl and if it is greater or equal then minumal log level, calls host's doLog function.
+
+          \param lvl  Log-level. Messages with log level less than minimum log level will not be logged
+          \param fmt  Format of log string.  See (v)printf manual for details.
+          \param args Arguments related to format.  See vprintf manual for additional information.
+        */
+        void log(const LogLevel lvl, const char* fmt, va_list args);
+        /*!
+          \brief Is this logger ready for logging?
+
+          \param err Reference to string where error message should be placed in case where logger is not ready.
+
+          \return true if logger is ready for logging, otherwise returns false and sets err variable to human-readable
+                  error message.
+        */
+        bool isReady(QString& err);
+protected:
+        /// function where the actual logging is implemented
+        virtual void doLog(const LogLevel lvl, const char* fmt, va_list args) = 0;
+        /*!
+          \brief Set "ready for the logging" status to false
+
+                 This method should be called by host whenever critical error with loging device occurs.
+
+          \param err Text error message.
+        */
+        void setUnReady(const QString& err);
+        /*!
+          \brief Set "ready for the logging" status to true
+
+        */
+        void setReady(void);
+private:
+        /// Reference to host object
+        Host& host;
+        /// Prefix generator
+        Prefix prefix;
+        /// Minimal log level.
+        LogLevel min_lvl;
+        /// Are we ready for the mission (logging)?
+        bool is_ready;
+        /// Error message if is_ready equals to false
+        QString err_msg;
+        /// Bufer used to write log-level text presentation into output log device
+        QString buf;
+};
+
+/*!
+  \brief Logging device - file
+
+  This class can be used for logging into files. See also documentation on BaseLogger for additional useful remarks.
+*/
+template <class Prefix = LvlTimeLogPrefix>
+class QTOPIAMAIL_EXPORT FileLogger : public BaseLogger<FileLogger<Prefix>, Prefix>
+{
+public:
+        /*!
+          \brief  Opens log file in append mode.  Any error can be checked via isReady method.
+
+          \param name 		The name of log file.
+          \param flush_period  Flush period (in lines)
+          \param min_lvl 	Minimal log level.  Messages with log level less than _min_lvl will not be logged
+        */
+        FileLogger(const QString& name, const unsigned flush_period = 10, const LogLevel min_lvl = LlInfo);
+        /*!
+          \brief This constructor is for logging into already open files.  stderr and stdout files are typical
+                 examples.
+
+          \param f		Pointer to the open file. It should be writable, of course.
+          \param flush_period  Flush period (in lines)
+          \param min_lvl	Minimal log level.  Messages with log level less than _min_lvl will not be logged.
+          \param owner 	File closing policy.  If _owner is false file _f will not be closed in FileLogger's destructor, else will be.
+        */
+        FileLogger(FILE* f, const unsigned flush_period = 10, const LogLevel min_lvl = LlInfo, bool owner = false);
+        /*!
+          \brief  Real logging function.  See BaseLogger documentation for additional information.
+
+                  Flushes the output every period (see documentation on FileLogger constructors for additional details)
+
+          \param lvl  Log-level. Messages with log level less than minimum log level will not be logged
+          \param fmt  Format of log string.  See (v)printf manual for details.
+          \param args Arguments related to format.  See vprintf manual for additional information.
+        */
+        virtual void doLog(const LogLevel lvl, const char* fmt, va_list args);
+        /// Closes file if this object is it's owner.
+        ~FileLogger();
+private:
+        Q_DISABLE_COPY(FileLogger);
+        QString name;
+        /// File handle
+        FILE* f;
+        /// Should I close file in destructor?
+        bool should_close;
+        /// Counter of "doLog" calls
+        unsigned do_cntr;
+        /// Flush period in lines
+        const unsigned flush_period;
+};
+
+/*!
+  \class SysLogger
+  \brief Logging device - syslog.
+
+  This class can be used for logging via syslog. See also documentation on #BaseLogger for additional useful remarks.
+*/
+template <class Prefix = LvlTimePidLogPrefix>
+class QTOPIAMAIL_EXPORT SysLogger : public BaseLogger<SysLogger<Prefix>, Prefix>
+{
+public:
+        /*!
+          \brief Opens a connection to system logger
+
+          \param ident		See openlog manual
+          \param option	See openlog manual
+          \param facility	See openlog manual
+          \param min_lvl	Minimal log level.  Messages with log level less than _min_lvl will not be logged
+        */
+        SysLogger(const QString& ident, int option, int facility, const LogLevel min_lvl = LlInfo);
+        /*!
+          \brief  Real logging function.  See BaseLogger documentation for additional information.
+
+          \param lvl  Log-level. Messages with log level less than minimum log level will not be logged
+          \param fmt  Format of log string.  See (v)printf manual for details.
+          \param args Arguments related to format.  See vprintf manual for additional information.
+        */
+        virtual void doLog(const LogLevel lvl, const char* fmt, va_list args);
+        /// Disconnects from the syslog
+        ~SysLogger();
+private:
+        Q_DISABLE_COPY(SysLogger);
+        /// Ident string for syslog
+        const QString ident;
+};
+
+/**********************************************************************************************************/
+/*********************************** BaseLogger implementation ********************************************/
+/**********************************************************************************************************/
+
+template <class Host, class Prefix>
+BaseLogger<Host, Prefix>::BaseLogger(Host& _host, const LogLevel _min_lvl)
+                 : host(_host), min_lvl(_min_lvl), is_ready(true)
+{
+}
+
+template <class Host, class Prefix>
+inline void BaseLogger<Host, Prefix>::log(const LogLevel _lvl, const char* _fmt, va_list args)
+{
+    if(_lvl >= min_lvl)
+    {
+        Q_ASSERT(is_ready);
+
+        const QString& pref = prefix(_lvl);
+
+        if(!pref.isEmpty())
+        {
+            QString out = pref + QString(_fmt);
+            host.doLog(_lvl, qPrintable(out), args);
+        }else
+            host.doLog(_lvl, _fmt, args);
+
+
+   }
+};
+
+template <class Host, class Prefix>
+inline bool BaseLogger<Host, Prefix>::isReady(QString& _err)
+{
+  if(!is_ready) _err = err_msg;
+  return is_ready;
+};
+
+template <class Host, class Prefix>
+void BaseLogger<Host, Prefix>::setUnReady(const QString& _err)
+{
+    is_ready = false;
+    err_msg = _err;
+};
+
+template <class Host, class Prefix>
+void BaseLogger<Host, Prefix>::setReady(void)
+{
+    is_ready = true;
+    err_msg = "";
+};
+
+/**********************************************************************************************************/
+/*********************************** FileLogger implementation ********************************************/
+/**********************************************************************************************************/
+
+template <class Prefix>
+FileLogger<Prefix>::FileLogger(const QString& _name, const unsigned _flush_period, const LogLevel _min_lvl)
+           : BaseLogger< FileLogger<Prefix>, Prefix >(*this, _min_lvl), name(_name), should_close(true), flush_period(_flush_period)
+{
+    f = fopen(qPrintable(_name), "a" );
+    if(f == NULL)
+    {
+        should_close = false;
+        BaseLogger< FileLogger<Prefix>, Prefix >::setUnReady(strerror(errno));
+    }
+};
+
+template <class Prefix>
+FileLogger<Prefix>::FileLogger(FILE* _f, const unsigned _flush_period, const LogLevel _min_lvl, bool _owner)
+    : BaseLogger< FileLogger<Prefix>, Prefix >(*this, _min_lvl), name(""), f(_f), should_close(_owner), flush_period(_flush_period)
+{
+};
+
+template <class Prefix>
+FileLogger<Prefix>::~FileLogger()
+{
+    if(should_close)
+        fclose(f);
+};
+
+template <class Prefix>
+inline void FileLogger<Prefix>::doLog(const LogLevel /*lvl*/, const char* fmt, va_list args)
+{
+    vfprintf(f, fmt, args);
+    fprintf(f, "\n");
+
+    if(++do_cntr > flush_period)
+    {
+        do_cntr = 0;
+        fflush(f);
+    };
+};
+
+/**********************************************************************************************************/
+/************************************ SysLogger implementation ********************************************/
+/**********************************************************************************************************/
+
+template <class Prefix>
+inline SysLogger<Prefix>::SysLogger(const QString& _ident, int _option, int _facility, const LogLevel  _min_lvl)
+    :BaseLogger<SysLogger<Prefix>, Prefix>(*this, _min_lvl), ident(_ident)
+{
+    openlog(qPrintable(ident), _option, _facility);
+};
+
+template <class Prefix>
+inline void SysLogger<Prefix>::doLog(const LogLevel _lvl, const char* _fmt, va_list _args)
+{
+    static int priorities[] = { LOG_DEBUG, LOG_INFO, LOG_WARNING, LOG_ERR,  LOG_CRIT };
+    Q_ASSERT((_lvl >= LlDbg) && (_lvl <= LlCritical));
+
+    vsyslog(priorities[_lvl], _fmt, _args);
+};
+
+template <class Prefix>
+inline SysLogger<Prefix>::~SysLogger()
+{
+    closelog();
+};
+
+#endif // QLOGGERS_H
diff --git a/src/libraries/qtopiamail/support/qlogsystem.cpp b/src/libraries/qtopiamail/support/qlogsystem.cpp
new file mode 100644
index 0000000..1c0178d
--- /dev/null
+++ b/src/libraries/qtopiamail/support/qlogsystem.cpp
@@ -0,0 +1,152 @@
+/****************************************************************************
+**
+** Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
+** Contact: Nokia Corporation (qt-info@nokia.com)
+**
+** This file is part of the Qt Messaging Framework.
+**
+** $QT_BEGIN_LICENSE:LGPL$
+** No Commercial Usage
+** This file contains pre-release code and may not be distributed.
+** You may use this file in accordance with the terms and conditions
+** contained in the either Technology Preview License Agreement or the
+** Beta Release License Agreement.
+**
+** GNU Lesser General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU Lesser
+** General Public License version 2.1 as published by the Free Software
+** Foundation and appearing in the file LICENSE.LGPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU Lesser General Public License version 2.1 requirements
+** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
+**
+** In addition, as a special exception, Nokia gives you certain
+** additional rights. These rights are described in the Nokia Qt LGPL
+** Exception version 1.0, included in the file LGPL_EXCEPTION.txt in this
+** package.
+**
+** GNU General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU
+** General Public License version 3.0 as published by the Free Software
+** Foundation and appearing in the file LICENSE.GPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU General Public License version 3.0 requirements will be
+** met: http://www.gnu.org/copyleft/gpl.html.
+**
+** If you are unsure which license is appropriate for your use, please
+** contact the sales department at qt-sales@nokia.com.
+** $QT_END_LICENSE$
+**
+****************************************************************************/
+
+#include "qlogsystem.h"
+
+#include <QDateTime>
+
+extern "C"
+{
+#include <unistd.h>
+}
+
+//LogSystem implementation
+LogSystem::LogSystem()
+{
+    qInstallMsgHandler(debugMsgFwd);
+}
+
+LogSystem::~LogSystem()
+{
+	qInstallMsgHandler(NULL);
+    clear();
+}
+
+void LogSystem::log(LogLevel lvl, const char* fmt, ...)
+{
+    va_list args;
+    va_start(args, fmt);
+
+    foreach(ILogger* logger, loggers)
+    {        
+        logger->log(lvl, fmt, args);        
+    }
+    va_end(args);
+}
+
+void LogSystem::addLogger(ILogger* logger)
+{
+    Q_ASSERT(logger);
+    if(!loggers.contains(logger))
+        loggers.append(logger);
+}
+
+void LogSystem::clear()
+{ 
+    foreach(ILogger* logger, loggers)
+    {
+        Q_ASSERT(logger);
+        delete logger;
+    }
+    loggers.clear();
+}
+
+void LogSystem::debugMsgFwd(QtMsgType type, const char *msg)
+{
+    switch (type)
+    {
+    case QtDebugMsg:
+        LogSystem::getInstance().log(LlDbg, "%s", msg);
+        break;
+    case QtWarningMsg:
+        LogSystem::getInstance().log(LlWarning, "%s", msg);
+        break;
+    case QtFatalMsg:
+        LogSystem::getInstance().log(LlCritical, "%s", msg);
+        abort();
+    case QtCriticalMsg:
+        LogSystem::getInstance().log(LlError, "%s", msg);
+        break;
+    default:
+        Q_ASSERT(false);
+        break;
+    }
+}
+
+//Aux classes implementation
+
+const QString& NoLogPrefix::operator()(const LogLevel& lvl)
+{
+    Q_UNUSED(lvl);
+    return empty;
+}
+
+LvlLogPrefix::LvlLogPrefix()
+{
+    levels_str[LlDbg]  	   =  QString("[Debug] ");
+    levels_str[LlInfo] 	   =  QString("[Info] ");
+    levels_str[LlWarning]  =  QString("[Warning] ");
+    levels_str[LlError]    =  QString("[Error] ");
+    levels_str[LlCritical] =  QString("[Critical] ");
+}
+
+const QString& LvlLogPrefix::operator()(const LogLevel&  lvl)
+{
+    out = levels_str[lvl];
+    return out;
+}
+
+const QString& LvlTimeLogPrefix::operator()(const LogLevel& lvl)
+{
+    out = LvlLogPrefix::operator()(lvl) + QDateTime::currentDateTime().toString ("MMM dd hh:mm:ss") + QString(" ");
+    return out;
+}
+
+LvlTimePidLogPrefix::LvlTimePidLogPrefix()
+{
+    stPid = QString("[%1] ").arg(getpid());
+}
+
+const QString& LvlTimePidLogPrefix::operator ()(const LogLevel& lvl)
+{
+    out = LvlTimeLogPrefix::operator ()(lvl) + stPid;
+    return out;
+}
diff --git a/src/libraries/qtopiamail/support/qlogsystem.h b/src/libraries/qtopiamail/support/qlogsystem.h
new file mode 100644
index 0000000..7df3b13
--- /dev/null
+++ b/src/libraries/qtopiamail/support/qlogsystem.h
@@ -0,0 +1,191 @@
+/****************************************************************************
+**
+** Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
+** Contact: Nokia Corporation (qt-info@nokia.com)
+**
+** This file is part of the Qt Messaging Framework.
+**
+** $QT_BEGIN_LICENSE:LGPL$
+** No Commercial Usage
+** This file contains pre-release code and may not be distributed.
+** You may use this file in accordance with the terms and conditions
+** contained in the either Technology Preview License Agreement or the
+** Beta Release License Agreement.
+**
+** GNU Lesser General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU Lesser
+** General Public License version 2.1 as published by the Free Software
+** Foundation and appearing in the file LICENSE.LGPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU Lesser General Public License version 2.1 requirements
+** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
+**
+** In addition, as a special exception, Nokia gives you certain
+** additional rights. These rights are described in the Nokia Qt LGPL
+** Exception version 1.0, included in the file LGPL_EXCEPTION.txt in this
+** package.
+**
+** GNU General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU
+** General Public License version 3.0 as published by the Free Software
+** Foundation and appearing in the file LICENSE.GPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU General Public License version 3.0 requirements will be
+** met: http://www.gnu.org/copyleft/gpl.html.
+**
+** If you are unsure which license is appropriate for your use, please
+** contact the sales department at qt-sales@nokia.com.
+** $QT_END_LICENSE$
+**
+****************************************************************************/
+
+#ifndef QLOGSYSTEM_H
+#define QLOGSYSTEM_H
+
+#include "qmailglobal.h"
+#include <QtDebug>
+
+#include <QTextStream>
+#include <QString>
+#include <iostream>
+#include <list>
+
+extern "C"
+{
+#include <stdarg.h>
+#include <errno.h>
+};
+
+/// This enumeration represents different widely-used log levels
+typedef enum {
+    /// Debug message
+    LlDbg = 0,
+    /// Informational message
+    LlInfo,
+    /// Warning message
+    LlWarning,
+    /// Error message
+    LlError,
+    /// Critical error message
+    LlCritical
+} LogLevel;
+
+/// This is the logger interface for all Logsystem loggers. Never delete added loggers!!!
+class QTOPIAMAIL_EXPORT ILogger
+{
+public:
+    /// method invoked by the LogSystem instance
+    virtual void log(LogLevel lvl, const char* fmt, va_list args)  = 0;
+    virtual ~ILogger()  { }
+};
+
+/*! \brief This is a logging system class.
+
+     The LogSystem class is a singletone storage of loggers.
+     The core logging function is called log and it appeals to all contained loggers.
+
+     The LogSystem class should be initialized at the beginning of the application, before
+     any log output is issued.
+     This class forwards standard Qt log functions e.g. qWarning, qDebug, ect.
+
+     Never delete added loggers!!!
+
+     The LogSystem is not thread safe!!!
+*/
+class QTOPIAMAIL_EXPORT LogSystem
+{
+public:
+    /// singleton access
+    static LogSystem& getInstance()
+    {
+        static LogSystem instance;
+        return instance;
+    }
+    /// Standard destructor
+    ~LogSystem();
+    /*!
+      \brief Simple log function. It looks (almost) like printf.
+
+      \param _lvl Log level
+
+      \param _fmt Log string format. Its specifications depends on real logger used but usually it equals to
+             printf format specification.
+    */
+    void log(LogLevel lvl, const char* fmt, ...) ;
+
+    /// Adds new logger to the system
+    void addLogger(ILogger* logger);
+
+    /// Removes all loggers from the system
+    void clear();
+
+protected:
+    static void debugMsgFwd(QtMsgType type, const char *msg);
+
+
+private:
+    /// Do not allow to create new instance of that class
+    LogSystem();
+    
+    Q_DISABLE_COPY(LogSystem);
+
+    QList<ILogger*> loggers;
+
+};
+
+/// Log prefix policy - no prefix (log messages are not prefixed by anything)
+class QTOPIAMAIL_EXPORT NoLogPrefix
+{
+public:
+    /// Returns empty string (empty prefix)
+    const QString& operator()(const LogLevel& lvl);
+
+private:
+    /// Empty strings
+    QString empty;
+};
+
+/// Log prefix policy - log level prefix (log messages are prefixed by log level)
+class QTOPIAMAIL_EXPORT LvlLogPrefix
+{
+public:
+    /// Initialization
+    LvlLogPrefix();
+    /// Returns textual representation of the log level
+    const QString& operator()(const LogLevel& lvl);
+
+private:
+    /// Buffer to store the textual representation of the log level
+    QString out;
+    /// Maps log levels to their textual representation
+    QMap<LogLevel, QString> levels_str;
+};
+
+/// Log prefix policy - log level & time prefix (log messages are prefixed by log level and time of the message) 
+class QTOPIAMAIL_EXPORT LvlTimeLogPrefix : public LvlLogPrefix
+{
+public:
+    /// Returns textual representation of the log level and current date/time
+    const QString& operator()(const LogLevel& lvl);
+
+private:
+    QString out;
+};
+
+/// Log prefix policy - log level & time prefix & PID
+class QTOPIAMAIL_EXPORT LvlTimePidLogPrefix: public LvlTimeLogPrefix
+{
+public:
+    /// Initialization
+    LvlTimePidLogPrefix();
+    /// returns textural reprezentation of PID
+    const QString& operator()(const LogLevel& lvl);
+
+private:
+    QString stPid;
+    QString out;
+
+};
+
+
+#endif // QLOGSYSTEM_H
diff --git a/src/libraries/qtopiamail/support/qmaillog.h b/src/libraries/qtopiamail/support/qmaillog.h
index fae4f9e..f57e0a4 100644
--- a/src/libraries/qtopiamail/support/qmaillog.h
+++ b/src/libraries/qtopiamail/support/qmaillog.h
@@ -122,6 +122,7 @@ QLOG_ENABLE(Messaging)
 QLOG_ENABLE(IMAP)
 QLOG_ENABLE(SMTP)
 QLOG_ENABLE(POP)
+QLOG_ENABLE(SPARQL)
 QLOG_DISABLE(ImapData)
 QLOG_DISABLE(MessagingState)
 #else
@@ -129,6 +130,7 @@ QLOG_DISABLE(Messaging)
 QLOG_DISABLE(IMAP)
 QLOG_DISABLE(SMTP)
 QLOG_DISABLE(POP)
+QLOG_DISABLE(SPARQL)
 QLOG_DISABLE(ImapData)
 QLOG_DISABLE(MessagingState)
 #endif
diff --git a/src/libraries/qtopiamail/support/qmailnamespace.cpp b/src/libraries/qtopiamail/support/qmailnamespace.cpp
index dd572f0..afdd6c1 100644
--- a/src/libraries/qtopiamail/support/qmailnamespace.cpp
+++ b/src/libraries/qtopiamail/support/qmailnamespace.cpp
@@ -228,7 +228,8 @@ QString QMail::pluginsPath()
     if(!pluginsEnv.isEmpty())
         return pluginsEnv + "/";
     //default to "." if no env set
-    return pluginsEnv;
+    //return pluginsEnv;
+    return "/usr/lib/qmf/";
 }
 
 /*!
@@ -272,7 +273,7 @@ QSqlDatabase QMail::createDatabase()
     QSqlDatabase db;
     if(!init)
     {
-        db = QSqlDatabase::addDatabase("QSQLITE");
+        db = QSqlDatabase::addDatabase("QSQLITE", "QMF-DATABASE");
         QDir dp(dataPath());
         if(!dp.exists())
             if(!dp.mkpath(dataPath()))
diff --git a/src/libraries/sparql/include/SparqlDatabase b/src/libraries/sparql/include/SparqlDatabase
new file mode 100644
index 0000000..ac92cb7
--- /dev/null
+++ b/src/libraries/sparql/include/SparqlDatabase
@@ -0,0 +1 @@
+#include "sparqldatabase.h"
diff --git a/src/libraries/sparql/include/SparqlQuery b/src/libraries/sparql/include/SparqlQuery
new file mode 100644
index 0000000..bf9b61e
--- /dev/null
+++ b/src/libraries/sparql/include/SparqlQuery
@@ -0,0 +1 @@
+#include "sparqlquery.h"
diff --git a/src/libraries/sparql/include/SparqlResult b/src/libraries/sparql/include/SparqlResult
new file mode 100644
index 0000000..8e66d59
--- /dev/null
+++ b/src/libraries/sparql/include/SparqlResult
@@ -0,0 +1 @@
+#include "sparqlresult.h"
diff --git a/src/libraries/sparql/include/SparqlUri b/src/libraries/sparql/include/SparqlUri
new file mode 100644
index 0000000..52d7ed8
--- /dev/null
+++ b/src/libraries/sparql/include/SparqlUri
@@ -0,0 +1 @@
+#include "sparqluri.h"
diff --git a/src/libraries/sparql/sparql.pro b/src/libraries/sparql/sparql.pro
new file mode 100644
index 0000000..322007f
--- /dev/null
+++ b/src/libraries/sparql/sparql.pro
@@ -0,0 +1,43 @@
+TEMPLATE = lib
+
+TARGET = sparql
+
+DEFINES += QMF_ENABLE_LOGGING
+
+INCLUDEPATH += . tracker ../qtopiamail ../qtopiamail/support/
+
+LIBS += -L../qtopiamail -lqtopiamail
+
+QT *= dbus
+
+# Input
+DBUS_HEADERS += tracker/registertypes.h \
+                tracker/resourcesproxy.h
+
+SPARQL_HEADERS += sparqldatabase.h \
+                  sparqlquery.h \
+                  sparqlresult.h \
+                  sparqluri.h
+
+HEADERS += $$DBUS_HEADERS $$SPARQL_HEADERS
+
+SOURCES += \
+    sparqldatabase.cpp \
+    sparqlquery.cpp \
+    sparqlresult.cpp \
+    tracker/registertypes.cpp \
+    tracker/resourcesproxy.cpp \
+    sparqluri.cpp
+
+# Install headers
+sparql_headers.files = $$SPARQL_HEADERS include/*
+sparql_headers.path  = $$QMF_INSTALL_ROOT/include/qmf
+
+dbus_headers.files = $$DBUS_HEADERS
+dbus_headers.path  = $$QMF_INSTALL_ROOT/include/qmf/tracker
+
+INSTALLS += sparql_headers dbus_headers
+
+target.path += $$QMF_INSTALL_ROOT/lib
+
+INSTALLS += target
diff --git a/src/libraries/sparql/sparqldatabase.cpp b/src/libraries/sparql/sparqldatabase.cpp
new file mode 100644
index 0000000..150ec7c
--- /dev/null
+++ b/src/libraries/sparql/sparqldatabase.cpp
@@ -0,0 +1,48 @@
+#include "sparqldatabase.h"
+
+#include <QDBusConnection>
+#include <qmaillog.h>
+
+// Pointer to the default database
+SparqlDatabase* SparqlDatabase::_defaultDatabase = NULL;
+
+
+SparqlDatabase::SparqlDatabase(const QString& databaseName) :
+        _databaseName(databaseName),
+        _proxy(databaseName, "/org/freedesktop/Tracker1/Resources", QDBusConnection::sessionBus())
+{
+    qMailLog(SPARQL) << "SparqlDatabase::SparqlDatabase";
+
+    if (!_defaultDatabase)
+    {
+        // Register Qt types
+        registerTypes();
+
+        _defaultDatabase = this;
+    }
+}
+
+SparqlDatabase::~SparqlDatabase()
+{
+    qMailLog(SPARQL) << "SparqlDatabase::~SparqlDatabase";
+
+    if (_defaultDatabase == this)
+        _defaultDatabase = NULL;
+}
+
+SparqlDatabase* SparqlDatabase::defaultDatabase()
+{
+    return _defaultDatabase;
+}
+
+QString SparqlDatabase::databaseName() const
+{
+    return _databaseName;
+}
+
+bool SparqlDatabase::isOpenError() const
+{
+    // Check wheither we are connected
+    bool isConnected = _proxy.connection().isConnected();
+    return !isConnected;
+}
diff --git a/src/libraries/sparql/sparqldatabase.h b/src/libraries/sparql/sparqldatabase.h
new file mode 100644
index 0000000..d737035
--- /dev/null
+++ b/src/libraries/sparql/sparqldatabase.h
@@ -0,0 +1,62 @@
+#ifndef SPARQLDATABASE_H
+#define SPARQLDATABASE_H
+
+#include "tracker/resourcesproxy.h"
+
+/**
+ * \brief SparqlDatabase represents connection to the SPARQL data base.
+ *
+ * SparqlDatabase represents connection to the SPARQL data base. It relies on the
+ * proxy implementation. It is possible to keep several databases opened at the same
+ * time, but only one of them will be default. All queries without exact database
+ * specification will be performed with default database.
+ *
+ * \see SparqlQuery
+ */
+class SparqlDatabase
+{
+    friend class SparqlQuery;
+
+public:
+    /**
+     * \brief Creates new database
+     *
+     * \param databaseName Name of the data base.
+     */
+    SparqlDatabase(const QString& databaseName = "org.freedesktop.Tracker1");
+
+    /**
+     * \brief Default destructor
+     */
+    ~SparqlDatabase();
+
+    /**
+     * \brief Returns default database
+     *
+     * First created database will become default one.
+     *
+     * \return Pointer to the default database.
+     */
+    static SparqlDatabase* defaultDatabase();
+
+    /**
+     * \brief Returns name of the database
+     */
+    QString databaseName() const;
+
+    /**
+     * \brief Returns true wheither there was an error during opening database.
+     */
+    bool isOpenError() const;
+
+private:
+    Q_DISABLE_COPY(SparqlDatabase);
+
+    static SparqlDatabase* _defaultDatabase;
+
+    QString _databaseName;
+
+    org::freedesktop::Tracker1::Resources _proxy;
+};
+
+#endif // SPARQLDATABASE_H
diff --git a/src/libraries/sparql/sparqlquery.cpp b/src/libraries/sparql/sparqlquery.cpp
new file mode 100644
index 0000000..d2e7932
--- /dev/null
+++ b/src/libraries/sparql/sparqlquery.cpp
@@ -0,0 +1,119 @@
+#include "sparqlquery.h"
+#include "sparqldatabase.h"
+#include "sparqlresult.h"
+
+#include <qmaillog.h>
+#include <QDBusPendingReply>
+
+SparqlQuery::SparqlQuery(SparqlQuery::QueryType type, const QString& query,  SparqlDatabase* database) :
+        _type(type),
+        _database(database),
+        _result(NULL)
+{
+    if (!_database)
+        _database = SparqlDatabase::defaultDatabase();
+
+    Q_ASSERT(_database);
+
+    prepare(query);
+}
+
+SparqlQuery::~SparqlQuery()
+{
+}
+
+bool SparqlQuery::prepare(const QString query)
+{
+    // In case of batch update, submit query to the tracker
+    // and call BatchCommit in the end.
+    if (_type == BatchUpdate)
+    {
+        QDBusPendingReply<> reply;
+        reply = _database->_proxy.BatchSparqlUpdate(query);
+
+        reply.waitForFinished();
+
+        bool err = reply.isError();
+        if (err)
+            _error = reply.error().message();
+
+        _query += query;
+
+        return !err;
+    }
+
+    // In case of ordinary query, just assign the value.
+    _query = query;
+
+    return true;
+}
+
+bool SparqlQuery::exec()
+{
+    Q_ASSERT(_database);
+
+    // Clear last error status and query result
+    _result.clear();
+    _error.clear();
+
+    qMailLog(SPARQL) << "SparqlQuery::exec():" << _query;
+
+    bool err = true;
+    if (_type == SearchQuery)
+    {
+        QDBusPendingReply<QueryResultType> reply;
+        reply = _database->_proxy.SparqlQuery(_query);
+
+        reply.waitForFinished();
+
+        err = reply.isError();
+        if (!err)
+        {
+            _result = reply.value();
+
+        } else
+            _error = reply.error().message();
+
+    } else if (_type == UpdateQuery) {
+
+        QDBusPendingReply<> reply;
+        reply = _database->_proxy.SparqlUpdate(_query);
+
+        reply.waitForFinished();
+
+        err = reply.isError();
+        if (err)
+            _error = reply.error().message();
+
+    } else if (_type == BatchUpdate) {
+
+        QDBusPendingReply<> reply;
+        reply = _database->_proxy.BatchCommit();
+
+        reply.waitForFinished();
+
+        err = reply.isError();
+        if (err)
+            _error = reply.error().message();
+
+    } else {
+        Q_ASSERT(false);
+    }
+
+    return !err;
+}
+
+SparqlResult SparqlQuery::result() const
+{
+    return SparqlResult(this);
+}
+
+QString SparqlQuery::error() const
+{
+    return _error;
+}
+
+QString SparqlQuery::query() const
+{
+    return _query;
+}
diff --git a/src/libraries/sparql/sparqlquery.h b/src/libraries/sparql/sparqlquery.h
new file mode 100644
index 0000000..dbb0323
--- /dev/null
+++ b/src/libraries/sparql/sparqlquery.h
@@ -0,0 +1,103 @@
+#ifndef SPARQLQUERY_H
+#define SPARQLQUERY_H
+
+#include <QStringList>
+#include <QVector>
+#include <QString>
+
+class SparqlDatabase;
+class SparqlResult;
+
+/**
+ * \brief SparqlQuery represents SPARQL query.
+ *
+ * There are two different types of queries: search and update queries. Search query uses standard SPARQL syntax
+ * and can only read information from the database. Update queries exploit Advanced SPARQL syntax and allow to
+ * insert, delete and update information in the database.
+ *
+ * Database can be defeined explicitely or default database can be used. In anycase at least one SparqlDatabase
+ * object must be created.
+ *
+ * \see SparqlDatabase
+ */
+class SparqlQuery
+{
+    friend class SparqlResult;
+
+public:
+    /**
+     * \brief Type of the query
+     */
+    enum QueryType
+    {
+        SearchQuery,  ///< Query can use SELECT, CONSTRUCT, DESCRIBE or ASK SPARQL statment
+        UpdateQuery,  ///< Query can use INSERT, DELETE and UPDATE advances SPARQL statment
+        BatchUpdate,  ///< Batch update query can use INSERT, DELETE and UPDATE SPARQL statments several times per request
+    };
+
+    /**
+     * \brief Constructs SPARQL query
+     *
+     * \param type Type of the quey.
+     * \param query Query string, It can be defined later with prepare() method.
+     * \param database Pointer to the database. Default database will be used in case of NULL.
+     */
+    SparqlQuery(QueryType type, const QString& query = QString(),  SparqlDatabase* database = NULL);
+
+     /**
+      * \brief Default destructor
+      */
+    ~SparqlQuery();
+
+    /**
+     * \brief Prepare query for execution
+     *
+     * \param SPARQL query to prepare.
+     * \return Status of the application.
+     */
+    bool prepare(const QString query);
+
+    /**
+     * \brief Execute prepared query
+     *
+     * Before executing a query it has to be prepared using prepare() method.
+     * In case of any errors exec() will return false. More detailes information
+     * about source of error can be retrieved using error() method.
+     *
+     * Result of query execution can be retrieved using result() method.
+     * Retult is available only for Search queries.
+     *
+     * \return true in case of success and false in case of failure.
+     */
+    bool exec();
+
+    /**
+     * \brief Returns result of the operation
+     *
+     * \return result can be NULL in case of error or Update query was executed.
+     */
+    SparqlResult result() const;
+
+    /**
+     * \brief Returns textual representation of the error.
+     *
+     * \return Literal error description.
+     */
+    QString error() const;
+
+    /**
+     * \brief Returns prepared SPARQL query to execute.
+     */
+    QString query() const;
+
+private:
+    QueryType       _type;
+    QString         _query;
+    SparqlDatabase* _database;
+    QString         _error;
+
+    typedef QVector<QStringList> QueryResultType;
+    QueryResultType _result;
+};
+
+#endif // SPARQLQUERY_H
diff --git a/src/libraries/sparql/sparqlresult.cpp b/src/libraries/sparql/sparqlresult.cpp
new file mode 100644
index 0000000..2d13851
--- /dev/null
+++ b/src/libraries/sparql/sparqlresult.cpp
@@ -0,0 +1,34 @@
+#include "sparqlresult.h"
+#include "sparqlquery.h"
+
+#include <qmaillog.h>
+
+SparqlResult::SparqlResult(const SparqlQuery* query) :
+        _query(query),
+        _current(0)
+{
+}
+
+const QStringList& SparqlResult::fetchRow()
+{
+    Q_ASSERT(_query);
+
+    qMailLog(SPARQL) << "SparqlResult::fetchRow():" << _query->_result.at(_current);
+    return _query->_result.at(_current++);
+}
+
+bool SparqlResult::begin() const
+{
+    return (_current == 0);
+}
+
+bool SparqlResult::end() const
+{
+    Q_ASSERT(_query);
+    return (_query->_result.count() == _current);
+}
+
+void SparqlResult::reset()
+{
+    _current = 0;
+}
diff --git a/src/libraries/sparql/sparqlresult.h b/src/libraries/sparql/sparqlresult.h
new file mode 100644
index 0000000..2c9be91
--- /dev/null
+++ b/src/libraries/sparql/sparqlresult.h
@@ -0,0 +1,56 @@
+#ifndef SPARQLRESULT_H
+#define SPARQLRESULT_H
+
+#include <QVector>
+#include <QStringList>
+
+class SparqlQuery;
+
+/**
+ * \brief SparqlResult provides convenient way to fetch data from the executed query.
+ *
+ * To fetch data from already executed query you have to get instance of that class
+ * with SparqlQuery::result() method and call fetchRow() method till you reach the end().
+ *
+ * It is possible to enumerate result of the query using different instances of the
+ * SparqlResult class at the same time. But you have to know that data itself belongs
+ * to the query and you should not access any methods of this class in case of SparqlQuery
+ * was destroyed.
+ *
+ * \see SparqlQuery
+ */
+class SparqlResult
+{
+    friend class SparqlQuery;
+
+public:
+    /**
+     * \brief Fetch the row with results of the query
+     *
+     * \return List of values of the row.
+     */
+    const QStringList& fetchRow();
+
+    /**
+     * \brief Does the result point to the beginig of data set
+     */
+    bool begin() const;
+
+    /**
+     * \brief Does the result point to the end of the data set
+     */
+    bool end() const;
+
+    /**
+     * \brief Reset result and make it points to the begining again
+     */
+    void reset();
+
+private:
+    SparqlResult(const SparqlQuery* query);
+    const SparqlQuery* _query;
+
+    int _current;
+};
+
+#endif // SPARQLRESULT_H
diff --git a/src/libraries/sparql/sparqluri.cpp b/src/libraries/sparql/sparqluri.cpp
new file mode 100644
index 0000000..fcd52e2
--- /dev/null
+++ b/src/libraries/sparql/sparqluri.cpp
@@ -0,0 +1,90 @@
+#include "sparqluri.h"
+#include <QUuid>
+
+SparqlUri::SparqlUri(const QString& base) :
+        _id(generate())
+{
+    bool ret = setBase(base);
+    Q_UNUSED(ret);
+    Q_ASSERT(ret);
+}
+
+SparqlUri::SparqlUri(const QString& base, quint64 id) :
+        _id(id)
+{
+    bool ret = setBase(base);
+    Q_UNUSED(ret);
+    Q_ASSERT(ret);
+}
+
+bool SparqlUri::setBase(const QString& base)
+{
+    _base = base;
+    return true;
+}
+
+QString SparqlUri::base() const
+{
+    return _base;
+}
+
+QString SparqlUri::uri() const
+{
+    return QString("<%1>").arg(base() + QString::number(_id));
+}
+
+void SparqlUri::setId(quint64 id)
+{
+    _id = id;
+}
+
+quint64 SparqlUri::id() const
+{
+    return _id;
+}
+
+quint64 SparqlUri::generate()
+{
+    /*
+     * BUG!BUG!BUG!
+     *
+     * We can't just generate UUID and do not make
+     * sure that it is unique.
+     *
+     * THIS CODE HAS TO BE REWRITTEN.
+     */
+    QUuid uuid = QUuid::createUuid();
+
+    quint64 data1 = uuid.data1;
+    quint64 data2 = uuid.data2;
+    quint64 data3 = uuid.data3;
+    quint64 data4 = *(quint64*)uuid.data4;
+
+    quint64 id = (data1 << 32) ^ (data2 << 16) ^ data3;
+    id |= data4;
+
+    return id;
+}
+
+SparqlUri::operator QString () const
+{
+    return uri();
+}
+
+SparqlUri::operator quint64 () const
+{
+    return id();
+}
+
+QString SparqlUri::operator++ ()
+{
+    _id = generate();
+    return uri();
+}
+
+QString SparqlUri::operator++ (int)
+{
+    QString result(uri());
+    _id = generate();
+    return result;
+}
diff --git a/src/libraries/sparql/sparqluri.h b/src/libraries/sparql/sparqluri.h
new file mode 100644
index 0000000..44aeab1
--- /dev/null
+++ b/src/libraries/sparql/sparqluri.h
@@ -0,0 +1,102 @@
+#ifndef SPARQLURI_H
+#define SPARQLURI_H
+
+#include "sparqldatabase.h"
+
+/**
+ * \brief SparqlUri provides automatic URI generation.
+ *
+ * URI is unique identifier in the SPARQL language, it is required
+ * to be able to generate unique identifiers fast and easy. SparqlUri class
+ * provides convenient way to generate such URI.
+ *
+ * Every URI has base part and autogenerated part. Base part can be defined by user.
+ * Autogenerated part will be changed with every increment operation.
+ *
+ * Autogenerate URI will look like http://base.part/is/fixed#nnnnnn, where nnnnnn is 64bit
+ * integer, No any prediction is made about order or number of digits in the nnnnnn.
+ *
+ * \see SparqlQuery
+ */
+class SparqlUri
+{
+public:
+    /**
+     * \brief Constructor of the URI
+     *
+     * Unique id will be autogenerated.
+     *
+     * \param base Fixed part of the URI.
+     */
+    SparqlUri(const QString& base);
+
+    /**
+     * \brief Constructor of the URI generator
+     *
+     * Value of id is passed as a parameter
+     *
+     * \param base Fixed part of the URI.
+     * \param id Pre-defined id is used in this case.
+     */
+    SparqlUri(const QString& base, quint64 id);
+
+    /**
+     * \brief Set new fixed base of the URI
+     */
+    bool setBase(const QString& base);
+
+    /**
+     * \brief Get fixed base part of the URI
+     */
+    QString base() const;
+
+    /**
+     * \brief Get current URI as a string
+     */
+    void setId(quint64 id);
+
+    /**
+     * \brief Set current nnnnnn part as 64-bit integer
+     */
+    quint64 id() const;
+
+    /**
+     * \brief Get current nnnnnn part as 64-bit integer
+     */
+    QString uri() const;
+
+    /**
+     * \brief Generates new nnnnnn.
+     *
+     * Current URI is not updated. To update current URI as well operator++ should be used.
+     *
+     * \return new nnnnnn part of the URI as 64-bit unsigned integer.
+     */
+    quint64 generate();
+
+    /**
+     * \brief Convenience operator returns URI
+     */
+    operator QString () const;
+
+    /**
+     * \brief Convenience operator returns nnnnnn part of the URI
+     */
+    operator quint64 () const;
+
+    /**
+     * \brief Generates new URI and returns new value
+     */
+    QString operator++ ();
+
+    /**
+     * \brief Generates new URI and returns old value
+     */
+    QString operator++ (int);
+
+private:
+    QString _base;
+    quint64 _id;
+};
+
+#endif // #ifndef SPARQLURI_H
diff --git a/src/libraries/sparql/tracker/README b/src/libraries/sparql/tracker/README
new file mode 100644
index 0000000..9b8b88a
--- /dev/null
+++ b/src/libraries/sparql/tracker/README
@@ -0,0 +1,20 @@
+
+HOWTO Generate proxy code from DBUSXML interface definition
+
+ Obtain latest version of the .xml files from the tracker repository
+   git://git.codethink.co.uk/git/tracker
+   
+   Backup existing .xml files and code of the DBUS proxy classes.
+   
+ Update XML interface description with correct annotations for all Qt types:
+  * For every type="aas" direction="out", add following annotation:
+    <annotation name="com.trolltech.QtDBus.QtTypeName.Out0" value="QVector&lt;QStringList&gt;"/>
+
+  * For every type="a{sv}" direction="out", add following annotation:
+    <annotation name="com.trolltech.QtDBus.QtTypeName.Out0" value="QVariantList"/>
+
+  * For every signal with type="aas", add following annotation:
+    <annotation name="com.trolltech.QtDBus.QtTypeName.In0" value="QVector&lt;QStringList&gt;"/>
+
+ Run genproxy.sh script
+ 
diff --git a/src/libraries/sparql/tracker/genproxy.sh b/src/libraries/sparql/tracker/genproxy.sh
new file mode 100755
index 0000000..4d4f089
--- /dev/null
+++ b/src/libraries/sparql/tracker/genproxy.sh
@@ -0,0 +1,2 @@
+#!/bin/bash
+qdbusxml2cpp -c ResourcesProxy -p resourcesproxy -i registertypes.h tracker-resources.xml org.freedesktop.Tracker1.Resources
diff --git a/src/libraries/sparql/tracker/registertypes.cpp b/src/libraries/sparql/tracker/registertypes.cpp
new file mode 100644
index 0000000..e8ce4ed
--- /dev/null
+++ b/src/libraries/sparql/tracker/registertypes.cpp
@@ -0,0 +1,10 @@
+#include <QDBusMetaType>
+#include <QtDebug>
+
+#include "registertypes.h"
+
+void registerTypes()
+{
+    qRegisterMetaType<QVector<QStringList> >();
+    qDBusRegisterMetaType<QVector<QStringList> >();
+}
diff --git a/src/libraries/sparql/tracker/registertypes.h b/src/libraries/sparql/tracker/registertypes.h
new file mode 100644
index 0000000..5c87c3f
--- /dev/null
+++ b/src/libraries/sparql/tracker/registertypes.h
@@ -0,0 +1,12 @@
+#ifndef __REGISTERTYPES_H__
+#define __REGISTERTYPES_H__
+
+#include <QMetaType>
+#include <QVector>
+#include <QStringList>
+
+Q_DECLARE_METATYPE(QVector<QStringList>)
+
+void registerTypes();
+
+#endif // #ifndef __REGISTERTYPES_H__
diff --git a/src/libraries/sparql/tracker/resourcesproxy.cpp b/src/libraries/sparql/tracker/resourcesproxy.cpp
new file mode 100644
index 0000000..02d44c4
--- /dev/null
+++ b/src/libraries/sparql/tracker/resourcesproxy.cpp
@@ -0,0 +1,26 @@
+/*
+ * This file was generated by qdbusxml2cpp version 0.7
+ * Command line was: qdbusxml2cpp -c ResourcesProxy -p resourcesproxy -i registertypes.h tracker-resources.xml org.freedesktop.Tracker1.Resources
+ *
+ * qdbusxml2cpp is Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
+ *
+ * This is an auto-generated file.
+ * This file may have been hand-edited. Look for HAND-EDIT comments
+ * before re-generating it.
+ */
+
+#include "resourcesproxy.h"
+
+/*
+ * Implementation of interface class ResourcesProxy
+ */
+
+ResourcesProxy::ResourcesProxy(const QString &service, const QString &path, const QDBusConnection &connection, QObject *parent)
+    : QDBusAbstractInterface(service, path, staticInterfaceName(), connection, parent)
+{
+}
+
+ResourcesProxy::~ResourcesProxy()
+{
+}
+
diff --git a/src/libraries/sparql/tracker/resourcesproxy.h b/src/libraries/sparql/tracker/resourcesproxy.h
new file mode 100644
index 0000000..8c5c024
--- /dev/null
+++ b/src/libraries/sparql/tracker/resourcesproxy.h
@@ -0,0 +1,98 @@
+/*
+ * This file was generated by qdbusxml2cpp version 0.7
+ * Command line was: qdbusxml2cpp -c ResourcesProxy -p resourcesproxy -i registertypes.h tracker-resources.xml org.freedesktop.Tracker1.Resources
+ *
+ * qdbusxml2cpp is Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
+ *
+ * This is an auto-generated file.
+ * Do not edit! All changes made to it will be lost.
+ */
+
+#ifndef RESOURCESPROXY_H_1258731356
+#define RESOURCESPROXY_H_1258731356
+
+#include <QtCore/QObject>
+#include <QtCore/QByteArray>
+#include <QtCore/QList>
+#include <QtCore/QMap>
+#include <QtCore/QString>
+#include <QtCore/QStringList>
+#include <QtCore/QVariant>
+#include <QtDBus/QtDBus>
+#include "registertypes.h"
+
+/*
+ * Proxy class for interface org.freedesktop.Tracker1.Resources
+ */
+class ResourcesProxy: public QDBusAbstractInterface
+{
+    Q_OBJECT
+public:
+    static inline const char *staticInterfaceName()
+    { return "org.freedesktop.Tracker1.Resources"; }
+
+public:
+    ResourcesProxy(const QString &service, const QString &path, const QDBusConnection &connection, QObject *parent = 0);
+
+    ~ResourcesProxy();
+
+public Q_SLOTS: // METHODS
+    inline QDBusPendingReply<> BatchCommit()
+    {
+        QList<QVariant> argumentList;
+        return asyncCallWithArgumentList(QLatin1String("BatchCommit"), argumentList);
+    }
+
+    inline QDBusPendingReply<> BatchSparqlUpdate(const QString &query)
+    {
+        QList<QVariant> argumentList;
+        argumentList << qVariantFromValue(query);
+        return asyncCallWithArgumentList(QLatin1String("BatchSparqlUpdate"), argumentList);
+    }
+
+    inline QDBusPendingReply<> Delete(const QString &subject, const QString &predicate, const QString &object)
+    {
+        QList<QVariant> argumentList;
+        argumentList << qVariantFromValue(subject) << qVariantFromValue(predicate) << qVariantFromValue(object);
+        return asyncCallWithArgumentList(QLatin1String("Delete"), argumentList);
+    }
+
+    inline QDBusPendingReply<> Insert(const QString &subject, const QString &predicate, const QString &object)
+    {
+        QList<QVariant> argumentList;
+        argumentList << qVariantFromValue(subject) << qVariantFromValue(predicate) << qVariantFromValue(object);
+        return asyncCallWithArgumentList(QLatin1String("Insert"), argumentList);
+    }
+
+    inline QDBusPendingReply<> Load(const QString &uri)
+    {
+        QList<QVariant> argumentList;
+        argumentList << qVariantFromValue(uri);
+        return asyncCallWithArgumentList(QLatin1String("Load"), argumentList);
+    }
+
+    inline QDBusPendingReply<QVector<QStringList> > SparqlQuery(const QString &query)
+    {
+        QList<QVariant> argumentList;
+        argumentList << qVariantFromValue(query);
+        return asyncCallWithArgumentList(QLatin1String("SparqlQuery"), argumentList);
+    }
+
+    inline QDBusPendingReply<> SparqlUpdate(const QString &query)
+    {
+        QList<QVariant> argumentList;
+        argumentList << qVariantFromValue(query);
+        return asyncCallWithArgumentList(QLatin1String("SparqlUpdate"), argumentList);
+    }
+
+Q_SIGNALS: // SIGNALS
+};
+
+namespace org {
+  namespace freedesktop {
+    namespace Tracker1 {
+      typedef ::ResourcesProxy Resources;
+    }
+  }
+}
+#endif
diff --git a/src/libraries/sparql/tracker/tracker-resources.xml b/src/libraries/sparql/tracker/tracker-resources.xml
new file mode 100644
index 0000000..9a2d59a
--- /dev/null
+++ b/src/libraries/sparql/tracker/tracker-resources.xml
@@ -0,0 +1,57 @@
+<?xml version="1.0" encoding="UTF-8"?>
+
+<node name="/org/freedesktop/Tracker1">
+  <interface name="org.freedesktop.Tracker1.Resources">
+
+    <!-- Insert single statement -->
+    <method name="Insert">
+      <annotation name="org.freedesktop.DBus.GLib.Async" value="true"/> 
+      <arg type="s" name="subject" direction="in" />
+      <arg type="s" name="predicate" direction="in" />
+      <arg type="s" name="object" direction="in" />
+    </method>
+
+    <!-- Delete single statement -->
+    <method name="Delete">
+      <annotation name="org.freedesktop.DBus.GLib.Async" value="true"/> 
+      <arg type="s" name="subject" direction="in" />
+      <arg type="s" name="predicate" direction="in" />
+      <arg type="s" name="object" direction="in" />
+    </method>
+
+    <!-- Load statements from Turtle file -->
+    <method name="Load">
+      <annotation name="org.freedesktop.DBus.GLib.Async" value="true"/> 
+      <arg type="s" name="uri" direction="in" />
+    </method>
+
+    <!-- SPARQL Query without updates -->
+    <method name="SparqlQuery">
+      <annotation name="org.freedesktop.DBus.GLib.Async" value="true"/>
+      <annotation name="com.trolltech.QtDBus.QtTypeName.Out0" 
+		  value="QVector&lt;QStringList&gt;"/>
+      <arg type="s" name="query" direction="in" />
+      <arg type="aas" name="result" direction="out" />
+    </method>
+
+    <!-- SPARQL Update extensions, insert and delete -->
+    <method name="SparqlUpdate">
+      <annotation name="org.freedesktop.DBus.GLib.Async" value="true"/>
+      <arg type="s" name="query" direction="in" />
+    </method>
+
+    <!-- SPARQL Update as part of a batch, use this method when sending a
+         possibly large amount of updates to improve performance, may delay
+         database commit until receiving BatchCommit -->
+    <method name="BatchSparqlUpdate">
+      <annotation name="org.freedesktop.DBus.GLib.Async" value="true"/>
+      <arg type="s" name="query" direction="in" />
+    </method>
+
+    <!-- Commits pending updates to the database -->
+    <method name="BatchCommit">
+      <annotation name="org.freedesktop.DBus.GLib.Async" value="true"/>
+    </method>
+
+  </interface>
+</node>
diff --git a/src/tools/messageserver/etc/event.d/messageserver b/src/tools/messageserver/etc/event.d/messageserver
new file mode 100644
index 0000000..b1e8a21
--- /dev/null
+++ b/src/tools/messageserver/etc/event.d/messageserver
@@ -0,0 +1,13 @@
+description "QMF Message Server"
+author "Dmitry Zelenkovsky"
+
+console none
+
+start on XSESSIONS_STARTING
+stop on stopped xomap
+
+respawn
+
+
+exec su - user -c "DISPLAY=:0 /usr/bin/messageserver"
+
diff --git a/src/tools/messageserver/main.cpp b/src/tools/messageserver/main.cpp
index 952b267..03d6e35 100644
--- a/src/tools/messageserver/main.cpp
+++ b/src/tools/messageserver/main.cpp
@@ -40,7 +40,8 @@
 ****************************************************************************/
 
 #include "messageserver.h"
-#include <QApplication>
+#include "sparqlindexer.h"
+#include <QCoreApplication>
 #include <QDebug>
 #include <qmailnamespace.h>
 
@@ -60,11 +61,10 @@ static void shutdown(int n)
 
 int main(int argc, char** argv)
 {
-
     if(QMail::fileLock("messageserver-instance.lock") == -1)
         qFatal("Could not get messageserver lock. Messageserver might already be running!");
 
-    QApplication app(argc, argv);
+    QCoreApplication app(argc, argv);
 
     MessageServer server;
 
diff --git a/src/tools/messageserver/messageserver.cpp b/src/tools/messageserver/messageserver.cpp
index e077ce7..6e9396c 100644
--- a/src/tools/messageserver/messageserver.cpp
+++ b/src/tools/messageserver/messageserver.cpp
@@ -42,6 +42,7 @@
 #include "messageserver.h"
 #include "servicehandler.h"
 #include "mailmessageclient.h"
+#include "sparqlindexer.h"
 #include <qmailfolder.h>
 #include <qmailmessage.h>
 #include <qmailstore.h>
@@ -57,7 +58,8 @@ MessageServer::MessageServer(QObject *parent)
       client(new MailMessageClient(this)),
       messageCountUpdate("QPE/Messages/MessageCountUpdated"),
       newMessageTotal(0),
-      completionAttempted(false)
+      completionAttempted(false),
+      indexer(NULL)
 {
     qMailLog(Messaging) << "MessageServer ctor begin";
     new QCopServer(this);
@@ -71,6 +73,17 @@ MessageServer::MessageServer(QObject *parent)
         qFatal("Messaging DB Invalid: Messaging cannot operate due to database incompatibilty!");
         // Do not close, however, or QPE will start another instance.
     } else {
+        indexer = new SparqlIndexer(this);
+
+        // Connect singlas from store to SPARQL indexer handlers
+        connect(store, SIGNAL(accountsAdded(QMailAccountIdList)),   indexer, SLOT(addAccounts(QMailAccountIdList)));
+        connect(store, SIGNAL(accountsUpdated(QMailAccountIdList)), indexer, SLOT(updateAccounts(QMailAccountIdList)));
+        connect(store, SIGNAL(accountsRemoved(QMailAccountIdList)), indexer, SLOT(removeAccounts(QMailAccountIdList)));
+
+        connect(store, SIGNAL(foldersAdded(QMailFolderIdList)),   indexer, SLOT(addFolders(QMailFolderIdList)));
+        connect(store, SIGNAL(foldersUpdated(QMailFolderIdList)), indexer, SLOT(updateFolders(QMailFolderIdList)));
+        connect(store, SIGNAL(foldersRemoved(QMailFolderIdList)), indexer, SLOT(removeFolders(QMailFolderIdList)));
+
         handler = new ServiceHandler(this);
 
         connect(store, SIGNAL(messagesAdded(QMailMessageIdList)),
@@ -89,13 +102,13 @@ MessageServer::MessageServer(QObject *parent)
                 client, SIGNAL(statusChanged(quint64, const QMailServiceAction::Status)));
         connect(handler, SIGNAL(progressChanged(quint64, uint, uint)),
                 client, SIGNAL(progressChanged(quint64, uint, uint)));
-        connect(handler, SIGNAL(messagesDeleted(quint64, QMailMessageIdList)), 
+        connect(handler, SIGNAL(messagesDeleted(quint64, QMailMessageIdList)),
                 client, SIGNAL(messagesDeleted(quint64, QMailMessageIdList)));
-        connect(handler, SIGNAL(messagesCopied(quint64, QMailMessageIdList)), 
+        connect(handler, SIGNAL(messagesCopied(quint64, QMailMessageIdList)),
                 client, SIGNAL(messagesCopied(quint64, QMailMessageIdList)));
-        connect(handler, SIGNAL(messagesMoved(quint64, QMailMessageIdList)), 
+        connect(handler, SIGNAL(messagesMoved(quint64, QMailMessageIdList)),
                 client, SIGNAL(messagesMoved(quint64, QMailMessageIdList)));
-        connect(handler, SIGNAL(messagesFlagged(quint64, QMailMessageIdList)), 
+        connect(handler, SIGNAL(messagesFlagged(quint64, QMailMessageIdList)),
                 client, SIGNAL(messagesFlagged(quint64, QMailMessageIdList)));
         connect(handler, SIGNAL(folderCreated(quint64, QMailFolderId)),
                 client, SIGNAL(folderCreated(quint64, QMailFolderId)));
@@ -105,18 +118,18 @@ MessageServer::MessageServer(QObject *parent)
                 client, SIGNAL(folderDeleted(quint64, QMailFolderId)));
         connect(handler, SIGNAL(storageActionCompleted(quint64)),
                 client, SIGNAL(storageActionCompleted(quint64)));
-        connect(handler, SIGNAL(matchingMessageIds(quint64, QMailMessageIdList)), 
+        connect(handler, SIGNAL(matchingMessageIds(quint64, QMailMessageIdList)),
                 client, SIGNAL(matchingMessageIds(quint64, QMailMessageIdList)));
         connect(handler, SIGNAL(searchCompleted(quint64)),
                 client, SIGNAL(searchCompleted(quint64)));
-        connect(handler, SIGNAL(protocolResponse(quint64, QString, QVariant)), 
+        connect(handler, SIGNAL(protocolResponse(quint64, QString, QVariant)),
                 client, SIGNAL(protocolResponse(quint64, QString, QVariant)));
         connect(handler, SIGNAL(protocolRequestCompleted(quint64)),
                 client, SIGNAL(protocolRequestCompleted(quint64)));
-        connect(handler, SIGNAL(messagesTransmitted(quint64, QMailMessageIdList)), 
+        connect(handler, SIGNAL(messagesTransmitted(quint64, QMailMessageIdList)),
                 client, SIGNAL(messagesTransmitted(quint64, QMailMessageIdList)));
 
-        connect(handler, SIGNAL(transmissionCompleted(quint64)), 
+        connect(handler, SIGNAL(transmissionCompleted(quint64)),
                 this, SLOT(transmissionCompleted(quint64)));
         connect(handler, SIGNAL(retrievalCompleted(quint64)),
                 this, SLOT(retrievalCompleted(quint64)));
@@ -166,7 +179,7 @@ MessageServer::MessageServer(QObject *parent)
                 handler, SLOT(cancelSearch(quint64)));
         connect(client, SIGNAL(shutdown()),
                 handler, SLOT(shutdown()));
-       connect(handler, SIGNAL(newMessagesAvailable()),
+        connect(handler, SIGNAL(newMessagesAvailable()),
                 this, SLOT(reportNewCounts()));
         connect(client, SIGNAL(acknowledgeNewMessages(QMailMessageTypeList)),
                 this, SLOT(acknowledgeNewMessages(QMailMessageTypeList)));
@@ -353,11 +366,20 @@ void MessageServer::messagesAdded(const QMailMessageIdList &ids)
                     message.content() == QMailMessage::VideomailContent) {
                     complete = true;
                 }
+
             }
 
             if (complete)
                 completionList.insert(message.id());
+
+            // Index content of newly added messages
+            indexer->addMessageMetaData(message);
         }
+
+    } else {
+        // Index content of received messages
+        indexer->addMessages(ids);
+
     }
 }
 
@@ -366,16 +388,22 @@ void MessageServer::messagesUpdated(const QMailMessageIdList &ids)
     if (QMailStore::instance()->asynchronousEmission()) {
         // Only need to check message counts if the update occurred in another process
         updateNewMessageCounts();
+
+        // Update messages in the index
+        indexer->updateMessages(ids);
     } else {
         // If we're updating, check whether the messages have been marked as Removed
         foreach (const QMailMessageId &id, ids) {
+            QMailMessageMetaData message(id);
             if (completionList.contains(id)) {
-                QMailMessageMetaData message(id);
                 if ((message.status() & QMailMessage::ContentAvailable) || (message.status() & QMailMessage::Removed)) {
                     // This message has been completed (or removed)
                     completionList.remove(id);
                 }
             }
+
+            // Update information in the index
+            indexer->updateMessageMetaData(message);
         }
     }
 }
@@ -388,6 +416,9 @@ void MessageServer::messagesRemoved(const QMailMessageIdList &ids)
     }
 
     updateNewMessageCounts();
+
+    // Remove messages from index
+    indexer->removeMessages(ids);
 }
 
 void MessageServer::updateNewMessageCounts()
diff --git a/src/tools/messageserver/messageserver.h b/src/tools/messageserver/messageserver.h
index 508752a..f7cd380 100644
--- a/src/tools/messageserver/messageserver.h
+++ b/src/tools/messageserver/messageserver.h
@@ -52,6 +52,7 @@ class QDSData;
 class QMailMessageMetaData;
 class QNetworkState;
 class NewCountNotifier;
+class SparqlIndexer;
 
 class MessageServer : public QObject
 {
@@ -93,6 +94,7 @@ private:
 
     QSet<QMailMessageId> completionList;
     bool completionAttempted;
+    SparqlIndexer *indexer;
 };
 
 #endif
diff --git a/src/tools/messageserver/messageserver.pro b/src/tools/messageserver/messageserver.pro
index 6216729..b04ad88 100644
--- a/src/tools/messageserver/messageserver.pro
+++ b/src/tools/messageserver/messageserver.pro
@@ -2,6 +2,9 @@ TEMPLATE = app
 
 include(../../../common.pri)
 
+CONFIG -= x11
+CONFIG += console
+
 TARGET = messageserver
 target.path += $$QMF_INSTALL_ROOT/bin
 INSTALLS += target
@@ -10,22 +13,26 @@ DEPENDPATH += .
 
 INCLUDEPATH += . ../../libraries/qtopiamail \
                  ../../libraries/qtopiamail/support \
-                 ../../libraries/messageserver
+                 ../../libraries/messageserver \
+                 ../../libraries/sparql
 
 LIBS += -L../../libraries/messageserver -lmessageserver \
-        -L../../libraries/qtopiamail -lqtopiamail
+        -L../../libraries/qtopiamail -lqtopiamail \
+        -L../../libraries/sparql -lsparql
 
 HEADERS += mailmessageclient.h \
            messageserver.h \
            servicehandler.h \
-           newcountnotifier.h
+           newcountnotifier.h \
+           sparqlindexer.h
 
 SOURCES += mailmessageclient.cpp \
            main.cpp \
            messageserver.cpp \
            prepareaccounts.cpp \
            newcountnotifier.cpp \
-           servicehandler.cpp
+           servicehandler.cpp \
+           sparqlindexer.cpp
 
 TRANSLATIONS += messageserver-ar.ts \
                 messageserver-de.ts \
@@ -43,10 +50,11 @@ TRANSLATIONS += messageserver-ar.ts \
 
 unix {
     # Uncomment this to shutdown cleanly on termination signal
-    #DEFINES += HANDLE_SHUTDOWN_SIGNALS
+    DEFINES += HANDLE_SHUTDOWN_SIGNALS
 }
 
 eventd.files = etc/event.d/messageserver
 eventd.path  = /etc/event.d
 
 INSTALLS += target eventd
+
diff --git a/src/tools/messageserver/servicehandler.cpp b/src/tools/messageserver/servicehandler.cpp
index 6112248..470891b 100644
--- a/src/tools/messageserver/servicehandler.cpp
+++ b/src/tools/messageserver/servicehandler.cpp
@@ -553,8 +553,19 @@ void ServiceHandler::deregisterAccountServices(const QMailAccountIdList &ids)
 void ServiceHandler::reregisterAccountServices(const QMailAccountIdList &ids)
 {
     // Remove and re-create these accounts' services
-    deregisterAccountServices(ids);
-    registerAccountServices(ids);
+    QMailAccountIdList reregisterIds;
+    QMap<QPair<QMailAccountId, QString>,  QMailMessageService*>::iterator it = serviceMap.begin();
+    while (it != serviceMap.end()) {
+        if (ids.contains(it.key().first)) {
+           QMailMessageService *service = it.value();
+           if (service && service->requiresReregistration()) {
+               reregisterIds.append(it.key().first);
+           }
+        }
+        ++it;
+    }
+    deregisterAccountServices(reregisterIds);
+    registerAccountServices(reregisterIds);
 }
 
 void ServiceHandler::accountsAdded(const QMailAccountIdList &ids)
diff --git a/src/tools/messageserver/sparqlindexer.cpp b/src/tools/messageserver/sparqlindexer.cpp
new file mode 100644
index 0000000..a7e2f1a
--- /dev/null
+++ b/src/tools/messageserver/sparqlindexer.cpp
@@ -0,0 +1,425 @@
+/****************************************************************************
+**
+** Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
+** Contact: Qt Software Information (qt-info@nokia.com)
+**
+** This file is part of the Qt Messaging Framework.
+**
+** $QT_BEGIN_LICENSE:LGPL$
+** No Commercial Usage
+** This file contains pre-release code and may not be distributed.
+** You may use this file in accordance with the terms and conditions
+** contained in the either Technology Preview License Agreement or the
+** Beta Release License Agreement.
+**
+** GNU Lesser General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU Lesser
+** General Public License version 2.1 as published by the Free Software
+** Foundation and appearing in the file LICENSE.LGPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU Lesser General Public License version 2.1 requirements
+** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
+**
+** In addition, as a special exception, Nokia gives you certain
+** additional rights. These rights are described in the Nokia Qt LGPL
+** Exception version 1.0, included in the file LGPL_EXCEPTION.txt in this
+** package.
+**
+** GNU General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU
+** General Public License version 3.0 as published by the Free Software
+** Foundation and appearing in the file LICENSE.GPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU General Public License version 3.0 requirements will be
+** met: http://www.gnu.org/copyleft/gpl.html.
+**
+** If you are unsure which license is appropriate for your use, please
+** contact the sales department at qt-sales@nokia.com.
+** $QT_END_LICENSE$
+**
+****************************************************************************/
+
+#include "sparqlindexer.h"
+#include <qmaillog.h>
+#include <sparqluri.h>
+#include <sparqlquery.h>
+
+#include <QMap>
+
+namespace {
+
+const static char* WellKnownUris[] =
+{
+    "qmf://groove.harmattan.com/email#",
+    "qmf://groove.nokia.com/folder#",
+    "qmf://groove.nokia.com/accounts#"
+};
+
+template <class Key, int Index>
+class WellKnownUri : public SparqlUri
+{
+public:
+    WellKnownUri() : SparqlUri(WellKnownUris[Index]) {}
+    WellKnownUri(const Key& id) : SparqlUri(WellKnownUris[Index], id.toULongLong()) {}
+    Key id() const { return Key(id()); }
+    operator Key () { return id(); }
+};
+
+typedef WellKnownUri<QMailMessageId, 0> MailMessageUri;
+typedef WellKnownUri<QMailFolderId,  1> MailFolderUri;
+typedef WellKnownUri<QMailAccountId, 2> MailAccountUri;
+
+typedef QMap<QMailMessage::ContentType, QString> MimePartMapType;
+MimePartMapType contentMimePartMap()
+{
+    MimePartMapType map;
+    map.insert(QMailMessage::UnknownContent,        QString("message/rfc822"));
+    map.insert(QMailMessage::NoContent,             QString("message/rfc822"));
+    map.insert(QMailMessage::PlainTextContent,      QString("text/plain"));
+    map.insert(QMailMessage::RichTextContent,       QString("text/richtext"));
+    map.insert(QMailMessage::HtmlContent,           QString("text/html"));
+    map.insert(QMailMessage::ImageContent,          QString("message/rfc822"));
+    map.insert(QMailMessage::AudioContent,          QString("message/rfc822"));
+    map.insert(QMailMessage::VideoContent,          QString("message/rfc822"));
+    map.insert(QMailMessage::MultipartContent,      QString("multipart/mixed"));
+    map.insert(QMailMessage::SmilContent,           QString("application/smil"));
+    map.insert(QMailMessage::VoicemailContent,      QString("multipart/voice-message"));
+    map.insert(QMailMessage::VideomailContent,      QString("message/rfc822"));
+    map.insert(QMailMessage::VCardContent,          QString("text/x-vcard"));
+    map.insert(QMailMessage::VCalendarContent,      QString("text/x-vcalendar"));
+    map.insert(QMailMessage::ICalendarContent,      QString("text/x-icalendar"));
+    map.insert(QMailMessage::DeliveryReportContent, QString("message/delivery-status"));
+    map.insert(QMailMessage::UserContent,           QString("message/rfc822"));
+
+    return map;
+}
+
+QString contentMimeType(QMailMessage::ContentType type)
+{
+    static MimePartMapType mimeTypeMap(contentMimePartMap());
+
+    Q_ASSERT(mimeTypeMap.contains(type));
+    return mimeTypeMap.value(type);
+}
+
+QString escape(const QString &original, const QChar &escapee, const QChar &escaper = '\\')
+{
+    QString result(original);
+    return result.replace(escapee, QString(escaper) + escapee);
+}
+
+QString contentUri(const QString &scheme, const QString &identifier)
+{
+    if (scheme.isEmpty())
+        return QString();
+
+    // Formulate a URI from the content scheme and identifier
+    return escape(scheme, ':') + ':' + escape(identifier, ':');
+}
+
+QString contentUri(const QMailMessageMetaData &message)
+{
+    return contentUri(message.contentScheme(), message.contentIdentifier());
+}
+
+QString insertObjectQuery(const QMailAccount& account)
+{
+    QString query;
+    QTextStream q(&query);
+
+    MailAccountUri accountUri(account.id());
+
+    q << "INSERT {" << endl;
+    q << accountUri.uri() << " rdf:type nmo:Mailbox ;" << endl;
+    q << "   nmo:accountName \"" << account.name() << "\" ;"<< endl;
+    q << "   nmo:signature \"" << account.signature() << "\" ;" << endl;
+    q << "   nmo:fromAddress [ " << endl;
+    q << "       rdf:type nco:EmailAddress ;" << endl;
+    q << "       nco:emailAddress \"" << account.fromAddress().toString(true) << "\" ] ." << endl;
+    q << "}";
+
+    return query;
+}
+
+QString dropObjectsQuery(const QMailAccountIdList& ids)
+{
+    Q_ASSERT(!ids.isEmpty());
+
+    QString query;
+    QTextStream q(&query);
+
+    foreach (const QMailAccountId& id, ids)
+    {
+        MailAccountUri accountUri(id);
+        q << "DROP GRAPH " << accountUri.uri() << endl;
+    }
+    return query;
+}
+
+QString insertObjectQuery(const QMailFolder& folder)
+{
+    QString query;
+    QTextStream q(&query);
+
+    MailFolderUri folderUri(folder.id());
+    MailFolderUri  parentFolderUri(folder.parentFolderId());
+    MailAccountUri accountUri(folder.parentAccountId());
+
+    q << "INSERT {" << endl;
+    q << folderUri.uri() <<  " rdf:type nmo:MailFolder ;" << endl;
+    q << "   nmo:folderName \"" << folder.displayName() << "\" ;" << endl;
+    q << "   nie:isLogicalPartOf " <<  parentFolderUri.uri() << " ;" << endl;
+    q << "   nie:relatedTo " << accountUri.uri() << " ." << endl;
+    q << "}";
+
+    return query;
+}
+
+QString dropObjectsQuery(const QMailFolderIdList& ids)
+{
+    Q_ASSERT(!ids.isEmpty());
+
+    QString query;
+    QTextStream q(&query);
+
+    foreach (const QMailFolderId& id, ids)
+    {
+        MailFolderUri folderUri(id);
+        q << "DROP GRAPH " << folderUri.uri() << endl;
+    }
+    return query;
+}
+
+
+QString recipients(const QList<QMailAddress>& recipients)
+{
+    QString result;
+    QTextStream q(&result);
+    foreach (const QMailAddress& address, recipients)
+    {
+        q << "     nmo:recipient [" << endl;
+        q << "        rdf:type nco:Contact ;" << endl;
+        if (address.name() != address.address())
+            q << "        nco:fullname \"" << address.name() << "\" ;" << endl;
+        q << "        nco:hasEmailAddress <mailto:" << address.address() << "> ] ;";
+    }
+    return result;
+}
+
+QString insertObjectQuery(const QMailMessageMetaData& message)
+{
+    QString query;
+    QTextStream q(&query);
+
+    MailMessageUri messageUri(message.id());
+    MailFolderUri  parentFolderUri(message.parentFolderId());
+    MailAccountUri parentAccountUri(message.parentAccountId());
+
+    q << "INSERT {" << endl;
+    q << messageUri.uri() << " rdf:type nmo:Email ;" << endl;
+    q << "   nie:isLogicalPartOf " << parentFolderUri.uri() << ";" << endl;
+    q << "   nmo:sender [" << endl;
+    q << "     rdf:type nco:Contact ;" << endl;
+    if (message.from().name() != message.from().address())
+        q << "       nco:fullname \"" << message.from().name() << "\" ;" << endl;
+    q << "       nco:hasEmailAddress <mailto:" << message.from().address() << "> ] ;" << endl;
+    q <<       recipients(message.to()) << endl;
+    q << "   nmo:messageSubject \"" << message.subject() << "\" ;" << endl;
+    q << "   nmo:sentDate \"" << QMailTimeStamp(message.date()).toLocalTime().toString() << "\"^^xsd:dateTime ;" << endl;
+    q << "   nie:relatedTo "  << parentAccountUri.uri() << ";" << endl;
+    q << "   nie:isStoredAs [" << endl;
+    q << "     rdf:type nie:DataObject ;" << endl;
+    q << "     nie:dataSource <" << ::contentUri(message) << "> ] ;" << endl;
+    q << "   nmo:messageId \""   << message.serverUid() << "\" ;" << endl;
+    q << "   nie:contentSize \"" << message.size()      << "\"^^xsd:integer ;" << endl;
+    q << "   nie:mimeType \""    << contentMimeType(message.content())   << "\" ;" << endl;
+    if (message.inResponseTo().isValid())
+        q << "   nmo:inReplyTo \""   << message.inResponseTo().toULongLong() << "\" ;" << endl;
+    q << "   nmo:receivedDate \"" << QMailTimeStamp(message.receivedDate()).toLocalTime().toString() << "\"^^xsd:dateTime ." << endl;
+    q << "}";
+
+    return query;
+}
+
+QString dropObjectsQuery(const QMailMessageIdList& ids)
+{
+    Q_ASSERT(!ids.isEmpty());
+
+    QString query;
+    QTextStream q(&query);
+
+    foreach (const QMailMessageId& id, ids)
+    {
+        MailMessageUri messageUri(id);
+        q << "DROP GRAPH " << messageUri.uri() << endl;
+    }
+    return query;
+}
+
+template <class MailObject, class MailObjectId>
+bool addObjects(const QList<MailObjectId> ids)
+{
+    Q_ASSERT(!ids.isEmpty());
+
+    SparqlQuery query(SparqlQuery::BatchUpdate);
+    foreach (const MailObjectId& id, ids)
+    {
+        MailObject object(id);
+
+        // Check wheither message was loaded successfully
+        if (object.id().isValid())
+        {
+            QString request(insertObjectQuery(object));
+            if (!query.prepare(request))
+            {
+                qMailLog(Messaging) << "Fail to prepare query to add object in Tracker." << query.error();
+                continue;
+            }
+        }
+    }
+
+    if (!query.exec())
+    {
+        qMailLog(Messaging) << "Fail to add objects to Tracker." << query.error();
+        return false;
+    }
+    return true;
+}
+
+template <class MailObject, class MailObjectId>
+bool updateObjects(const QList<MailObjectId> ids)
+{
+    Q_ASSERT(!ids.isEmpty());
+
+    SparqlQuery query(SparqlQuery::BatchUpdate);
+    foreach (const MailObjectId& id, ids)
+    {
+        MailObject object(id);
+
+        // Check wheither message was loaded successfully
+        if (object.id().isValid())
+        {
+            QString request;
+            QTextStream q(&request);
+
+            q << dropObjectsQuery(QList<MailObjectId>() << id);
+            q << insertObjectQuery(object);
+
+            if (!query.prepare(request))
+            {
+                qMailLog(Messaging) << "Fail to update objects in Tracker." << query.error();
+                continue;
+            }
+        }
+    }
+
+    if (!query.exec())
+    {
+        qMailLog(Messaging) << "Fail to update objects in Tracker." << query.error();
+        return false;
+    }
+    return true;
+}
+
+template <class MailObjectId>
+bool removeObjects(const QList<MailObjectId> ids)
+{
+    QString request(dropObjectsQuery(ids));
+
+    SparqlQuery query(SparqlQuery::UpdateQuery, request);
+    if (!query.exec())
+    {
+        qMailLog(Messaging) << "Fail to remove objects from Tracker:" << query.error();
+        return false;
+    }
+    return true;
+}
+
+} // end of namespace
+
+SparqlIndexer::SparqlIndexer(QObject* parent) : QObject(parent)
+{
+    if (mDatabase.isOpenError())
+    {
+        qMailLog(Messaging) << "Unable to initialize SPARQL indexer.";
+    }
+}
+
+SparqlIndexer::~SparqlIndexer()
+{
+    // TBD: Do nothing at that moment
+}
+
+bool SparqlIndexer::addMessageMetaData(const QMailMessageMetaData& message)
+{
+    QString request(insertObjectQuery(message));
+    SparqlQuery query(SparqlQuery::UpdateQuery, request);
+    if (!query.exec())
+    {
+        qMailLog(Messaging) << "Failed to add message information to Tracker:" << query.error();
+        return false;
+    }
+    return true;
+}
+
+bool SparqlIndexer::updateMessageMetaData(const QMailMessageMetaData& message)
+{
+    QString request;
+    QTextStream q(&request);
+
+    q << dropObjectsQuery(QMailMessageIdList() << message.id());
+    q << insertObjectQuery(message);
+
+    SparqlQuery query(SparqlQuery::UpdateQuery, request);
+    if (!query.exec())
+    {
+        qMailLog(Messaging) << "Failed to update message information in Tracker:" << query.error();
+        return false;
+    }
+    return true;
+}
+
+bool SparqlIndexer::addAccounts(const QMailAccountIdList& ids)
+{
+    return ::addObjects<QMailAccount,QMailAccountId>(ids);
+}
+
+bool SparqlIndexer::updateAccounts(const QMailAccountIdList& ids)
+{
+    return ::updateObjects<QMailAccount,QMailAccountId>(ids);
+}
+
+bool SparqlIndexer::removeAccounts(const QMailAccountIdList& ids)
+{
+    return ::removeObjects(ids);
+}
+
+bool SparqlIndexer::addFolders(const QMailFolderIdList& ids)
+{
+    return ::addObjects<QMailFolder,QMailFolderId>(ids);
+}
+
+bool SparqlIndexer::updateFolders(const QMailFolderIdList& ids)
+{
+    return ::updateObjects<QMailFolder,QMailFolderId>(ids);
+}
+
+bool SparqlIndexer::removeFolders(const QMailFolderIdList& ids)
+{
+    return ::removeObjects(ids);
+}
+
+bool SparqlIndexer::addMessages(const QMailMessageIdList& ids)
+{
+    return addObjects<QMailMessage,QMailMessageId>(ids);
+}
+
+bool SparqlIndexer::updateMessages(const QMailMessageIdList& ids)
+{
+    return updateObjects<QMailMessage,QMailMessageId>(ids);
+}
+
+bool SparqlIndexer::removeMessages(const QMailMessageIdList& ids)
+{
+    return removeObjects(ids);
+}
diff --git a/src/tools/messageserver/sparqlindexer.h b/src/tools/messageserver/sparqlindexer.h
new file mode 100644
index 0000000..41f4139
--- /dev/null
+++ b/src/tools/messageserver/sparqlindexer.h
@@ -0,0 +1,80 @@
+/****************************************************************************
+**
+** Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
+** Contact: Qt Software Information (qt-info@nokia.com)
+**
+** This file is part of the Qt Messaging Framework.
+**
+** $QT_BEGIN_LICENSE:LGPL$
+** No Commercial Usage
+** This file contains pre-release code and may not be distributed.
+** You may use this file in accordance with the terms and conditions
+** contained in the either Technology Preview License Agreement or the
+** Beta Release License Agreement.
+**
+** GNU Lesser General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU Lesser
+** General Public License version 2.1 as published by the Free Software
+** Foundation and appearing in the file LICENSE.LGPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU Lesser General Public License version 2.1 requirements
+** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
+**
+** In addition, as a special exception, Nokia gives you certain
+** additional rights. These rights are described in the Nokia Qt LGPL
+** Exception version 1.0, included in the file LGPL_EXCEPTION.txt in this
+** package.
+**
+** GNU General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU
+** General Public License version 3.0 as published by the Free Software
+** Foundation and appearing in the file LICENSE.GPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU General Public License version 3.0 requirements will be
+** met: http://www.gnu.org/copyleft/gpl.html.
+**
+** If you are unsure which license is appropriate for your use, please
+** contact the sales department at qt-sales@nokia.com.
+** $QT_END_LICENSE$
+**
+****************************************************************************/
+
+#ifndef SPARQLINDEXER_H
+#define SPARQLINDEXER_H
+
+#include <QObject>
+
+#include <qmailaccount.h>
+#include <qmailfolder.h>
+#include <qmailmessage.h>
+
+#include <sparqldatabase.h>
+
+class SparqlIndexer : public QObject
+{
+    Q_OBJECT
+public:
+    SparqlIndexer(QObject* parent = NULL);
+    virtual ~SparqlIndexer();
+
+    bool addMessageMetaData(const QMailMessageMetaData& message);
+    bool updateMessageMetaData(const QMailMessageMetaData& message);
+
+public slots:
+    bool addAccounts(const QMailAccountIdList& ids);
+    bool updateAccounts(const QMailAccountIdList& ids);
+    bool removeAccounts(const QMailAccountIdList& ids);
+
+    bool addFolders(const QMailFolderIdList& ids);
+    bool updateFolders(const QMailFolderIdList& ids);
+    bool removeFolders(const QMailFolderIdList& ids);
+
+    bool addMessages(const QMailMessageIdList& ids);
+    bool updateMessages(const QMailMessageIdList& ids);
+    bool removeMessages(const QMailMessageIdList& ids);
+
+private:
+    SparqlDatabase mDatabase;
+};
+
+#endif // SPARQLINDEXER_H
diff --git a/tests/tests.pro b/tests/tests.pro
index 6cd0a15..7470d5e 100644
--- a/tests/tests.pro
+++ b/tests/tests.pro
@@ -12,6 +12,13 @@ SUBDIRS = \
       tst_qmailstorekeys \
       tst_qprivateimplementation \
       tst_longstring \
+      tst_qlogsystem
 
 CONFIG += unittest
 
+# Install test file descriptopm
+test_description.files = tests.xml
+test_description.path  = $$QMF_INSTALL_ROOT/tests
+
+INSTALLS += test_description
+
diff --git a/tests/tests.xml b/tests/tests.xml
new file mode 100644
index 0000000..e6b60e0
--- /dev/null
+++ b/tests/tests.xml
@@ -0,0 +1,1012 @@
+<testdefinition version="0.1">
+  <suite name="libqmf-tests">
+    <description />
+    <set name="_usr_tests_qmf_tst_qmailmessage">
+      <description>libqmf-tests:tst_qmailmessage</description>
+      <case name="tst_qmailmessage-toRfc2822">
+        <description>libqmf-tests:tst_qmailmessage:toRfc2822</description>
+        <step>/usr/tests/qmf/tst_qmailmessage toRfc2822</step>
+      </case>
+      <case name="tst_qmailmessage-fromRfc2822">
+        <description>libqmf-tests:tst_qmailmessage:fromRfc2822</description>
+        <step>/usr/tests/qmf/tst_qmailmessage fromRfc2822</step>
+      </case>
+      <case name="tst_qmailmessage-id">
+        <description>libqmf-tests:tst_qmailmessage:id</description>
+        <step>/usr/tests/qmf/tst_qmailmessage id</step>
+      </case>
+      <case name="tst_qmailmessage-setId">
+        <description>libqmf-tests:tst_qmailmessage:setId</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setId</step>
+      </case>
+      <case name="tst_qmailmessage-parentFolderId">
+        <description>libqmf-tests:tst_qmailmessage:parentFolderId</description>
+        <step>/usr/tests/qmf/tst_qmailmessage parentFolderId</step>
+      </case>
+      <case name="tst_qmailmessage-setParentFolderId">
+        <description>libqmf-tests:tst_qmailmessage:setParentFolderId</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setParentFolderId</step>
+      </case>
+      <case name="tst_qmailmessage-messageType">
+        <description>libqmf-tests:tst_qmailmessage:messageType</description>
+        <step>/usr/tests/qmf/tst_qmailmessage messageType</step>
+      </case>
+      <case name="tst_qmailmessage-setMessageType">
+        <description>libqmf-tests:tst_qmailmessage:setMessageType</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setMessageType</step>
+      </case>
+      <case name="tst_qmailmessage-setFrom">
+        <description>libqmf-tests:tst_qmailmessage:setFrom</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setFrom</step>
+      </case>
+      <case name="tst_qmailmessage-from">
+        <description>libqmf-tests:tst_qmailmessage:from</description>
+        <step>/usr/tests/qmf/tst_qmailmessage from</step>
+      </case>
+      <case name="tst_qmailmessage-subject">
+        <description>libqmf-tests:tst_qmailmessage:subject</description>
+        <step>/usr/tests/qmf/tst_qmailmessage subject</step>
+      </case>
+      <case name="tst_qmailmessage-setSubject">
+        <description>libqmf-tests:tst_qmailmessage:setSubject</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setSubject</step>
+      </case>
+      <case name="tst_qmailmessage-date">
+        <description>libqmf-tests:tst_qmailmessage:date</description>
+        <step>/usr/tests/qmf/tst_qmailmessage date</step>
+      </case>
+      <case name="tst_qmailmessage-setDate">
+        <description>libqmf-tests:tst_qmailmessage:setDate</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setDate</step>
+      </case>
+      <case name="tst_qmailmessage-to">
+        <description>libqmf-tests:tst_qmailmessage:to</description>
+        <step>/usr/tests/qmf/tst_qmailmessage to</step>
+      </case>
+      <case name="tst_qmailmessage-setTo">
+        <description>libqmf-tests:tst_qmailmessage:setTo</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setTo</step>
+      </case>
+      <case name="tst_qmailmessage-cc">
+        <description>libqmf-tests:tst_qmailmessage:cc</description>
+        <step>/usr/tests/qmf/tst_qmailmessage cc</step>
+      </case>
+      <case name="tst_qmailmessage-setCc">
+        <description>libqmf-tests:tst_qmailmessage:setCc</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setCc</step>
+      </case>
+      <case name="tst_qmailmessage-bcc">
+        <description>libqmf-tests:tst_qmailmessage:bcc</description>
+        <step>/usr/tests/qmf/tst_qmailmessage bcc</step>
+      </case>
+      <case name="tst_qmailmessage-setBcc">
+        <description>libqmf-tests:tst_qmailmessage:setBcc</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setBcc</step>
+      </case>
+      <case name="tst_qmailmessage-recipients">
+        <description>libqmf-tests:tst_qmailmessage:recipients</description>
+        <step>/usr/tests/qmf/tst_qmailmessage recipients</step>
+      </case>
+      <case name="tst_qmailmessage-hasRecipients">
+        <description>libqmf-tests:tst_qmailmessage:hasRecipients</description>
+        <step>/usr/tests/qmf/tst_qmailmessage hasRecipients</step>
+      </case>
+      <case name="tst_qmailmessage-replyTo">
+        <description>libqmf-tests:tst_qmailmessage:replyTo</description>
+        <step>/usr/tests/qmf/tst_qmailmessage replyTo</step>
+      </case>
+      <case name="tst_qmailmessage-setReplyTo">
+        <description>libqmf-tests:tst_qmailmessage:setReplyTo</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setReplyTo</step>
+      </case>
+      <case name="tst_qmailmessage-inReplyTo">
+        <description>libqmf-tests:tst_qmailmessage:inReplyTo</description>
+        <step>/usr/tests/qmf/tst_qmailmessage inReplyTo</step>
+      </case>
+      <case name="tst_qmailmessage-setInReplyTo">
+        <description>libqmf-tests:tst_qmailmessage:setInReplyTo</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setInReplyTo</step>
+      </case>
+      <case name="tst_qmailmessage-serverUid">
+        <description>libqmf-tests:tst_qmailmessage:serverUid</description>
+        <step>/usr/tests/qmf/tst_qmailmessage serverUid</step>
+      </case>
+      <case name="tst_qmailmessage-setServerUid">
+        <description>libqmf-tests:tst_qmailmessage:setServerUid</description>
+        <step>/usr/tests/qmf/tst_qmailmessage setServerUid</step>
+      </case>
+      <case name="tst_qmailmessage-multiMultipart">
+        <description>libqmf-tests:tst_qmailmessage:multiMultipart</description>
+        <step>/usr/tests/qmf/tst_qmailmessage multiMultipart</step>
+      </case>
+      <case name="tst_qmailmessage-copyAndAssign">
+        <description>libqmf-tests:tst_qmailmessage:copyAndAssign</description>
+        <step>/usr/tests/qmf/tst_qmailmessage copyAndAssign</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_qprivateimplementation">
+      <description>libqmf-tests:tst_qprivateimplementation</description>
+      <case name="tst_qprivateimplementation-basicTest">
+        <description>libqmf-tests:tst_qprivateimplementation:basicTest</description>
+        <step>/usr/tests/qmf/tst_qprivateimplementation basicTest</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_qmailmessagepart">
+      <description>libqmf-tests:tst_qmailmessagepart</description>
+      <case name="tst_qmailmessagepart-contentID">
+        <description>libqmf-tests:tst_qmailmessagepart:contentID</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart contentID</step>
+      </case>
+      <case name="tst_qmailmessagepart-setContentID">
+        <description>libqmf-tests:tst_qmailmessagepart:setContentID</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart setContentID</step>
+      </case>
+      <case name="tst_qmailmessagepart-contentLocation">
+        <description>libqmf-tests:tst_qmailmessagepart:contentLocation</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart contentLocation</step>
+      </case>
+      <case name="tst_qmailmessagepart-setContentLocation">
+        <description>libqmf-tests:tst_qmailmessagepart:setContentLocation</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart setContentLocation</step>
+      </case>
+      <case name="tst_qmailmessagepart-contentDescription">
+        <description>libqmf-tests:tst_qmailmessagepart:contentDescription</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart contentDescription</step>
+      </case>
+      <case name="tst_qmailmessagepart-setContentDescription">
+        <description>libqmf-tests:tst_qmailmessagepart:setContentDescription</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart setContentDescription</step>
+      </case>
+      <case name="tst_qmailmessagepart-contentDisposition">
+        <description>libqmf-tests:tst_qmailmessagepart:contentDisposition</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart contentDisposition</step>
+      </case>
+      <case name="tst_qmailmessagepart-setContentDisposition">
+        <description>libqmf-tests:tst_qmailmessagepart:setContentDisposition</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart setContentDisposition</step>
+      </case>
+      <case name="tst_qmailmessagepart-contentLanguage">
+        <description>libqmf-tests:tst_qmailmessagepart:contentLanguage</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart contentLanguage</step>
+      </case>
+      <case name="tst_qmailmessagepart-setContentLanguage">
+        <description>libqmf-tests:tst_qmailmessagepart:setContentLanguage</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart setContentLanguage</step>
+      </case>
+      <case name="tst_qmailmessagepart-headerField">
+        <description>libqmf-tests:tst_qmailmessagepart:headerField</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart headerField</step>
+      </case>
+      <case name="tst_qmailmessagepart-headerFieldText">
+        <description>libqmf-tests:tst_qmailmessagepart:headerFieldText</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart headerFieldText</step>
+      </case>
+      <case name="tst_qmailmessagepart-headerFields">
+        <description>libqmf-tests:tst_qmailmessagepart:headerFields</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart headerFields</step>
+      </case>
+      <case name="tst_qmailmessagepart-headerFieldsText">
+        <description>libqmf-tests:tst_qmailmessagepart:headerFieldsText</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart headerFieldsText</step>
+      </case>
+      <case name="tst_qmailmessagepart-setHeaderField">
+        <description>libqmf-tests:tst_qmailmessagepart:setHeaderField</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart setHeaderField</step>
+      </case>
+      <case name="tst_qmailmessagepart-appendHeaderField">
+        <description>libqmf-tests:tst_qmailmessagepart:appendHeaderField</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart appendHeaderField</step>
+      </case>
+      <case name="tst_qmailmessagepart-removeHeaderField">
+        <description>libqmf-tests:tst_qmailmessagepart:removeHeaderField</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart removeHeaderField</step>
+      </case>
+      <case name="tst_qmailmessagepart-testSerialization">
+        <description>libqmf-tests:tst_qmailmessagepart:testSerialization</description>
+        <step>/usr/tests/qmf/tst_qmailmessagepart testSerialization</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_qmailmessagebody">
+      <description>libqmf-tests:tst_qmailmessagebody</description>
+      <case name="tst_qmailmessagebody-fromQByteArray">
+        <description>libqmf-tests:tst_qmailmessagebody:fromQByteArray</description>
+        <step>/usr/tests/qmf/tst_qmailmessagebody fromQByteArray</step>
+      </case>
+      <case name="tst_qmailmessagebody-fromQString">
+        <description>libqmf-tests:tst_qmailmessagebody:fromQString</description>
+        <step>/usr/tests/qmf/tst_qmailmessagebody fromQString</step>
+      </case>
+      <case name="tst_qmailmessagebody-fromFile">
+        <description>libqmf-tests:tst_qmailmessagebody:fromFile</description>
+        <step>/usr/tests/qmf/tst_qmailmessagebody fromFile</step>
+      </case>
+      <case name="tst_qmailmessagebody-toFile">
+        <description>libqmf-tests:tst_qmailmessagebody:toFile</description>
+        <step>/usr/tests/qmf/tst_qmailmessagebody toFile</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_qmailcodec">
+      <description>libqmf-tests:tst_qmailcodec</description>
+      <case name="tst_qmailcodec-encode">
+        <description>libqmf-tests:tst_qmailcodec:encode</description>
+        <step>/usr/tests/qmf/tst_qmailcodec encode</step>
+      </case>
+      <case name="tst_qmailcodec-decode">
+        <description>libqmf-tests:tst_qmailcodec:decode</description>
+        <step>/usr/tests/qmf/tst_qmailcodec decode</step>
+      </case>
+      <case name="tst_qmailcodec-line_lengths">
+        <description>libqmf-tests:tst_qmailcodec:line_lengths</description>
+        <step>/usr/tests/qmf/tst_qmailcodec line_lengths</step>
+      </case>
+      <case name="tst_qmailcodec-buffer_sizes">
+        <description>libqmf-tests:tst_qmailcodec:buffer_sizes</description>
+        <step>/usr/tests/qmf/tst_qmailcodec buffer_sizes</step>
+      </case>
+      <case name="tst_qmailcodec-embedded_newlines">
+        <description>libqmf-tests:tst_qmailcodec:embedded_newlines</description>
+        <step>/usr/tests/qmf/tst_qmailcodec embedded_newlines</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_qmailmessageheader">
+      <description>libqmf-tests:tst_qmailmessageheader</description>
+      <case name="tst_qmailmessageheader-">
+        <description>libqmf-tests:tst_qmailmessageheader:</description>
+        <step>/usr/tests/qmf/tst_qmailmessageheader </step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_qlogsystem">
+      <description>libqmf-tests:tst_qlogsystem</description>
+      <case name="tst_qlogsystem-loggerConstruction">
+        <description>libqmf-tests:tst_qlogsystem:loggerConstruction</description>
+        <step>/usr/tests/qmf/tst_qlogsystem loggerConstruction</step>
+      </case>
+      <case name="tst_qlogsystem-minLogLvl">
+        <description>libqmf-tests:tst_qlogsystem:minLogLvl</description>
+        <step>/usr/tests/qmf/tst_qlogsystem minLogLvl</step>
+      </case>
+      <case name="tst_qlogsystem-loggerOutput">
+        <description>libqmf-tests:tst_qlogsystem:loggerOutput</description>
+        <step>/usr/tests/qmf/tst_qlogsystem loggerOutput</step>
+      </case>
+      <case name="tst_qlogsystem-qDebugOutput">
+        <description>libqmf-tests:tst_qlogsystem:qDebugOutput</description>
+        <step>/usr/tests/qmf/tst_qlogsystem qDebugOutput</step>
+      </case>
+      <case name="tst_qlogsystem-qWarningOutput">
+        <description>libqmf-tests:tst_qlogsystem:qWarningOutput</description>
+        <step>/usr/tests/qmf/tst_qlogsystem qWarningOutput</step>
+      </case>
+      <case name="tst_qlogsystem-sysLoggerOutput">
+        <description>libqmf-tests:tst_qlogsystem:sysLoggerOutput</description>
+        <step>/usr/tests/qmf/tst_qlogsystem sysLoggerOutput</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_qmailstore">
+      <description>libqmf-tests:tst_qmailstore</description>
+      <case name="tst_qmailstore-addAccount">
+        <description>libqmf-tests:tst_qmailstore:addAccount</description>
+        <step>/usr/tests/qmf/tst_qmailstore addAccount</step>
+      </case>
+      <case name="tst_qmailstore-addFolder">
+        <description>libqmf-tests:tst_qmailstore:addFolder</description>
+        <step>/usr/tests/qmf/tst_qmailstore addFolder</step>
+      </case>
+      <case name="tst_qmailstore-addMessage">
+        <description>libqmf-tests:tst_qmailstore:addMessage</description>
+        <step>/usr/tests/qmf/tst_qmailstore addMessage</step>
+      </case>
+      <case name="tst_qmailstore-addMessages">
+        <description>libqmf-tests:tst_qmailstore:addMessages</description>
+        <step>/usr/tests/qmf/tst_qmailstore addMessages</step>
+      </case>
+      <case name="tst_qmailstore-addMessages2">
+        <description>libqmf-tests:tst_qmailstore:addMessages2</description>
+        <step>/usr/tests/qmf/tst_qmailstore addMessages2</step>
+      </case>
+      <case name="tst_qmailstore-updateAccount">
+        <description>libqmf-tests:tst_qmailstore:updateAccount</description>
+        <step>/usr/tests/qmf/tst_qmailstore updateAccount</step>
+      </case>
+      <case name="tst_qmailstore-updateFolder">
+        <description>libqmf-tests:tst_qmailstore:updateFolder</description>
+        <step>/usr/tests/qmf/tst_qmailstore updateFolder</step>
+      </case>
+      <case name="tst_qmailstore-updateMessage">
+        <description>libqmf-tests:tst_qmailstore:updateMessage</description>
+        <step>/usr/tests/qmf/tst_qmailstore updateMessage</step>
+      </case>
+      <case name="tst_qmailstore-updateMessages">
+        <description>libqmf-tests:tst_qmailstore:updateMessages</description>
+        <step>/usr/tests/qmf/tst_qmailstore updateMessages</step>
+      </case>
+      <case name="tst_qmailstore-removeAccount">
+        <description>libqmf-tests:tst_qmailstore:removeAccount</description>
+        <step>/usr/tests/qmf/tst_qmailstore removeAccount</step>
+      </case>
+      <case name="tst_qmailstore-removeFolder">
+        <description>libqmf-tests:tst_qmailstore:removeFolder</description>
+        <step>/usr/tests/qmf/tst_qmailstore removeFolder</step>
+      </case>
+      <case name="tst_qmailstore-removeMessage">
+        <description>libqmf-tests:tst_qmailstore:removeMessage</description>
+        <step>/usr/tests/qmf/tst_qmailstore removeMessage</step>
+      </case>
+      <!-- This is too long test case, usually terminated by timeout.
+      <case name="tst_qmailstore-remove1000Messages">
+        <description>libqmf-tests:tst_qmailstore:remove1000Messages</description>
+        <step>/usr/tests/qmf/tst_qmailstore remove1000Messages</step>
+      </case>
+      -->
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_longstring">
+      <description>libqmf-tests:tst_longstring</description>
+      <case name="tst_longstring-indexOf">
+        <description>libqmf-tests:tst_longstring:indexOf</description>
+        <step>/usr/tests/qmf/tst_longstring indexOf</step>
+      </case>
+      <case name="tst_longstring-left">
+        <description>libqmf-tests:tst_longstring:left</description>
+        <step>/usr/tests/qmf/tst_longstring left</step>
+      </case>
+      <case name="tst_longstring-right">
+        <description>libqmf-tests:tst_longstring:right</description>
+        <step>/usr/tests/qmf/tst_longstring right</step>
+      </case>
+      <case name="tst_longstring-mid">
+        <description>libqmf-tests:tst_longstring:mid</description>
+        <step>/usr/tests/qmf/tst_longstring mid</step>
+      </case>
+      <case name="tst_longstring-length">
+        <description>libqmf-tests:tst_longstring:length</description>
+        <step>/usr/tests/qmf/tst_longstring length</step>
+      </case>
+      <case name="tst_longstring-isEmpty">
+        <description>libqmf-tests:tst_longstring:isEmpty</description>
+        <step>/usr/tests/qmf/tst_longstring isEmpty</step>
+      </case>
+      <case name="tst_longstring-toQByteArray">
+        <description>libqmf-tests:tst_longstring:toQByteArray</description>
+        <step>/usr/tests/qmf/tst_longstring toQByteArray</step>
+      </case>
+      <case name="tst_longstring-dataStream">
+        <description>libqmf-tests:tst_longstring:dataStream</description>
+        <step>/usr/tests/qmf/tst_longstring dataStream</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_python_email">
+      <description>libqmf-tests:tst_python_email</description>
+      <case name="tst_python_email-test_get_all">
+        <description>libqmf-tests:tst_python_email:test_get_all</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_all</step>
+      </case>
+      <case name="tst_python_email-test_get_charsets">
+        <description>libqmf-tests:tst_python_email:test_get_charsets</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_charsets</step>
+      </case>
+      <case name="tst_python_email-test_get_filename">
+        <description>libqmf-tests:tst_python_email:test_get_filename</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_filename</step>
+      </case>
+      <case name="tst_python_email-test_get_filename_with_name_parameter">
+        <description>libqmf-tests:tst_python_email:test_get_filename_with_name_parameter</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_filename_with_name_parameter</step>
+      </case>
+      <case name="tst_python_email-test_get_boundary">
+        <description>libqmf-tests:tst_python_email:test_get_boundary</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_boundary</step>
+      </case>
+      <case name="tst_python_email-test_set_boundary">
+        <description>libqmf-tests:tst_python_email:test_set_boundary</description>
+        <step>/usr/tests/qmf/tst_python_email test_set_boundary</step>
+      </case>
+      <case name="tst_python_email-test_get_decoded_payload">
+        <description>libqmf-tests:tst_python_email:test_get_decoded_payload</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_decoded_payload</step>
+      </case>
+      <case name="tst_python_email-test_decoded_generator">
+        <description>libqmf-tests:tst_python_email:test_decoded_generator</description>
+        <step>/usr/tests/qmf/tst_python_email test_decoded_generator</step>
+      </case>
+      <case name="tst_python_email-test_as_string">
+        <description>libqmf-tests:tst_python_email:test_as_string</description>
+        <step>/usr/tests/qmf/tst_python_email test_as_string</step>
+      </case>
+      <case name="tst_python_email-test_get_params">
+        <description>libqmf-tests:tst_python_email:test_get_params</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_params</step>
+      </case>
+      <case name="tst_python_email-test_get_param_liberal">
+        <description>libqmf-tests:tst_python_email:test_get_param_liberal</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_param_liberal</step>
+      </case>
+      <case name="tst_python_email-test_get_param">
+        <description>libqmf-tests:tst_python_email:test_get_param</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_param</step>
+      </case>
+      <case name="tst_python_email-test_get_param_funky_continuation_lines">
+        <description>libqmf-tests:tst_python_email:test_get_param_funky_continuation_lines</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_param_funky_continuation_lines</step>
+      </case>
+      <case name="tst_python_email-test_get_param_with_semis_in_quotes">
+        <description>libqmf-tests:tst_python_email:test_get_param_with_semis_in_quotes</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_param_with_semis_in_quotes</step>
+      </case>
+      <case name="tst_python_email-test_has_key">
+        <description>libqmf-tests:tst_python_email:test_has_key</description>
+        <step>/usr/tests/qmf/tst_python_email test_has_key</step>
+      </case>
+      <case name="tst_python_email-test_del_param">
+        <description>libqmf-tests:tst_python_email:test_del_param</description>
+        <step>/usr/tests/qmf/tst_python_email test_del_param</step>
+      </case>
+      <case name="tst_python_email-test_get_content_type_from_message_implicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_type_from_message_implicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_type_from_message_implicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_type_from_message_explicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_type_from_message_explicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_type_from_message_explicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_type_from_message_text_plain_implicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_type_from_message_text_plain_implicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_type_from_message_text_plain_implicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_type_from_message_text_plain_explicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_type_from_message_text_plain_explicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_type_from_message_text_plain_explicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_maintype_from_message_implicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_maintype_from_message_implicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_maintype_from_message_implicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_maintype_from_message_explicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_maintype_from_message_explicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_maintype_from_message_explicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_maintype_from_message_text_plain_implicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_maintype_from_message_text_plain_implicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_maintype_from_message_text_plain_implicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_maintype_from_message_text_plain_explicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_maintype_from_message_text_plain_explicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_maintype_from_message_text_plain_explicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_subtype_from_message_implicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_subtype_from_message_implicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_subtype_from_message_implicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_subtype_from_message_explicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_subtype_from_message_explicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_subtype_from_message_explicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_subtype_from_message_text_plain_implicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_subtype_from_message_text_plain_implicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_subtype_from_message_text_plain_implicit</step>
+      </case>
+      <case name="tst_python_email-test_get_content_subtype_from_message_text_plain_explicit">
+        <description>libqmf-tests:tst_python_email:test_get_content_subtype_from_message_text_plain_explicit</description>
+        <step>/usr/tests/qmf/tst_python_email test_get_content_subtype_from_message_text_plain_explicit</step>
+      </case>
+      <case name="tst_python_email-test_replace_header">
+        <description>libqmf-tests:tst_python_email:test_replace_header</description>
+        <step>/usr/tests/qmf/tst_python_email test_replace_header</step>
+      </case>
+      <case name="tst_python_email-test_broken_base64_payload">
+        <description>libqmf-tests:tst_python_email:test_broken_base64_payload</description>
+        <step>/usr/tests/qmf/tst_python_email test_broken_base64_payload</step>
+      </case>
+      <case name="tst_python_email-test_default_cte">
+        <description>libqmf-tests:tst_python_email:test_default_cte</description>
+        <step>/usr/tests/qmf/tst_python_email test_default_cte</step>
+      </case>
+      <case name="tst_python_email-test_long_nonstring">
+        <description>libqmf-tests:tst_python_email:test_long_nonstring</description>
+        <step>/usr/tests/qmf/tst_python_email test_long_nonstring</step>
+      </case>
+      <case name="tst_python_email-test_long_header_encode">
+        <description>libqmf-tests:tst_python_email:test_long_header_encode</description>
+        <step>/usr/tests/qmf/tst_python_email test_long_header_encode</step>
+      </case>
+      <case name="tst_python_email-test_no_semis_header_splitter">
+        <description>libqmf-tests:tst_python_email:test_no_semis_header_splitter</description>
+        <step>/usr/tests/qmf/tst_python_email test_no_semis_header_splitter</step>
+      </case>
+      <case name="tst_python_email-test_no_split_long_header">
+        <description>libqmf-tests:tst_python_email:test_no_split_long_header</description>
+        <step>/usr/tests/qmf/tst_python_email test_no_split_long_header</step>
+      </case>
+      <case name="tst_python_email-test_splitting_multiple_long_lines">
+        <description>libqmf-tests:tst_python_email:test_splitting_multiple_long_lines</description>
+        <step>/usr/tests/qmf/tst_python_email test_splitting_multiple_long_lines</step>
+      </case>
+      <case name="tst_python_email-test_splitting_first_line_only_is_long">
+        <description>libqmf-tests:tst_python_email:test_splitting_first_line_only_is_long</description>
+        <step>/usr/tests/qmf/tst_python_email test_splitting_first_line_only_is_long</step>
+      </case>
+      <case name="tst_python_email-test_long_8bit_header">
+        <description>libqmf-tests:tst_python_email:test_long_8bit_header</description>
+        <step>/usr/tests/qmf/tst_python_email test_long_8bit_header</step>
+      </case>
+      <case name="tst_python_email-test_long_to_header">
+        <description>libqmf-tests:tst_python_email:test_long_to_header</description>
+        <step>/usr/tests/qmf/tst_python_email test_long_to_header</step>
+      </case>
+      <case name="tst_python_email-test_long_field_name">
+        <description>libqmf-tests:tst_python_email:test_long_field_name</description>
+        <step>/usr/tests/qmf/tst_python_email test_long_field_name</step>
+      </case>
+      <case name="tst_python_email-test_string_headerinst_eq">
+        <description>libqmf-tests:tst_python_email:test_string_headerinst_eq</description>
+        <step>/usr/tests/qmf/tst_python_email test_string_headerinst_eq</step>
+      </case>
+      <case name="tst_python_email-test_another_long_multiline_header">
+        <description>libqmf-tests:tst_python_email:test_another_long_multiline_header</description>
+        <step>/usr/tests/qmf/tst_python_email test_another_long_multiline_header</step>
+      </case>
+      <case name="tst_python_email-test_long_lines_with_different_header">
+        <description>libqmf-tests:tst_python_email:test_long_lines_with_different_header</description>
+        <step>/usr/tests/qmf/tst_python_email test_long_lines_with_different_header</step>
+      </case>
+      <case name="tst_python_email-TestMIMEAudio">
+        <description>libqmf-tests:tst_python_email:TestMIMEAudio</description>
+        <step>/usr/tests/qmf/tst_python_email TestMIMEAudio</step>
+      </case>
+      <case name="tst_python_email-TestMIMEImage">
+        <description>libqmf-tests:tst_python_email:TestMIMEImage</description>
+        <step>/usr/tests/qmf/tst_python_email TestMIMEImage</step>
+      </case>
+      <case name="tst_python_email-test_hierarchy">
+        <description>libqmf-tests:tst_python_email:test_hierarchy</description>
+        <step>/usr/tests/qmf/tst_python_email test_hierarchy</step>
+      </case>
+      <case name="tst_python_email-test_empty_multipart_idempotent">
+        <description>libqmf-tests:tst_python_email:test_empty_multipart_idempotent</description>
+        <step>/usr/tests/qmf/tst_python_email test_empty_multipart_idempotent</step>
+      </case>
+      <case name="tst_python_email-test_no_parts_in_a_multipart_with_none_epilogue">
+        <description>libqmf-tests:tst_python_email:test_no_parts_in_a_multipart_with_none_epilogue</description>
+        <step>/usr/tests/qmf/tst_python_email test_no_parts_in_a_multipart_with_none_epilogue</step>
+      </case>
+      <case name="tst_python_email-test_no_parts_in_a_multipart_with_empty_epilogue">
+        <description>libqmf-tests:tst_python_email:test_no_parts_in_a_multipart_with_empty_epilogue</description>
+        <step>/usr/tests/qmf/tst_python_email test_no_parts_in_a_multipart_with_empty_epilogue</step>
+      </case>
+      <case name="tst_python_email-test_one_part_in_a_multipart">
+        <description>libqmf-tests:tst_python_email:test_one_part_in_a_multipart</description>
+        <step>/usr/tests/qmf/tst_python_email test_one_part_in_a_multipart</step>
+      </case>
+      <case name="tst_python_email-test_message_external_body">
+        <description>libqmf-tests:tst_python_email:test_message_external_body</description>
+        <step>/usr/tests/qmf/tst_python_email test_message_external_body</step>
+      </case>
+      <case name="tst_python_email-test_double_boundary">
+        <description>libqmf-tests:tst_python_email:test_double_boundary</description>
+        <step>/usr/tests/qmf/tst_python_email test_double_boundary</step>
+      </case>
+      <case name="tst_python_email-test_nested_inner_contains_outer_boundary">
+        <description>libqmf-tests:tst_python_email:test_nested_inner_contains_outer_boundary</description>
+        <step>/usr/tests/qmf/tst_python_email test_nested_inner_contains_outer_boundary</step>
+      </case>
+      <case name="tst_python_email-test_nested_with_same_boundary">
+        <description>libqmf-tests:tst_python_email:test_nested_with_same_boundary</description>
+        <step>/usr/tests/qmf/tst_python_email test_nested_with_same_boundary</step>
+      </case>
+      <case name="tst_python_email-test_boundary_in_non_multipart">
+        <description>libqmf-tests:tst_python_email:test_boundary_in_non_multipart</description>
+        <step>/usr/tests/qmf/tst_python_email test_boundary_in_non_multipart</step>
+      </case>
+      <case name="tst_python_email-test_boundary_with_leading_space">
+        <description>libqmf-tests:tst_python_email:test_boundary_with_leading_space</description>
+        <step>/usr/tests/qmf/tst_python_email test_boundary_with_leading_space</step>
+      </case>
+      <case name="tst_python_email-test_boundary_without_trailing_newline">
+        <description>libqmf-tests:tst_python_email:test_boundary_without_trailing_newline</description>
+        <step>/usr/tests/qmf/tst_python_email test_boundary_without_trailing_newline</step>
+      </case>
+      <case name="tst_python_email-test_parse_missing_minor_type">
+        <description>libqmf-tests:tst_python_email:test_parse_missing_minor_type</description>
+        <step>/usr/tests/qmf/tst_python_email test_parse_missing_minor_type</step>
+      </case>
+      <case name="tst_python_email-test_same_boundary_inner_outer">
+        <description>libqmf-tests:tst_python_email:test_same_boundary_inner_outer</description>
+        <step>/usr/tests/qmf/tst_python_email test_same_boundary_inner_outer</step>
+      </case>
+      <case name="tst_python_email-test_multipart_no_boundary">
+        <description>libqmf-tests:tst_python_email:test_multipart_no_boundary</description>
+        <step>/usr/tests/qmf/tst_python_email test_multipart_no_boundary</step>
+      </case>
+      <case name="tst_python_email-test_invalid_content_type">
+        <description>libqmf-tests:tst_python_email:test_invalid_content_type</description>
+        <step>/usr/tests/qmf/tst_python_email test_invalid_content_type</step>
+      </case>
+      <case name="tst_python_email-test_no_start_boundary">
+        <description>libqmf-tests:tst_python_email:test_no_start_boundary</description>
+        <step>/usr/tests/qmf/tst_python_email test_no_start_boundary</step>
+      </case>
+      <case name="tst_python_email-test_no_separating_blank_line">
+        <description>libqmf-tests:tst_python_email:test_no_separating_blank_line</description>
+        <step>/usr/tests/qmf/tst_python_email test_no_separating_blank_line</step>
+      </case>
+      <case name="tst_python_email-test_lying_multipart">
+        <description>libqmf-tests:tst_python_email:test_lying_multipart</description>
+        <step>/usr/tests/qmf/tst_python_email test_lying_multipart</step>
+      </case>
+      <case name="tst_python_email-test_missing_start_boundary">
+        <description>libqmf-tests:tst_python_email:test_missing_start_boundary</description>
+        <step>/usr/tests/qmf/tst_python_email test_missing_start_boundary</step>
+      </case>
+      <case name="tst_python_email-test_whitespace_eater_unicode">
+        <description>libqmf-tests:tst_python_email:test_whitespace_eater_unicode</description>
+        <step>/usr/tests/qmf/tst_python_email test_whitespace_eater_unicode</step>
+      </case>
+      <case name="tst_python_email-test_whitespace_eater_unicode_2">
+        <description>libqmf-tests:tst_python_email:test_whitespace_eater_unicode_2</description>
+        <step>/usr/tests/qmf/tst_python_email test_whitespace_eater_unicode_2</step>
+      </case>
+      <case name="tst_python_email-test_rfc2047_without_whitespace">
+        <description>libqmf-tests:tst_python_email:test_rfc2047_without_whitespace</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2047_without_whitespace</step>
+      </case>
+      <case name="tst_python_email-test_rfc2047_with_whitespace">
+        <description>libqmf-tests:tst_python_email:test_rfc2047_with_whitespace</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2047_with_whitespace</step>
+      </case>
+      <case name="tst_python_email-test_generate">
+        <description>libqmf-tests:tst_python_email:test_generate</description>
+        <step>/usr/tests/qmf/tst_python_email test_generate</step>
+      </case>
+      <case name="tst_python_email-test_parse_message_rfc822">
+        <description>libqmf-tests:tst_python_email:test_parse_message_rfc822</description>
+        <step>/usr/tests/qmf/tst_python_email test_parse_message_rfc822</step>
+      </case>
+      <case name="tst_python_email-test_dsn">
+        <description>libqmf-tests:tst_python_email:test_dsn</description>
+        <step>/usr/tests/qmf/tst_python_email test_dsn</step>
+      </case>
+      <case name="tst_python_email-test_epilogue">
+        <description>libqmf-tests:tst_python_email:test_epilogue</description>
+        <step>/usr/tests/qmf/tst_python_email test_epilogue</step>
+      </case>
+      <case name="tst_python_email-test_default_type">
+        <description>libqmf-tests:tst_python_email:test_default_type</description>
+        <step>/usr/tests/qmf/tst_python_email test_default_type</step>
+      </case>
+      <case name="tst_python_email-test_default_type_with_explicit_container_type">
+        <description>libqmf-tests:tst_python_email:test_default_type_with_explicit_container_type</description>
+        <step>/usr/tests/qmf/tst_python_email test_default_type_with_explicit_container_type</step>
+      </case>
+      <case name="tst_python_email-TestIdempotent">
+        <description>libqmf-tests:tst_python_email:TestIdempotent</description>
+        <step>/usr/tests/qmf/tst_python_email TestIdempotent</step>
+      </case>
+      <case name="tst_python_email-test_crlf_separation">
+        <description>libqmf-tests:tst_python_email:test_crlf_separation</description>
+        <step>/usr/tests/qmf/tst_python_email test_crlf_separation</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_get_param">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_get_param</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_get_param</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_set_param">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_set_param</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_set_param</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_no_language_or_charset">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_no_language_or_charset</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_no_language_or_charset</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_no_language_or_charset_in_filename">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_no_language_or_charset_in_filename</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_no_language_or_charset_in_filename</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_partly_encoded">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_partly_encoded</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_partly_encoded</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_no_language_or_charset_in_boundary">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_no_language_or_charset_in_boundary</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_no_language_or_charset_in_boundary</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_no_language_or_charset_in_charset">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_no_language_or_charset_in_charset</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_no_language_or_charset_in_charset</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_bad_encoding_in_filename">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_bad_encoding_in_filename</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_bad_encoding_in_filename</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_bad_encoding_in_charset">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_bad_encoding_in_charset</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_bad_encoding_in_charset</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_bad_character_in_charset">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_bad_character_in_charset</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_bad_character_in_charset</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_bad_character_in_filename">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_bad_character_in_filename</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_bad_character_in_filename</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_single_tick_in_filename_extended">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_single_tick_in_filename_extended</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_single_tick_in_filename_extended</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_tick_attack_extended">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_tick_attack_extended</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_tick_attack_extended</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_no_extended_values">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_no_extended_values</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_no_extended_values</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_encoded_then_unencoded_segments">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_encoded_then_unencoded_segments</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_encoded_then_unencoded_segments</step>
+      </case>
+      <case name="tst_python_email-test_rfc2231_unencoded_then_encoded_segments">
+        <description>libqmf-tests:tst_python_email:test_rfc2231_unencoded_then_encoded_segments</description>
+        <step>/usr/tests/qmf/tst_python_email test_rfc2231_unencoded_then_encoded_segments</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_qmailaddress">
+      <description>libqmf-tests:tst_qmailaddress</description>
+      <case name="tst_qmailaddress-constructor1">
+        <description>libqmf-tests:tst_qmailaddress:constructor1</description>
+        <step>/usr/tests/qmf/tst_qmailaddress constructor1</step>
+      </case>
+      <case name="tst_qmailaddress-constructor2">
+        <description>libqmf-tests:tst_qmailaddress:constructor2</description>
+        <step>/usr/tests/qmf/tst_qmailaddress constructor2</step>
+      </case>
+      <case name="tst_qmailaddress-name">
+        <description>libqmf-tests:tst_qmailaddress:name</description>
+        <step>/usr/tests/qmf/tst_qmailaddress name</step>
+      </case>
+      <case name="tst_qmailaddress-address">
+        <description>libqmf-tests:tst_qmailaddress:address</description>
+        <step>/usr/tests/qmf/tst_qmailaddress address</step>
+      </case>
+      <case name="tst_qmailaddress-isGroup">
+        <description>libqmf-tests:tst_qmailaddress:isGroup</description>
+        <step>/usr/tests/qmf/tst_qmailaddress isGroup</step>
+      </case>
+      <case name="tst_qmailaddress-groupMembers">
+        <description>libqmf-tests:tst_qmailaddress:groupMembers</description>
+        <step>/usr/tests/qmf/tst_qmailaddress groupMembers</step>
+      </case>
+      <case name="tst_qmailaddress-notGroup">
+        <description>libqmf-tests:tst_qmailaddress:notGroup</description>
+        <step>/usr/tests/qmf/tst_qmailaddress notGroup</step>
+      </case>
+      <case name="tst_qmailaddress-toString">
+        <description>libqmf-tests:tst_qmailaddress:toString</description>
+        <step>/usr/tests/qmf/tst_qmailaddress toString</step>
+      </case>
+      <case name="tst_qmailaddress-isPhoneNumber">
+        <description>libqmf-tests:tst_qmailaddress:isPhoneNumber</description>
+        <step>/usr/tests/qmf/tst_qmailaddress isPhoneNumber</step>
+      </case>
+      <case name="tst_qmailaddress-isEmailAddress">
+        <description>libqmf-tests:tst_qmailaddress:isEmailAddress</description>
+        <step>/usr/tests/qmf/tst_qmailaddress isEmailAddress</step>
+      </case>
+      <case name="tst_qmailaddress-toStringList">
+        <description>libqmf-tests:tst_qmailaddress:toStringList</description>
+        <step>/usr/tests/qmf/tst_qmailaddress toStringList</step>
+      </case>
+      <case name="tst_qmailaddress-fromStringList1">
+        <description>libqmf-tests:tst_qmailaddress:fromStringList1</description>
+        <step>/usr/tests/qmf/tst_qmailaddress fromStringList1</step>
+      </case>
+      <case name="tst_qmailaddress-fromStringList2">
+        <description>libqmf-tests:tst_qmailaddress:fromStringList2</description>
+        <step>/usr/tests/qmf/tst_qmailaddress fromStringList2</step>
+      </case>
+      <case name="tst_qmailaddress-removeComments">
+        <description>libqmf-tests:tst_qmailaddress:removeComments</description>
+        <step>/usr/tests/qmf/tst_qmailaddress removeComments</step>
+      </case>
+      <case name="tst_qmailaddress-removeWhitespace">
+        <description>libqmf-tests:tst_qmailaddress:removeWhitespace</description>
+        <step>/usr/tests/qmf/tst_qmailaddress removeWhitespace</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+    <set name="_usr_tests_qmf_tst_qmailstorekeys">
+      <description>libqmf-tests:tst_qmailstorekeys</description>
+      <case name="tst_qmailstorekeys-simpleKeys">
+        <description>libqmf-tests:tst_qmailstorekeys:simpleKeys</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys simpleKeys</step>
+      </case>
+      <case name="tst_qmailstorekeys-accountId">
+        <description>libqmf-tests:tst_qmailstorekeys:accountId</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys accountId</step>
+      </case>
+      <case name="tst_qmailstorekeys-accountName">
+        <description>libqmf-tests:tst_qmailstorekeys:accountName</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys accountName</step>
+      </case>
+      <case name="tst_qmailstorekeys-accountMessageType">
+        <description>libqmf-tests:tst_qmailstorekeys:accountMessageType</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys accountMessageType</step>
+      </case>
+      <case name="tst_qmailstorekeys-accountFromAddress">
+        <description>libqmf-tests:tst_qmailstorekeys:accountFromAddress</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys accountFromAddress</step>
+      </case>
+      <case name="tst_qmailstorekeys-accountStatus">
+        <description>libqmf-tests:tst_qmailstorekeys:accountStatus</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys accountStatus</step>
+      </case>
+      <case name="tst_qmailstorekeys-accountCustomField">
+        <description>libqmf-tests:tst_qmailstorekeys:accountCustomField</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys accountCustomField</step>
+      </case>
+      <case name="tst_qmailstorekeys-folderId">
+        <description>libqmf-tests:tst_qmailstorekeys:folderId</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys folderId</step>
+      </case>
+      <case name="tst_qmailstorekeys-folderPath">
+        <description>libqmf-tests:tst_qmailstorekeys:folderPath</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys folderPath</step>
+      </case>
+      <case name="tst_qmailstorekeys-folderParentFolderId">
+        <description>libqmf-tests:tst_qmailstorekeys:folderParentFolderId</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys folderParentFolderId</step>
+      </case>
+      <case name="tst_qmailstorekeys-folderParentAccountId">
+        <description>libqmf-tests:tst_qmailstorekeys:folderParentAccountId</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys folderParentAccountId</step>
+      </case>
+      <case name="tst_qmailstorekeys-folderDisplayName">
+        <description>libqmf-tests:tst_qmailstorekeys:folderDisplayName</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys folderDisplayName</step>
+      </case>
+      <case name="tst_qmailstorekeys-folderStatus">
+        <description>libqmf-tests:tst_qmailstorekeys:folderStatus</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys folderStatus</step>
+      </case>
+      <case name="tst_qmailstorekeys-folderAncestorFolderIds">
+        <description>libqmf-tests:tst_qmailstorekeys:folderAncestorFolderIds</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys folderAncestorFolderIds</step>
+      </case>
+      <case name="tst_qmailstorekeys-folderCustomField">
+        <description>libqmf-tests:tst_qmailstorekeys:folderCustomField</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys folderCustomField</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageId">
+        <description>libqmf-tests:tst_qmailstorekeys:messageId</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageId</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageType">
+        <description>libqmf-tests:tst_qmailstorekeys:messageType</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageType</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageParentFolderId">
+        <description>libqmf-tests:tst_qmailstorekeys:messageParentFolderId</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageParentFolderId</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageSender">
+        <description>libqmf-tests:tst_qmailstorekeys:messageSender</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageSender</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageRecipients">
+        <description>libqmf-tests:tst_qmailstorekeys:messageRecipients</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageRecipients</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageSubject">
+        <description>libqmf-tests:tst_qmailstorekeys:messageSubject</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageSubject</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageTimeStamp">
+        <description>libqmf-tests:tst_qmailstorekeys:messageTimeStamp</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageTimeStamp</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageReceptionTimeStamp">
+        <description>libqmf-tests:tst_qmailstorekeys:messageReceptionTimeStamp</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageReceptionTimeStamp</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageStatus">
+        <description>libqmf-tests:tst_qmailstorekeys:messageStatus</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageStatus</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageConversation">
+        <description>libqmf-tests:tst_qmailstorekeys:messageConversation</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageConversation</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageServerUid">
+        <description>libqmf-tests:tst_qmailstorekeys:messageServerUid</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageServerUid</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageSize">
+        <description>libqmf-tests:tst_qmailstorekeys:messageSize</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageSize</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageParentAccountId">
+        <description>libqmf-tests:tst_qmailstorekeys:messageParentAccountId</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageParentAccountId</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageAncestorFolderIds">
+        <description>libqmf-tests:tst_qmailstorekeys:messageAncestorFolderIds</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageAncestorFolderIds</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageContentType">
+        <description>libqmf-tests:tst_qmailstorekeys:messageContentType</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageContentType</step>
+      </case>
+      <case name="tst_qmailstorekeys-messagePreviousParentFolderId">
+        <description>libqmf-tests:tst_qmailstorekeys:messagePreviousParentFolderId</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messagePreviousParentFolderId</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageInResponseTo">
+        <description>libqmf-tests:tst_qmailstorekeys:messageInResponseTo</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageInResponseTo</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageResponseType">
+        <description>libqmf-tests:tst_qmailstorekeys:messageResponseType</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageResponseType</step>
+      </case>
+      <case name="tst_qmailstorekeys-messageCustom">
+        <description>libqmf-tests:tst_qmailstorekeys:messageCustom</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys messageCustom</step>
+      </case>
+      <case name="tst_qmailstorekeys-listModel">
+        <description>libqmf-tests:tst_qmailstorekeys:listModel</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys listModel</step>
+      </case>
+      <case name="tst_qmailstorekeys-threadedModel">
+        <description>libqmf-tests:tst_qmailstorekeys:threadedModel</description>
+        <step>/usr/tests/qmf/tst_qmailstorekeys threadedModel</step>
+      </case>
+      <environments>
+        <scratchbox>true</scratchbox>
+        <hardware>true</hardware>
+      </environments>
+    </set>
+  </suite>
+</testdefinition>
+
diff --git a/tests/tst_python_email/tst_python_email.cpp b/tests/tst_python_email/tst_python_email.cpp
index 80763b3..16f8e8a 100644
--- a/tests/tst_python_email/tst_python_email.cpp
+++ b/tests/tst_python_email/tst_python_email.cpp
@@ -192,8 +192,8 @@ tst_python_email::~tst_python_email()
 
 QString tst_python_email::path(const QString& filename)
 {
-    // SRCDIR is defined in the .pro file as the directory where the .pro is located
-    return QString(SRCDIR "/testdata/") + filename;
+    // We assume that testdata folder is in the same folder as unit test executable
+    return QCoreApplication::applicationDirPath() + QString("/testdata/") + filename;
 }
 
 QMailMessage tst_python_email::fromFile(const QString& filename)
@@ -217,7 +217,7 @@ void tst_python_email::test_get_all()
     QCOMPARE( msg.headerFieldsText("cc"), to );
     QCOMPARE( msg.headerFieldsText("xx"), QStringList() );
 
-    // Note that our cc() function will return the content of the first encountered 
+    // Note that our cc() function will return the content of the first encountered
     // field; it is illegal to have more than one CC field, so this seems acceptable...
     QCOMPARE( msg.cc(), ( QList<QMailAddress>() << QMailAddress("ccc@zzz.test") ) );
 }
@@ -603,7 +603,7 @@ void tst_python_email::test_long_nonstring()
     //original = "Finan" "\xe8" "ni metropole se hroutily pod tlakem jejich d" "\xf9" "vtipu.. ";
     //input.append(' ').append(QMailMessageHeaderField::encodeWord(original, "ISO-8859-2"));
 
-    // Python appears to identify runs of single-byte characters within unicode strings, and 
+    // Python appears to identify runs of single-byte characters within unicode strings, and
     // output them in quoted-printable encoded-words.  We don't do that.
     QChar chars[] = { 0x6b63, 0x78ba, 0x306b, 0x8a00, 0x3046, 0x3068, 0x7ffb, 0x8a33, 0x306f, 0x3055, 0x308c, 0x3066, 0x3044, 0x307e, 0x305b, 0x3093, 0x3002, 0x4e00, 0x90e8, 0x306f, 0x30c9, 0x30a4, 0x30c4, 0x8a9e, 0x3067, 0x3059, 0x304c, 0x3001, 0x3042, 0x3068, 0x306f, 0x3067, 0x305f, 0x3089, 0x3081, 0x3067, 0x3059, 0x3002, 0x5b9f, 0x969b, 0x306b, 0x306f, 0x300c, 'W', 'e', 'n', 'n', ' ', 'i', 's', 't', ' ', 'd', 'a', 's', ' ', 'N', 'u', 'n', 's', 't', 'u', 'c', 'k', ' ', 'g', 'i', 't', ' ', 'u', 'n', 'd', ' ', 'S', 'l', 'o', 't', 'e', 'r', 'm', 'e', 'y', 'e', 'r', '?', ' ', 'J', 'a', '!', ' ', 'B', 'e', 'i', 'h', 'e', 'r', 'h', 'u', 'n', 'd', ' ', 'd', 'a', 's', ' ', 'O', 'd', 'e', 'r', ' ', 'd', 'i', 'e', ' ', 'F', 'l', 'i', 'p', 'p', 'e', 'r', 'w', 'a', 'l', 'd', 't', ' ', 'g', 'e', 'r', 's', 'p', 'u', 't', '.', 0x300d, 0x3068, 0x8a00, 0x3063, 0x3066, 0x3044, 0x307e, 0x3059, 0x3002 };
     original = QString(chars, sizeof(chars) / sizeof(chars[0]));
@@ -697,7 +697,7 @@ void tst_python_email::test_no_split_long_header()
 
 void tst_python_email::test_splitting_multiple_long_lines()
 {
-    QByteArray input = 
+    QByteArray input =
 "from babylon.scr.example.org (localhost [127.0.0.1]); by babylon.scr.example.org (Postfix) with ESMTP id B570E51B81; for <mailman-admin@babylon.scr.example.org>; Sat, 2 Feb 2002 17:00:06 -0800 (PST)"
 "\tfrom babylon.scr.example.org (localhost [127.0.0.1]); by babylon.scr.example.org (Postfix) with ESMTP id B570E51B81; for <mailman-admin@babylon.scr.example.org>; Sat, 2 Feb 2002 17:00:06 -0800 (PST)"
 "\tfrom babylon.scr.example.org (localhost [127.0.0.1]); by babylon.scr.example.org (Postfix) with ESMTP id B570E51B81; for <mailman-admin@babylon.scr.example.org>; Sat, 2 Feb 2002 17:00:06 -0800 (PST)";
@@ -721,7 +721,7 @@ void tst_python_email::test_splitting_multiple_long_lines()
 
 void tst_python_email::test_splitting_first_line_only_is_long()
 {
-    QByteArray input = 
+    QByteArray input =
 "from modemcable093.139-201-24.que.mc.vidtron.test ([24.201.139.93] helo=cthulhu.gg.test)"
 "\tby kronos.mems-exchange.test with esmtp (Exim 4.05)"
 "\tid 17k4h5-00034i-00"
@@ -746,7 +746,7 @@ void tst_python_email::test_long_8bit_header()
     input.append(' ').append(QMailMessageHeaderField::encodeWord(original, "ISO-8859-1"));
 
     // Note the same as the equivalent python formulation, but again, conforming
-    QByteArray output = 
+    QByteArray output =
 "Subject: =?ISO-8859-1?Q?Britische_Regierung_gibt?=" CRLF
 " =?ISO-8859-1?Q?gr=FCnes_Licht_f=FCr_Offshore-Windkraftprojekte?=";
 
@@ -757,7 +757,7 @@ void tst_python_email::test_long_8bit_header()
 
 void tst_python_email::test_long_to_header()
 {
-    QByteArray input = 
+    QByteArray input =
 "\"Someone Test #A\" <someone@eecs.umich.test>,<someone@eecs.umich.test>,\"Someone Test #B\" <someone@umich.test>, \"Someone Test #C\" <someone@eecs.umich.test>, \"Someone Test #D\" <someone@eecs.umich.test>";
 
     // Note the same as the equivalent python formulation, but again, conforming
@@ -774,7 +774,7 @@ void tst_python_email::test_long_to_header()
 
 void tst_python_email::test_long_field_name()
 {
-    QString original = 
+    QString original =
 "Die Mieter treten hier ein werden mit einem Foerderband komfortabel den Korridor entlang, an s" "\xfc" "dl" "\xf" "cndischen Wandgem" "\xe4" "lden vorbei, gegen die rotierenden Klingen bef" "\xf6" "rdert. ";
     QByteArray input = QMailMessageHeaderField::encodeContent(original);
 
@@ -807,7 +807,7 @@ void tst_python_email::test_long_field_name()
 void tst_python_email::test_string_headerinst_eq()
 {
     // This test doesn't really achieve anything except use of realistic-looking header string...
-    QByteArray input = 
+    QByteArray input =
 "<15975.17901.207240.414604@sgritzmann1.mathematik.tu-muenchen.test> (David Bremner's message of \"Thu, 6 Mar 2003 13:58:21 +0100\")";
 
     // Note the same as the equivalent python formulation, but again, conforming
@@ -822,7 +822,7 @@ void tst_python_email::test_string_headerinst_eq()
 
 void tst_python_email::test_another_long_multiline_header()
 {
-    QByteArray input = 
+    QByteArray input =
 "Received: from siimage.test ([172.25.1.3]) by zima.siliconimage.test with Microsoft SMTPSVC(5.0.2195.4905);" CRLF
 "\tWed, 16 Oct 2002 07:41:11 -0700";
 
@@ -840,7 +840,7 @@ void tst_python_email::test_another_long_multiline_header()
 void tst_python_email::test_long_lines_with_different_header()
 {
     // This test doesn't really achieve anything except use of realistic-looking header string...
-    QByteArray input = 
+    QByteArray input =
 "List: List-Unsubscribe: <https://lists.sourceforge.test/lists/listinfo/spamassassin-talk>," CRLF
 "\t<mailto:spamassassin-talk-request@lists.sourceforge.test?subject=unsubscribe>";
 
@@ -919,7 +919,7 @@ void tst_python_email::test_hierarchy()
 {
     QString p(path("PyBanner048.gif"));
 
-    QByteArray input = 
+    QByteArray input =
 "Hi there," CRLF
 CRLF
 "This is the dingus fish." CRLF;
@@ -970,7 +970,7 @@ CRLF
 
 void tst_python_email::test_empty_multipart_idempotent()
 {
-    QByteArray input = 
+    QByteArray input =
 "Content-Type: multipart/mixed; boundary=\"BOUNDARY\"" CRLF
 "MIME-Version: 1.0" CRLF
 "Subject: A subject" CRLF
@@ -1014,7 +1014,7 @@ void tst_python_email::test_no_parts_in_a_multipart_with_none_epilogue()
 
     // Note - python produces an empty, one-part formulation for this test.  I think
     // neither formulation is well-formed, so it probably doesn't matter that we differ...
-    QByteArray output = 
+    QByteArray output =
 "Content-Type: multipart/mixed; boundary=BOUNDARY" CRLF
 "Subject: A subject" CRLF
 "To: aperson@domain.example" CRLF
@@ -1048,7 +1048,7 @@ void tst_python_email::test_one_part_in_a_multipart()
 
     msg.appendPart(textPart);
 
-    QByteArray output = 
+    QByteArray output =
 "Content-Type: multipart/mixed; boundary=BOUNDARY" CRLF
 "Subject: A subject" CRLF
 "To: aperson@domain.example" CRLF
@@ -1122,7 +1122,7 @@ void tst_python_email::test_nested_inner_contains_outer_boundary()
         # these are illegal and should be interpreted as unterminated inner
         # parts.
 
-    Note: AFAICT, this is illegal, due to the following stipulation: 
+    Note: AFAICT, this is illegal, due to the following stipulation:
     "Boundary delimiters must not appear within the encapsulated material"
     And we don't support it, apart from accepting the input.
     */
@@ -1166,7 +1166,7 @@ Content-Transfer-Encoding: 7Bit\n\
 
 void tst_python_email::test_boundary_with_leading_space()
 {
-    QByteArray input = 
+    QByteArray input =
 "MIME-Version: 1.0" CRLF
 "Content-Type: multipart/mixed; boundary=\"    XXXX\"" CRLF
 CRLF
@@ -1193,7 +1193,7 @@ CRLF
 
 void tst_python_email::test_boundary_without_trailing_newline()
 {
-    QByteArray input = 
+    QByteArray input =
 "Content-Type: multipart/mixed; boundary=\"===============0012394164==\"" CRLF
 "MIME-Version: 1.0" CRLF
 CRLF
@@ -1248,7 +1248,7 @@ void tst_python_email::test_multipart_no_boundary()
 
 void tst_python_email::test_invalid_content_type()
 {
-    QByteArray input = 
+    QByteArray input =
 "Content-Type: text";
 
     QMailMessage msg = QMailMessage::fromRfc2822(input);
@@ -1272,7 +1272,7 @@ void tst_python_email::test_no_start_boundary()
        format, will insert the text as a plain body.  If anything, I think we should
        treat it as a preamble...
 
-    QByteArray output = 
+    QByteArray output =
 "--BOUNDARY" CRLF
 "Content-Type: text/plain" CRLF
 CRLF
@@ -1402,7 +1402,7 @@ void tst_python_email::test_generate()
     msg.setHeaderField("Date", "irrelevant");
     msg.setBody(QMailMessageBody::fromData(subMessage.toRfc2822(QMailMessage::IdentityFormat), type, QMailMessageBody::SevenBit, QMailMessageBody::AlreadyEncoded));
 
-    QByteArray output = 
+    QByteArray output =
 "Subject: The enclosing message" CRLF
 "Date: irrelevant" CRLF
 "Content-Type: message/rfc822" CRLF
@@ -1421,7 +1421,7 @@ CRLF
 void tst_python_email::test_parse_message_rfc822()
 {
     QMailMessage msg = fromFile("msg_11.txt");
-    
+
     QCOMPARE( msg.multipartType(), QMailMessagePartContainer::MultipartNone );
     QCOMPARE( msg.contentType().content().toLower(), QByteArray("message/rfc822") );
     QVERIFY( msg.hasBody() );
@@ -1441,12 +1441,12 @@ void tst_python_email::test_parse_message_rfc822()
 void tst_python_email::test_dsn()
 {
     QMailMessage msg = fromFile("msg_16.txt");
-    
+
     QCOMPARE( msg.multipartType(), QMailMessagePartContainer::MultipartReport );
     QCOMPARE( msg.contentType().content().toLower(), QByteArray("multipart/report") );
     QVERIFY( msg.hasBody() == false );
     QCOMPARE( msg.partCount(), 3u );
-    
+
     QByteArray output = "\
 This report relates to a message you sent with the following header fields:\n\
 \n\
@@ -1514,17 +1514,17 @@ Your message cannot be delivered to the following recipients:\n\
 
 void tst_python_email::test_epilogue()
 {
-    // Python allows the client to set the preamble and epilogue of a 
+    // Python allows the client to set the preamble and epilogue of a
     // multipart message. Since we don't, we will only test that the message
     // is correctly parsed here
     QMailMessage msg = fromFile("msg_21.txt");
-    
+
     QCOMPARE( msg.multipartType(), QMailMessagePartContainer::MultipartMixed );
     QCOMPARE( msg.contentType().content().toLower(), QByteArray("multipart/mixed") );
     QVERIFY( msg.hasBody() == false );
     QCOMPARE( msg.partCount(), 2u );
 
-    QByteArray output = 
+    QByteArray output =
 "This report relates to a message you sent with the following header fields:" CRLF
 CRLF
 "  Message-id: <002001c144a6$8752e060$56104586@oxy.test>" CRLF
@@ -1557,7 +1557,7 @@ CRLF;
 void tst_python_email::test_default_type()
 {
     QMailMessage msg = fromFile("msg_30.txt");
-    
+
     QCOMPARE( msg.multipartType(), QMailMessagePartContainer::MultipartDigest );
     QCOMPARE( msg.contentType().content().toLower(), QByteArray("multipart/digest") );
     QVERIFY( msg.hasBody() == false );
@@ -1593,7 +1593,7 @@ void tst_python_email::test_default_type()
 void tst_python_email::test_default_type_with_explicit_container_type()
 {
     QMailMessage msg = fromFile("msg_28.txt");
-    
+
     QCOMPARE( msg.multipartType(), QMailMessagePartContainer::MultipartDigest );
     QCOMPARE( msg.contentType().content().toLower(), QByteArray("multipart/digest") );
     QVERIFY( msg.hasBody() == false );
@@ -1718,7 +1718,7 @@ void tst_python_email::test_rfc2231_set_param()
     field.setParameterEncoded("title");
     msg.setHeaderField(field);
 
-    QByteArray output = 
+    QByteArray output =
 "Return-Path: <bbb@zzz.test>" CRLF
 "Delivered-To: bbb@zzz.test" CRLF
 "Received: by mail.zzz.test (Postfix, from userid 889)\tid 27CEAD38CC;" CRLF
diff --git a/tests/tst_python_email/tst_python_email.pro b/tests/tst_python_email/tst_python_email.pro
index 6f8e97e..dd95467 100644
--- a/tests/tst_python_email/tst_python_email.pro
+++ b/tests/tst_python_email/tst_python_email.pro
@@ -6,9 +6,7 @@ TEMPLATE = app
 TARGET = tst_python_email
 target.path += $$QMF_INSTALL_ROOT/tests
 
-DEFINES += SRCDIR=\\\"$$_PRO_FILE_PWD_\\\"
-
-testdata.path = $$QMF_INSTALL_ROOT/tests/testdata 
+testdata.path = $$QMF_INSTALL_ROOT/tests/
 testdata.files = testdata/
 
 INSTALLS += target \
diff --git a/tests/tst_qlogsystem/tst_qlogsystem.cpp b/tests/tst_qlogsystem/tst_qlogsystem.cpp
new file mode 100644
index 0000000..7643048
--- /dev/null
+++ b/tests/tst_qlogsystem/tst_qlogsystem.cpp
@@ -0,0 +1,308 @@
+/****************************************************************************
+**
+** Copyright (C) 2009 Nokia Corporation and/or its subsidiary(-ies).
+** Contact: Nokia Corporation (qt-info@nokia.com)
+**
+** This file is part of the Qt Messaging Framework.
+**
+** $QT_BEGIN_LICENSE:LGPL$
+** No Commercial Usage
+** This file contains pre-release code and may not be distributed.
+** You may use this file in accordance with the terms and conditions
+** contained in the either Technology Preview License Agreement or the
+** Beta Release License Agreement.
+**
+** GNU Lesser General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU Lesser
+** General Public License version 2.1 as published by the Free Software
+** Foundation and appearing in the file LICENSE.LGPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU Lesser General Public License version 2.1 requirements
+** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
+**
+** In addition, as a special exception, Nokia gives you certain
+** additional rights. These rights are described in the Nokia Qt LGPL
+** Exception version 1.0, included in the file LGPL_EXCEPTION.txt in this
+** package.
+**
+** GNU General Public License Usage
+** Alternatively, this file may be used under the terms of the GNU
+** General Public License version 3.0 as published by the Free Software
+** Foundation and appearing in the file LICENSE.GPL included in the
+** packaging of this file.  Please review the following information to
+** ensure the GNU General Public License version 3.0 requirements will be
+** met: http://www.gnu.org/copyleft/gpl.html.
+**
+** If you are unsure which license is appropriate for your use, please
+** contact the sales department at qt-sales@nokia.com.
+** $QT_END_LICENSE$
+**
+****************************************************************************/
+
+#include <QObject>
+#include <QTest>
+#include <QFile>
+
+#include <qloggers.h>
+
+//TESTED_CLASS= LogSystem
+//TESTED_FILES=src/libraries/qtopiamail/support/qlogsystem.cpp
+
+/*
+    This class primarily tests that LogSystem correctly handles e-mail messages.
+*/
+class tst_QLogSystem : public QObject
+{
+    Q_OBJECT
+
+public:
+    tst_QLogSystem();
+    virtual ~tst_QLogSystem();
+
+private slots:
+    virtual void initTestCase();
+    virtual void cleanupTestCase();
+    virtual void init();
+    virtual void cleanup();
+
+    void loggerConstruction();
+    void minLogLvl();
+
+    void loggerOutput_data();
+    void loggerOutput();
+
+    void qDebugOutput_data();
+    void qDebugOutput();
+
+    void qWarningOutput_data();
+    void qWarningOutput();
+
+    void sysLoggerOutput();
+};
+
+QTEST_MAIN(tst_QLogSystem)
+
+#include "tst_qlogsystem.moc"
+
+
+tst_QLogSystem::tst_QLogSystem()
+{
+}
+
+tst_QLogSystem::~tst_QLogSystem()
+{
+}
+
+void tst_QLogSystem::initTestCase()
+{ // this file will be regenerated in each test
+    if(QFile::exists("./LoggersTest.log"))
+        QVERIFY2(QFile::remove("./LoggersTest.log"), "could not delete log file");
+}
+
+
+void tst_QLogSystem::cleanupTestCase()
+{
+}
+
+void tst_QLogSystem::init()
+{
+}
+
+void tst_QLogSystem::cleanup()
+{    
+    if(QFile::exists("./LoggersTest.log"))
+        QVERIFY2(QFile::remove("./LoggersTest.log"), "could not delete log file");
+}
+Q_DECLARE_METATYPE(LogLevel)
+
+void tst_QLogSystem::loggerConstruction()
+{
+    FileLogger<> l_name1("NO-DIRECTORY/file-should-not-be-opened");
+    QString err_msg;
+    QVERIFY2(!l_name1.isReady(err_msg), "File logger is ready with invalid dir.");
+    QVERIFY2(!err_msg.isEmpty(), "File logger has not obtained error message");
+
+    err_msg = QString("");
+
+    FileLogger<> l_name2("./LoggersTest.log");
+    QVERIFY2(l_name2.isReady(err_msg), "File logger is not ready with local dir.");
+    QVERIFY2(err_msg.isEmpty(), "File logger has obtained error message with local dir");
+    QVERIFY2(QFile::remove("./LoggersTest.log"), "could not delete log file");
+
+    FileLogger<> l_name3(stdout);
+    QVERIFY2(l_name3.isReady(err_msg), "File logger is not ready with stdout.");
+    QVERIFY2(err_msg.isEmpty(), "File logger has obtained error message with stdout.");
+
+    FileLogger<> l_name4(stderr);
+    QVERIFY2(l_name4.isReady(err_msg), "File logger is not ready with stderr.");
+    QVERIFY2(err_msg.isEmpty(), "File logger has obtained error message with stderr.");
+}
+
+void tst_QLogSystem::minLogLvl()
+{
+
+    FileLogger<LvlLogPrefix>* fileLogger = new FileLogger<LvlLogPrefix>("./LoggersTest.log");
+    char forbidden[] = "should not be shown!";
+
+    QString err_msg;
+    QVERIFY2(fileLogger->isReady(err_msg), "File logger is not ready with local dir.");
+    QVERIFY2(err_msg.isEmpty(), "File logger has obtained error message with local dir");
+
+    fileLogger->setMinLogLvl(LlWarning);
+
+    LogSystem::getInstance().addLogger(fileLogger);
+    LogSystem::getInstance().log(LlInfo, forbidden);
+    LogSystem::getInstance().clear();
+
+    QFile file("./LoggersTest.log");
+    QVERIFY2(file.open(QFile::ReadOnly), "Could not open log file for reading");
+    QByteArray dataBuf= file.readLine();
+    file.close();
+
+    QVERIFY2(dataBuf.isEmpty(), "The logger has written record with invalid Log Level");
+}
+
+void tst_QLogSystem::loggerOutput_data()
+{
+    QTest::addColumn<LogLevel>("lvl");
+    QTest::addColumn<QString>("fstr");
+    QTest::addColumn<int>("intIn");
+    QTest::addColumn<QString>("chIn");
+    QTest::addColumn<double>("dlIn");
+    QTest::addColumn<QString>("expected");
+
+    QTest::newRow("test 'log' method dbg level")<<LlDbg<<"Test: '%d' '%s' '%.2f'"<<12<<"string"<<12.25<<"[Debug] Test: '12' 'string' '12.25'\n";
+    QTest::newRow("test 'log' method info level")<<LlInfo<<"Test: '%d' '%s' '%.2f'"<<12<<"string"<<12.25<<"[Info] Test: '12' 'string' '12.25'\n";
+    QTest::newRow("test 'log' method warn level")<<LlWarning<< "Test: '%d' '%s' '%.2f'"<<12<<"string"<<12.25<<"[Warning] Test: '12' 'string' '12.25'\n";
+    QTest::newRow("test 'log' method err level")<<LlError<< "Test: '%d' '%s' '%.2f'"<<12<<"string"<<12.25<<"[Error] Test: '12' 'string' '12.25'\n";
+    QTest::newRow("test 'log' method err level")<<LlCritical<< "Test: '%d' '%s' '%.2f'"<<12<<"string"<<12.25<<"[Critical] Test: '12' 'string' '12.25'\n";
+}
+
+
+void tst_QLogSystem::loggerOutput()
+{
+    QFETCH(LogLevel, lvl);
+    QFETCH(QString, fstr);
+    QFETCH(int, intIn);
+    QFETCH(QString, chIn);
+    QFETCH(double, dlIn);
+    QFETCH(QString, expected);
+
+    FileLogger<LvlLogPrefix>* fileLogger = new FileLogger<LvlLogPrefix>("./LoggersTest.log");
+    fileLogger->setMinLogLvl(LlDbg);
+
+    QString err_msg;
+    QVERIFY2(fileLogger->isReady(err_msg), "File logger is not ready with local dir.");
+    QVERIFY2(err_msg.isEmpty(), "File logger has obtained error message with local dir");
+
+    LogSystem::getInstance().addLogger(fileLogger);
+    LogSystem::getInstance().log(lvl, qPrintable(fstr), intIn,  qPrintable(chIn), dlIn);
+    LogSystem::getInstance().clear();
+
+    QFile file("./LoggersTest.log");
+    QVERIFY2(file.open(QFile::ReadOnly), "Could not open log file for reading");
+    QByteArray dataBuf= file.readLine();
+
+    QCOMPARE( QString(dataBuf.data()), expected);
+
+    file.close();
+}
+
+void tst_QLogSystem::qDebugOutput_data()
+{
+    QTest::addColumn<QString>("fstr");
+    QTest::addColumn<int>("intIn");
+    QTest::addColumn<QString>("chIn");
+    QTest::addColumn<double>("dlIn");
+    QTest::addColumn<QString>("expected");
+
+    QTest::newRow("test 'log' method dbg level")<<"Test: '%d' '%s' '%.2f'"<<12<<"string"<<12.25<<"[Debug] Test: '12' 'string' '12.25'\n";
+}
+
+
+void tst_QLogSystem::qDebugOutput()
+{
+    QFETCH(QString, fstr);
+    QFETCH(int, intIn);
+    QFETCH(QString, chIn);
+    QFETCH(double, dlIn);
+    QFETCH(QString, expected);
+
+    FileLogger<LvlLogPrefix>* fileLogger = new FileLogger<LvlLogPrefix>("./LoggersTest.log");
+    fileLogger->setMinLogLvl(LlDbg);
+    
+    QString err_msg;
+    QVERIFY2(fileLogger->isReady(err_msg), "File logger is not ready with local dir.");
+    QVERIFY2(err_msg.isEmpty(), "File logger has obtained error message with local dir");
+
+    LogSystem::getInstance().addLogger(fileLogger);
+    qDebug(qPrintable(fstr), intIn,  qPrintable(chIn), dlIn);
+    LogSystem::getInstance().clear();
+
+    QFile file("./LoggersTest.log");
+    QVERIFY2(file.open(QFile::ReadOnly), "Could not open log file for reading");
+    QByteArray dataBuf= file.readLine();
+
+    QCOMPARE( QString(dataBuf.data()), expected);
+
+    file.close();
+    QVERIFY2(QFile::remove("./LoggersTest.log"), "could not delete log file");
+}
+
+void tst_QLogSystem::qWarningOutput_data()
+{
+    QTest::addColumn<QString>("fstr");
+    QTest::addColumn<int>("intIn");
+    QTest::addColumn<QString>("chIn");
+    QTest::addColumn<double>("dlIn");
+    QTest::addColumn<QString>("expected");
+
+    QTest::newRow("test 'log' method warn level")<< "Test: '%d' '%s' '%.2f'"<<12<<"string"<<12.25<<"[Warning] Test: '12' 'string' '12.25'\n";
+}
+
+void tst_QLogSystem::qWarningOutput()
+{
+    QFETCH(QString, fstr);
+    QFETCH(int, intIn);
+    QFETCH(QString, chIn);
+    QFETCH(double, dlIn);
+    QFETCH(QString, expected);
+
+    FileLogger<LvlLogPrefix>* fileLogger = new FileLogger<LvlLogPrefix>("./LoggersTest.log");
+    fileLogger->setMinLogLvl(LlDbg);
+    
+    QString err_msg;
+    QVERIFY2(fileLogger->isReady(err_msg), "File logger is not ready with local dir.");
+    QVERIFY2(err_msg.isEmpty(), "File logger has obtained error message with local dir");
+
+    LogSystem::getInstance().addLogger(fileLogger);
+    qWarning(qPrintable(fstr), intIn,  qPrintable(chIn), dlIn);
+    LogSystem::getInstance().clear();
+
+    QFile file("./LoggersTest.log");
+    QVERIFY2(file.open(QFile::ReadOnly), "Could not open log file for reading");
+    QByteArray dataBuf= file.readLine();
+
+    QCOMPARE(QString(dataBuf.data()), expected);
+
+    file.close();
+}
+
+void tst_QLogSystem::sysLoggerOutput()
+{
+    QString expected = "[Debug] Test: '12' 'string' '12.25'\n";
+
+    SysLogger<LvlLogPrefix>* sysLogger = new SysLogger<LvlLogPrefix>("QMail logger test", LOG_PID, LOG_LOCAL7);
+    sysLogger->setMinLogLvl(LlDbg);
+    
+    QString err_msg;
+    QVERIFY2(sysLogger->isReady(err_msg), "File logger is not ready with local dir.");
+    QVERIFY2(err_msg.isEmpty(), "File logger has obtained error message with local dir");
+
+    LogSystem::getInstance().addLogger(sysLogger);
+    LogSystem::getInstance().log(LlDbg, "Test: '%d' '%s' '%.2f'", 12,  "string", 12.25);
+    LogSystem::getInstance().clear();
+
+    QWARN (qPrintable(tr("Now You should see the string") + expected + tr("at syslog output LOG_LOCAL7, LOG_INFO")));
+}
+
diff --git a/tests/tst_qlogsystem/tst_qlogsystem.pro b/tests/tst_qlogsystem/tst_qlogsystem.pro
new file mode 100644
index 0000000..8d14870
--- /dev/null
+++ b/tests/tst_qlogsystem/tst_qlogsystem.pro
@@ -0,0 +1,17 @@
+CONFIG += qtestlib unittest
+
+include(../../common.pri)
+
+TEMPLATE = app
+TARGET = tst_qlogsystem
+target.path += $$QMF_INSTALL_ROOT/tests
+INSTALLS += target
+
+QTOPIAMAIL=../../src/libraries/qtopiamail
+
+DEPENDPATH += .
+INCLUDEPATH += . $$QTOPIAMAIL $$QTOPIAMAIL/support
+LIBS += -L$$QTOPIAMAIL -lqtopiamail
+QMAKE_LFLAGS += -Wl,-rpath,$$QTOPIAMAIL
+
+SOURCES += tst_qlogsystem.cpp
diff --git a/tests/tst_qmailstore/tst_qmailstore.cpp b/tests/tst_qmailstore/tst_qmailstore.cpp
index 0a12c85..20e431b 100644
--- a/tests/tst_qmailstore/tst_qmailstore.cpp
+++ b/tests/tst_qmailstore/tst_qmailstore.cpp
@@ -71,6 +71,7 @@ private slots:
     void addFolder();
     void addMessage();
     void addMessages();
+    void addMessages2();
     void updateAccount();
     void updateFolder();
     void updateMessage();
@@ -491,6 +492,79 @@ void tst_QMailStore::addMessages()
     QCOMPARE(QMailStore::instance()->queryMessages(key, sort, 10, 0), messageIds);
 }
 
+void tst_QMailStore::addMessages2()
+{
+    QMailAccount account;
+    account.setName("Account");
+
+    QCOMPARE(QMailStore::instance()->countAccounts(), 0);
+    QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+    QVERIFY(!account.id().isValid());
+    QVERIFY(QMailStore::instance()->addAccount(&account, 0));
+    QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+    QVERIFY(account.id().isValid());
+    QCOMPARE(QMailStore::instance()->countAccounts(), 1);
+    QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+
+    QMailFolder folder;
+    folder.setPath("Folder");
+    folder.setParentAccountId(account.id());
+
+    QCOMPARE(QMailStore::instance()->countFolders(), 0);
+    QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+    QVERIFY(!folder.id().isValid());
+    QVERIFY(QMailStore::instance()->addFolder(&folder));
+    QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+    QVERIFY(folder.id().isValid());
+    QCOMPARE(QMailStore::instance()->countFolders(), 1);
+    QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+
+    QList<QMailMessage> messages;
+    QList<QMailMessage*> messageAddresses;
+    for (int i = 1; i <= 10; ++i) {
+        QMailMessage message;
+        message.setParentAccountId(account.id());
+        message.setParentFolderId(folder.id());
+        message.setMessageType(QMailMessage::Sms);
+        message.setSubject(QString("Message %1").arg(i));
+        message.setBody(QMailMessageBody::fromData(QString("Hi #%1").arg(i), QMailMessageContentType("text/plain"), QMailMessageBody::SevenBit));
+
+        messages.append(message);
+        messageAddresses.append(&messages.last());
+    }
+
+    // Verify that addition is successful
+    QCOMPARE(QMailStore::instance()->countMessages(), 0);
+    QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+    QVERIFY(!messages.first().id().isValid());
+    QVERIFY(!messages.last().id().isValid());
+    QVERIFY(QMailStore::instance()->addMessages(messageAddresses));
+    QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+    QVERIFY(messages.first().id().isValid());
+    QVERIFY(messages.last().id().isValid());
+    QCOMPARE(QMailStore::instance()->countMessages(), 10);
+    QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+
+    // Verify that retrieval yields matching result
+    for (int i = 1; i <= 10; ++i) {
+        QMailMessage message(messages.at(i - 1).id());
+        QCOMPARE(QMailStore::instance()->lastError(), QMailStore::NoError);
+        QCOMPARE(message.subject(), QString("Message %1").arg(i));
+        QCOMPARE(message.body().data(), QString("Hi #%1").arg(i));
+    }
+
+    // Test basic limit/offset
+    QMailMessageKey key;
+    QMailMessageSortKey sort;
+    QMailMessageIdList messageIds(QMailStore::instance()->queryMessages(key, sort));
+    QCOMPARE(QMailStore::instance()->queryMessages(key, sort, 4, 0), messageIds.mid(0, 4));
+    QCOMPARE(QMailStore::instance()->queryMessages(key, sort, 4, 3), messageIds.mid(3, 4));
+    QCOMPARE(QMailStore::instance()->queryMessages(key, sort, 4, 6), messageIds.mid(6, 4));
+    QCOMPARE(QMailStore::instance()->queryMessages(key, sort, 9, 0), messageIds.mid(0, 9));
+    QCOMPARE(QMailStore::instance()->queryMessages(key, sort, 9, 1), messageIds.mid(1, 9));
+    QCOMPARE(QMailStore::instance()->queryMessages(key, sort, 10, 0), messageIds);
+}
+
 void tst_QMailStore::updateAccount()
 {
     QMailFolder folder("new folder 1");
diff --git a/tests/tst_qmailstorekeys/tst_qmailstorekeys.cpp b/tests/tst_qmailstorekeys/tst_qmailstorekeys.cpp
index 1997d27..19b24a2 100644
--- a/tests/tst_qmailstorekeys/tst_qmailstorekeys.cpp
+++ b/tests/tst_qmailstorekeys/tst_qmailstorekeys.cpp
@@ -846,50 +846,50 @@ void tst_QMailStoreKeys::accountCustomField()
 
     // Test for content equality
     QCOMPARE(accountSet(QMailAccountKey::customField("verified", "true")), verifiedAccounts);
-    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", "true")), accountSet() << accountId3);
+    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", "true")), accountSet() << accountId3 << accountId4);
     QCOMPARE(accountSet(QMailAccountKey::customField("verified", "false")), accountSet() << accountId3);
-    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", "false")), verifiedAccounts);
+    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", "false")), accountSet() << accountId1 << accountId2 << accountId4);
     QCOMPARE(accountSet(QMailAccountKey::customField("verified", "bicycle")), noAccounts);
-    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", "bicycle")), accountSet() << accountId1 << accountId2 << accountId3);
+    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", "bicycle")), allAccounts);
     QCOMPARE(accountSet(QMailAccountKey::customField("verified", QString(""))), noAccounts);
-    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", QString(""))), accountSet() << accountId1 << accountId2 << accountId3);
+    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", QString(""))), allAccounts);
     QCOMPARE(accountSet(QMailAccountKey::customField("verified", QString())), noAccounts);
-    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", QString())), accountSet() << accountId1 << accountId2 << accountId3);
+    QCOMPARE(accountSet(~QMailAccountKey::customField("verified", QString())), allAccounts);
 
     // Test for content inequality
-    QCOMPARE(accountSet(QMailAccountKey::customField("verified", "true", NotEqual)), accountSet() << accountId3);
+    QCOMPARE(accountSet(QMailAccountKey::customField("verified", "true", NotEqual)), accountSet() << accountId3 << accountId4);
     QCOMPARE(accountSet(~QMailAccountKey::customField("verified", "true", NotEqual)), verifiedAccounts);
-    QCOMPARE(accountSet(QMailAccountKey::customField("verified", "false", NotEqual)), verifiedAccounts);
+    QCOMPARE(accountSet(QMailAccountKey::customField("verified", "false", NotEqual)), accountSet() << accountId1 << accountId2 << accountId4);
     QCOMPARE(accountSet(~QMailAccountKey::customField("verified", "false", NotEqual)), accountSet() << accountId3);
-    QCOMPARE(accountSet(QMailAccountKey::customField("verified", "bicycle", NotEqual)), accountSet() << accountId1 << accountId2 << accountId3);
+    QCOMPARE(accountSet(QMailAccountKey::customField("verified", "bicycle", NotEqual)), allAccounts);
     QCOMPARE(accountSet(~QMailAccountKey::customField("verified", "bicycle", NotEqual)), noAccounts);
-    QCOMPARE(accountSet(QMailAccountKey::customField("verified", QString(""), NotEqual)), accountSet() << accountId1 << accountId2 << accountId3);
+    QCOMPARE(accountSet(QMailAccountKey::customField("verified", QString(""), NotEqual)), allAccounts);
     QCOMPARE(accountSet(~QMailAccountKey::customField("verified", QString(""), NotEqual)), noAccounts);
-    QCOMPARE(accountSet(QMailAccountKey::customField("verified", QString(), NotEqual)), accountSet() << accountId1 << accountId2 << accountId3);
+    QCOMPARE(accountSet(QMailAccountKey::customField("verified", QString(), NotEqual)), allAccounts);
     QCOMPARE(accountSet(~QMailAccountKey::customField("verified", QString(), NotEqual)), noAccounts);
 
     // Test for partial matches
     QCOMPARE(accountSet(QMailAccountKey::customField("answer", "Fi", Includes)), accountSet() << accountId1);
-    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", "Fi", Includes)), accountSet() << accountId2);
+    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", "Fi", Includes)), accountSet() << accountId2 << accountId3 << accountId4);
     QCOMPARE(accountSet(QMailAccountKey::customField("answer", "assi", Includes)), accountSet() << accountId2); 
-    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", "assi", Includes)), accountSet() << accountId1); 
+    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", "assi", Includes)), accountSet() << accountId1 << accountId3 << accountId4);
     QCOMPARE(accountSet(QMailAccountKey::customField("answer", "bicycle", Includes)), noAccounts);
-    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", "bicycle", Includes)), accountSet() << accountId1 << accountId2);
+    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", "bicycle", Includes)), allAccounts);
     QCOMPARE(accountSet(QMailAccountKey::customField("answer", QString(""), Includes)), accountSet() << accountId1 << accountId2);
-    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", QString(""), Includes)), noAccounts);
+    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", QString(""), Includes)), accountSet() << accountId3 << accountId4);
     QCOMPARE(accountSet(QMailAccountKey::customField("answer", QString(), Includes)), accountSet() << accountId1 << accountId2);
-    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", QString(), Includes)), noAccounts);
+    QCOMPARE(accountSet(~QMailAccountKey::customField("answer", QString(), Includes)), accountSet() << accountId3 << accountId4);
 
     // Test for partial match exclusion
-    QCOMPARE(accountSet(QMailAccountKey::customField("answer", "Fi", Excludes)), accountSet() << accountId2);
+    QCOMPARE(accountSet(QMailAccountKey::customField("answer", "Fi", Excludes)), accountSet() << accountId2 << accountId3 << accountId4);
     QCOMPARE(accountSet(~QMailAccountKey::customField("answer", "Fi", Excludes)), accountSet() << accountId1);
-    QCOMPARE(accountSet(QMailAccountKey::customField("answer", "assi", Excludes)), accountSet() << accountId1);
+    QCOMPARE(accountSet(QMailAccountKey::customField("answer", "assi", Excludes)), accountSet() << accountId1 << accountId3 << accountId4);
     QCOMPARE(accountSet(~QMailAccountKey::customField("answer", "assi", Excludes)), accountSet() << accountId2);
-    QCOMPARE(accountSet(QMailAccountKey::customField("answer", "bicycle", Excludes)), accountSet() << accountId1 << accountId2);
+    QCOMPARE(accountSet(QMailAccountKey::customField("answer", "bicycle", Excludes)), allAccounts);
     QCOMPARE(accountSet(~QMailAccountKey::customField("answer", "bicycle", Excludes)), noAccounts);
-    QCOMPARE(accountSet(QMailAccountKey::customField("answer", QString(""), Excludes)), noAccounts);
+    QCOMPARE(accountSet(QMailAccountKey::customField("answer", QString(""), Excludes)), accountSet() << accountId3 << accountId4);
     QCOMPARE(accountSet(~QMailAccountKey::customField("answer", QString(""), Excludes)), accountSet() << accountId1 << accountId2);
-    QCOMPARE(accountSet(QMailAccountKey::customField("answer", QString(), Excludes)), noAccounts);
+    QCOMPARE(accountSet(QMailAccountKey::customField("answer", QString(), Excludes)), accountSet() << accountId3 << accountId4);
     QCOMPARE(accountSet(~QMailAccountKey::customField("answer", QString(), Excludes)), accountSet() << accountId1 << accountId2);
 
     // Test combinations
